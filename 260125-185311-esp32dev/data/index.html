<!DOCTYPE html><html lang="en" style="background:#0a0e1a;"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=5.0,user-scalable=yes"><meta name="theme-color" content="#0a0e1a"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Greenhouse"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üå±</text></svg>"><title>Greenhouse OS</title><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><style>html,body{background:#0a0e1a!important;}:root{--bg:#0a0e1a;--bg-gradient:linear-gradient(135deg,#0a0e1a 0%,#1a1f35 100%);--surface:#151b2e;--surface-elevated:#1f2739;--surface-glass:rgba(31,39,57,0.7);--primary:#4f7cff;--primary-light:#6b93ff;--primary-dark:#3a5fd9;--primary-gradient:linear-gradient(135deg,#4f7cff 0%,#7c3aed 100%);--success:#00d9a5;--success-gradient:linear-gradient(135deg,#00d9a5 0%,#00b386 100%);--danger:#ff4757;--danger-gradient:linear-gradient(135deg,#ff4757 0%,#d63447 100%);--warning:#ffa726;--warning-gradient:linear-gradient(135deg,#ffa726 0%,#fb8c00 100%);--text:#f8fafc;--text-secondary:#cbd5e1;--text-muted:#94a3b8;--text-disabled:#64748b;--border:rgba(148,163,184,0.12);--border-light:rgba(248,250,252,0.08);--shadow-sm:0 2px 8px rgba(0,0,0,0.15);--shadow-md:0 4px 16px rgba(0,0,0,0.25);--shadow-lg:0 8px 32px rgba(0,0,0,0.35);--shadow-glow:0 0 24px rgba(79,124,255,0.3);--glass-border:rgba(255,255,255,0.1);--glass-bg:rgba(255,255,255,0.05);--ease-smooth:cubic-bezier(0.4,0.0,0.2,1);--ease-bounce:cubic-bezier(0.68,-0.55,0.265,1.55);--ease-out:cubic-bezier(0.0,0.0,0.2,1);}*{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Inter","SF Pro Display",Helvetica,Arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-tap-highlight-color:transparent;touch-action:manipulation;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}html{overflow-x:hidden;width:100%;max-width:100vw;}body{background:var(--bg-gradient);background-attachment:fixed;color:var(--text);min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;overflow-y:auto;scroll-behavior:smooth;width:100%;max-width:100vw;position:relative;}body.fullscreen-map{overflow:hidden;}body.fullscreen-map.edit-mode{overflow-y:auto;}body.fullscreen-map nav{display:none;}body.fullscreen-map main{padding:0;max-width:none;display:block;}body.fullscreen-map .card.map-card{position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;border-radius:0;margin:0;}body.fullscreen-map.edit-mode .card.map-card{position:relative;height:auto;min-height:100vh;}body.fullscreen-map .card.map-card .card-header{display:none;}body.fullscreen-map .card.map-card .card-body{padding:0!important;}body.fullscreen-map.edit-mode .card.map-card .card-body{padding:10px 0 20px 0!important;}body.fullscreen-map .map-wrapper{margin:0!important;min-height:100vh!important;}body.fullscreen-map.edit-mode .map-wrapper{min-height:auto!important;padding-top:10px;}body.fullscreen-map .gh-map{width:94vw!important;height:85vh!important;max-width:94vw!important;max-height:85vh!important;min-height:85vh!important;border-radius:8px;margin:1vh 3vw 14vh 3vw!important;position:relative;}::-webkit-scrollbar{width:10px;}::-webkit-scrollbar-track{background:var(--surface);}::-webkit-scrollbar-thumb{background:var(--primary-gradient);border-radius:5px;}::-webkit-scrollbar-thumb:hover{background:var(--primary);}.flex-col{display:flex;flex-direction:column;}.items-center{align-items:center;}.justify-between{justify-content:space-between;}.col-span-2{grid-column:span 2;}nav{background:var(--surface-glass);backdrop-filter:blur(20px)saturate(180%);-webkit-backdrop-filter:blur(20px)saturate(180%);border-bottom:1px solid var(--glass-border);padding:0.875rem 1.25rem;position:sticky;top:0;z-index:10000;display:flex;justify-content:space-between;align-items:center;height:64px;box-shadow:var(--shadow-sm);transition:all 0.3s var(--ease-smooth);-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}@media(max-width:768px){nav{padding:0.5rem 0.75rem;height:56px;}}nav:hover{box-shadow:var(--shadow-md);}.brand{font-size:1.25rem;font-weight:700;background:var(--success-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-transform:uppercase;letter-spacing:0.075em;display:flex;align-items:center;transition:transform 0.3s var(--ease-smooth);justify-self:start;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}@media(max-width:768px){.brand{font-size:1rem;}}.brand:hover{transform:scale(1.05);}.btn-routines{background:var(--primary-gradient);border:none;color:white;font-size:0.9rem;font-weight:600;cursor:pointer;padding:0.5rem 1.25rem;border-radius:12px;transition:all 0.2s var(--ease-smooth);display:flex;align-items:center;gap:0.5rem;justify-self:center;box-shadow:var(--shadow-sm);min-height:44px;white-space:nowrap;}.btn-routines:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);}.btn-routines:active{transform:translateY(0);}.btn-routines svg{width:20px;height:20px;animation:rotate 8s linear infinite;}@keyframes rotate{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}@media(max-width:768px){.btn-routines{padding:0.4rem 0.8rem;font-size:0.8rem;gap:0.35rem;}.btn-routines-text{display:none;}.btn-routines svg{width:24px;height:24px;}}.nav-right{display:flex;align-items:center;gap:1rem;justify-self:end;}@media(max-width:768px){.nav-right{gap:0.5rem;}}.nav-location{font-size:0.85rem;color:var(--text-muted);white-space:nowrap;display:none;}@media(min-width:400px){.nav-location{display:block;}}.wifi-bars{display:flex;align-items:flex-end;gap:2px;height:16px;cursor:help;}.wifi-bar{width:3px;background:var(--text-muted);border-radius:1px;transition:all 0.3s var(--ease-smooth);opacity:0.3;}.wifi-bar.active{opacity:1;}.wifi-bar:nth-child(1){height:25%;}.wifi-bar:nth-child(2){height:50%;}.wifi-bar:nth-child(3){height:75%;}.wifi-bar:nth-child(4){height:100%;}.wifi-bars{display:flex;align-items:flex-end;gap:2px;height:16px;cursor:help;}.wifi-bar{width:3px;background:var(--text-muted);border-radius:1px;transition:all 0.3s var(--ease-smooth);opacity:0.3;}.wifi-bar.active{opacity:1;}.wifi-bar:nth-child(1){height:25%;}.wifi-bar:nth-child(2){height:50%;}.wifi-bar:nth-child(3){height:75%;}.wifi-bar:nth-child(4){height:100%;}.status-dot{width:10px;height:10px;border-radius:50%;background-color:var(--text-muted);margin-right:8px;box-shadow:0 0 8px rgba(0,0,0,0.5);transition:all 0.4s var(--ease-smooth);animation:pulseSubtle 2s infinite;}@keyframes pulseSubtle{0%,100%{transform:scale(1);opacity:1;}50%{transform:scale(1.1);opacity:0.8;}}.status-online{background:var(--success-gradient);box-shadow:0 0 12px var(--success),0 0 24px rgba(0,217,165,0.3);}.status-offline{background:var(--danger-gradient);box-shadow:0 0 12px var(--danger),0 0 24px rgba(255,71,87,0.3);animation:pulseError 1.5s infinite;}@keyframes pulseError{0%,100%{opacity:1;}50%{opacity:0.6;}}main{padding:1.5rem 1rem;max-width:1200px;margin:0 auto;width:100%;display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;overflow-x:hidden;flex:1;box-sizing:border-box;}.col-span-full{grid-column:1/-1;}@media(max-width:768px){main{grid-template-columns:1fr;padding:0.75rem;gap:0.75rem;width:100%;max-width:100vw;}}.card{background:var(--surface-glass);backdrop-filter:blur(20px)saturate(180%);-webkit-backdrop-filter:blur(20px)saturate(180%);border:1px solid var(--glass-border);border-radius:20px;overflow:hidden;box-shadow:var(--shadow-md);transition:all 0.3s var(--ease-smooth);position:relative;width:100%;max-width:100%;}.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.15),transparent);}@media(max-width:768px){.card{border-radius:16px;}.card:hover{transform:none;}}.card:hover{transform:translateY(-4px);box-shadow:var(--shadow-lg),var(--shadow-glow);border-color:rgba(79,124,255,0.25);}.card-header{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border-light);font-weight:600;font-size:1.125rem;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(79,124,255,0.08),rgba(124,58,237,0.08));letter-spacing:0.02em;}@media(max-width:768px){.card-header{padding:1rem 1.125rem;font-size:1rem;}}.card-sub-header{font-size:0.875rem;color:var(--text-muted);font-weight:400;margin-top:0.25rem;}.card-body{padding:1.5rem;}@media(max-width:768px){.card-body{padding:0.5rem;}}.map-card .card-body{padding:0.5rem;}@media(max-width:768px){.map-card .card-body{padding:0.25rem;}}.env-display{display:flex;justify-content:space-between;gap:1.5rem;flex-wrap:wrap;}@media(max-width:768px){.env-display{gap:1rem;}}.metric-value{font-size:2.75rem;font-weight:700;background:var(--primary-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1;letter-spacing:-0.02em;font-variant-numeric:tabular-nums;}@media(max-width:768px){.metric-value{font-size:2.25rem;}}.metric-label{font-size:0.875rem;color:var(--text-muted);margin-top:0.5rem;font-weight:500;letter-spacing:0.025em;text-transform:uppercase;}.btn{padding:0.875rem 1.75rem;border-radius:12px;font-weight:600;font-size:1rem;cursor:pointer;border:none;transition:all 0.3s var(--ease-smooth);width:100%;position:relative;overflow:hidden;letter-spacing:0.025em;min-height:44px;}@media(max-width:768px){.btn{padding:0.75rem 1.25rem;font-size:0.9375rem;}}.btn::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(255,255,255,0.2);transform:translate(-50%,-50%);transition:width 0.6s,height 0.6s;}.btn:active::before{width:300px;height:300px;}.btn-primary{background:var(--primary-gradient);color:white;box-shadow:var(--shadow-md);}.btn-primary:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg),var(--shadow-glow);}.btn-primary:active{transform:translateY(0);}.btn-icon{background:none;border:none;font-size:1.5rem;cursor:pointer;padding:0.5rem;color:var(--text);transition:all 0.2s;border-radius:8px;min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;}.btn-icon:hover{background:rgba(255,255,255,0.1);transform:scale(1.1);}.btn-icon:active{transform:scale(0.95);}.toggle-switch{position:relative;display:inline-block;width:52px;height:28px;min-width:52px;min-height:28px;}.toggle-switch input{opacity:0;width:0;height:0;}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--surface-elevated);border:2px solid var(--border);transition:all 0.4s var(--ease-smooth);border-radius:28px;}.slider:before{content:"";position:absolute;height:20px;width:20px;left:3px;bottom:2px;background:var(--text-muted);transition:all 0.4s var(--ease-bounce);border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.2);}input:checked+.slider{background:var(--primary-gradient);border-color:var(--primary);box-shadow:0 0 12px rgba(79,124,255,0.4);}input:checked+.slider:before{transform:translateX(24px);background:white;box-shadow:0 2px 8px rgba(0,0,0,0.3);}.palette-container{display:flex;gap:12px;padding:12px;overflow-x:auto;overflow-y:visible;max-height:120px;background:var(--surface-glass);backdrop-filter:blur(10px);border-radius:16px;margin-bottom:1rem;border:1px solid var(--glass-border);-webkit-overflow-scrolling:touch;scroll-behavior:smooth;scrollbar-width:thin;}@media(max-width:768px){.palette-container{gap:10px;padding:10px;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;scrollbar-width:thin;scrollbar-color:var(--primary)rgba(255,255,255,0.1);}.palette-container::-webkit-scrollbar{height:6px;}.palette-container::-webkit-scrollbar-track{background:rgba(255,255,255,0.1);border-radius:3px;}.palette-container::-webkit-scrollbar-thumb{background:var(--primary);border-radius:3px;}}.palette-item{min-width:68px;height:68px;flex-shrink:0;background:var(--surface-elevated);border:2px solid var(--border);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:move;user-select:none;touch-action:pan-x;transition:all 0.3s var(--ease-smooth);box-shadow:var(--shadow-sm);}@media(max-width:768px){.palette-item{min-width:72px;height:72px;}}.palette-item:hover{transform:translateY(-4px)scale(1.05);box-shadow:var(--shadow-md);border-color:var(--primary);}.palette-item:active{cursor:grabbing;transform:scale(0.95);}.palette-icon{font-size:1.75rem;}.palette-label{font-size:0.65rem;color:var(--text-muted);margin-top:4px;}.gh-map{width:100%;height:clamp(500px,70vh,900px);background:linear-gradient(135deg,rgba(30,41,59,0.8),rgba(15,23,42,0.9));backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:2px solid var(--glass-border);border-radius:20px;position:relative;background-image:linear-gradient(rgba(79,124,255,0.05)1px,transparent 1px),linear-gradient(90deg,rgba(79,124,255,0.05)1px,transparent 1px);background-size:24px 24px;transition:all 0.3s var(--ease-smooth);overflow:hidden;touch-action:auto;box-shadow:var(--shadow-md),inset 0 1px 0 rgba(255,255,255,0.1);box-sizing:border-box;}@supports not(backdrop-filter:blur(10px)){.gh-map{background:rgba(30,41,59,0.95);}}.gh-map.edit-mode{touch-action:none;cursor:grab;}.gh-map:hover{border-color:rgba(79,124,255,0.3);}@media(max-width:768px){.gh-map{width:90vw;height:65vh;max-width:90vw;max-height:65vh;min-height:400px;margin:5px auto;background-size:16px 16px;border-radius:16px;overflow:hidden;}.gh-map.edit-mode{touch-action:none;}.map-device{width:48px;height:48px;margin-left:-24px;margin-top:-24px;font-size:1.5rem;border-width:2px;}.temp-label{font-size:0.7rem;padding:3px 6px;transform:translateX(-50%);}}@media(max-width:480px){.gh-map{height:70vh;max-height:70vh;}}.map-device{position:absolute;width:56px;height:56px;margin-left:-28px;margin-top:-28px;border-radius:50%;background:var(--surface-glass);-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.75rem;cursor:pointer;box-shadow:var(--shadow-md);-webkit-transition:all 0.3s var(--ease-smooth);transition:all 0.3s var(--ease-smooth);user-select:none;-webkit-user-select:none;z-index:5;touch-action:none;-webkit-transform:rotate(0deg);transform:rotate(0deg);-webkit-transform-style:preserve-3d;transform-style:preserve-3d;will-change:transform;}@supports not(backdrop-filter:blur(10px)){.map-device{background:rgba(31,39,57,0.95);}}.map-device.dragging{-webkit-transition:none!important;transition:none!important;opacity:0.85;box-shadow:0 8px 24px rgba(0,0,0,0.4);z-index:100!important;cursor:grabbing;}.temp-label{position:absolute;top:-28px;left:50%;-webkit-transform:translateX(-50%);transform:translateX(-50%);background:rgba(0,0,0,0.85);-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);color:#fff;padding:3px 8px;border-radius:8px;font-size:0.75rem;font-weight:600;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,0.3);pointer-events:none;z-index:20;font-family:'Segoe UI',system-ui,sans-serif;}.map-device:hover{-webkit-transform:scale(1.1);transform:scale(1.1);box-shadow:var(--shadow-lg);z-index:15;}.map-device.active{background:var(--primary-gradient);box-shadow:0 0 24px var(--primary),0 0 48px rgba(79,124,255,0.4);border-color:var(--primary-light);color:white;z-index:10;-webkit-animation:pulseGlow 2.5s ease-in-out infinite;animation:pulseGlow 2.5s ease-in-out infinite;}@-webkit-keyframes pulseGlow{0%,100%{box-shadow:0 0 20px var(--primary),0 0 40px rgba(79,124,255,0.3);-webkit-transform:scale(1);transform:scale(1);}50%{box-shadow:0 0 32px var(--primary),0 0 64px rgba(79,124,255,0.5);-webkit-transform:scale(1.05);transform:scale(1.05);}}@keyframes pulseGlow{0%,100%{box-shadow:0 0 20px var(--primary),0 0 40px rgba(79,124,255,0.3);-webkit-transform:scale(1);transform:scale(1);}50%{box-shadow:0 0 32px var(--primary),0 0 64px rgba(79,124,255,0.5);-webkit-transform:scale(1.05);transform:scale(1.05);}}@-webkit-keyframes fireFlicker{0%,100%{box-shadow:0 0 20px rgba(255,100,0,0.8),0 0 40px rgba(255,50,0,0.4);background:linear-gradient(135deg,rgba(255,100,0,0.3),rgba(255,200,0,0.3));-webkit-transform:scale(1);transform:scale(1);}25%{box-shadow:0 0 28px rgba(255,150,0,0.9),0 0 50px rgba(255,80,0,0.5);background:linear-gradient(135deg,rgba(255,150,0,0.4),rgba(255,220,0,0.4));-webkit-transform:scale(1.05)rotate(2deg);transform:scale(1.05)rotate(2deg);}50%{box-shadow:0 0 24px rgba(255,120,0,0.85),0 0 45px rgba(255,60,0,0.45);background:linear-gradient(135deg,rgba(255,120,0,0.35),rgba(255,210,0,0.35));-webkit-transform:scale(1.02)rotate(-1deg);transform:scale(1.02)rotate(-1deg);}75%{box-shadow:0 0 30px rgba(255,140,0,0.95),0 0 55px rgba(255,70,0,0.5);background:linear-gradient(135deg,rgba(255,140,0,0.4),rgba(255,230,0,0.4));-webkit-transform:scale(1.08)rotate(1deg);transform:scale(1.08)rotate(1deg);}}@keyframes fireFlicker{0%,100%{box-shadow:0 0 20px rgba(255,100,0,0.8),0 0 40px rgba(255,50,0,0.4);background:linear-gradient(135deg,rgba(255,100,0,0.3),rgba(255,200,0,0.3));-webkit-transform:scale(1);transform:scale(1);}25%{box-shadow:0 0 28px rgba(255,150,0,0.9),0 0 50px rgba(255,80,0,0.5);background:linear-gradient(135deg,rgba(255,150,0,0.4),rgba(255,220,0,0.4));-webkit-transform:scale(1.05)rotate(2deg);transform:scale(1.05)rotate(2deg);}50%{box-shadow:0 0 24px rgba(255,120,0,0.85),0 0 45px rgba(255,60,0,0.45);background:linear-gradient(135deg,rgba(255,120,0,0.35),rgba(255,210,0,0.35));-webkit-transform:scale(1.02)rotate(-1deg);transform:scale(1.02)rotate(-1deg);}75%{box-shadow:0 0 30px rgba(255,140,0,0.95),0 0 55px rgba(255,70,0,0.5);background:linear-gradient(135deg,rgba(255,140,0,0.4),rgba(255,230,0,0.4));-webkit-transform:scale(1.08)rotate(1deg);transform:scale(1.08)rotate(1deg);}}@keyframes pulsateOrange{0%,100%{box-shadow:0 0 18px rgba(255,140,0,0.7),0 0 36px rgba(255,100,0,0.3);background:radial-gradient(circle,rgba(255,140,0,0.25),rgba(255,100,0,0.15));}50%{box-shadow:0 0 28px rgba(255,140,0,0.9),0 0 50px rgba(255,100,0,0.5);background:radial-gradient(circle,rgba(255,140,0,0.35),rgba(255,100,0,0.25));}}@keyframes pulsateBlue{0%,100%{box-shadow:0 0 18px rgba(100,200,255,0.7),0 0 36px rgba(50,150,255,0.3);background:radial-gradient(circle,rgba(100,200,255,0.25),rgba(50,150,255,0.15));}50%{box-shadow:0 0 28px rgba(100,200,255,0.9),0 0 50px rgba(50,150,255,0.5);background:radial-gradient(circle,rgba(100,200,255,0.35),rgba(50,150,255,0.25));}}@-webkit-keyframes pulsateBrown{0%,100%{box-shadow:0 0 16px rgba(180,140,100,0.6),0 0 32px rgba(160,120,80,0.3);background:radial-gradient(circle,rgba(180,140,100,0.2),rgba(160,120,80,0.1));-webkit-transform:scale(1);transform:scale(1);}50%{box-shadow:0 0 24px rgba(180,140,100,0.8),0 0 44px rgba(160,120,80,0.4);background:radial-gradient(circle,rgba(180,140,100,0.3),rgba(160,120,80,0.2));-webkit-transform:scale(1.06);transform:scale(1.06);}}@keyframes pulsateBrown{0%,100%{box-shadow:0 0 16px rgba(180,140,100,0.6),0 0 32px rgba(160,120,80,0.3);background:radial-gradient(circle,rgba(180,140,100,0.2),rgba(160,120,80,0.1));-webkit-transform:scale(1);transform:scale(1);}50%{box-shadow:0 0 24px rgba(180,140,100,0.8),0 0 44px rgba(160,120,80,0.4);background:radial-gradient(circle,rgba(180,140,100,0.3),rgba(160,120,80,0.2));-webkit-transform:scale(1.06);transform:scale(1.06);}}@-webkit-keyframes rotateFan{from{-webkit-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(360deg);transform:rotate(360deg);}}@keyframes rotateFan{from{-webkit-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(360deg);transform:rotate(360deg);}}@-webkit-keyframes rotateFanOrange{0%,100%{box-shadow:0 0 18px rgba(255,140,0,0.7),0 0 36px rgba(255,100,0,0.3);background:radial-gradient(circle,rgba(255,140,0,0.25),rgba(255,100,0,0.15));-webkit-transform:rotate(0deg);transform:rotate(0deg);}50%{box-shadow:0 0 28px rgba(255,140,0,0.9),0 0 50px rgba(255,100,0,0.5);background:radial-gradient(circle,rgba(255,140,0,0.35),rgba(255,100,0,0.25));-webkit-transform:rotate(180deg);transform:rotate(180deg);}100%{box-shadow:0 0 18px rgba(255,140,0,0.7),0 0 36px rgba(255,100,0,0.3);background:radial-gradient(circle,rgba(255,140,0,0.25),rgba(255,100,0,0.15));-webkit-transform:rotate(360deg);transform:rotate(360deg);}}@keyframes rotateFanOrange{0%,100%{box-shadow:0 0 18px rgba(255,140,0,0.7),0 0 36px rgba(255,100,0,0.3);background:radial-gradient(circle,rgba(255,140,0,0.25),rgba(255,100,0,0.15));-webkit-transform:rotate(0deg);transform:rotate(0deg);}50%{box-shadow:0 0 28px rgba(255,140,0,0.9),0 0 50px rgba(255,100,0,0.5);background:radial-gradient(circle,rgba(255,140,0,0.35),rgba(255,100,0,0.25));-webkit-transform:rotate(180deg);transform:rotate(180deg);}100%{box-shadow:0 0 18px rgba(255,140,0,0.7),0 0 36px rgba(255,100,0,0.3);background:radial-gradient(circle,rgba(255,140,0,0.25),rgba(255,100,0,0.15));-webkit-transform:rotate(360deg);transform:rotate(360deg);}}@-webkit-keyframes rotateFanBlue{0%,100%{box-shadow:0 0 18px rgba(100,200,255,0.7),0 0 36px rgba(50,150,255,0.3);background:radial-gradient(circle,rgba(100,200,255,0.25),rgba(50,150,255,0.15));-webkit-transform:rotate(0deg);transform:rotate(0deg);}50%{box-shadow:0 0 28px rgba(100,200,255,0.9),0 0 50px rgba(50,150,255,0.5);background:radial-gradient(circle,rgba(100,200,255,0.35),rgba(50,150,255,0.25));-webkit-transform:rotate(180deg);transform:rotate(180deg);}100%{box-shadow:0 0 18px rgba(100,200,255,0.7),0 0 36px rgba(50,150,255,0.3);background:radial-gradient(circle,rgba(100,200,255,0.25),rgba(50,150,255,0.15));-webkit-transform:rotate(360deg);transform:rotate(360deg);}}@keyframes rotateFanBlue{0%,100%{box-shadow:0 0 18px rgba(100,200,255,0.7),0 0 36px rgba(50,150,255,0.3);background:radial-gradient(circle,rgba(100,200,255,0.25),rgba(50,150,255,0.15));-webkit-transform:rotate(0deg);transform:rotate(0deg);}50%{box-shadow:0 0 28px rgba(100,200,255,0.9),0 0 50px rgba(50,150,255,0.5);background:radial-gradient(circle,rgba(100,200,255,0.35),rgba(50,150,255,0.25));-webkit-transform:rotate(180deg);transform:rotate(180deg);}100%{box-shadow:0 0 18px rgba(100,200,255,0.7),0 0 36px rgba(50,150,255,0.3);background:radial-gradient(circle,rgba(100,200,255,0.25),rgba(50,150,255,0.15));-webkit-transform:rotate(360deg);transform:rotate(360deg);}}.map-device.anim-fire{-webkit-animation:fireFlicker 1.2s ease-in-out infinite;animation:fireFlicker 1.2s ease-in-out infinite;border-color:rgba(255,100,0,0.6);}.map-device.anim-orange{-webkit-animation:rotateFanOrange 0.6s linear infinite;animation:rotateFanOrange 0.6s linear infinite;border-color:rgba(255,140,0,0.6);}.map-device.anim-blue{-webkit-animation:rotateFanBlue 0.6s linear infinite;animation:rotateFanBlue 0.6s linear infinite;border-color:rgba(100,200,255,0.6);}@-webkit-keyframes ventOpen{0%,100%{box-shadow:0 0 18px rgba(160,200,255,0.7),0 0 36px rgba(100,180,255,0.3);background:radial-gradient(circle,rgba(160,200,255,0.25),rgba(100,180,255,0.15));-webkit-transform:scaleY(1);transform:scaleY(1);}50%{box-shadow:0 0 28px rgba(160,200,255,0.9),0 0 50px rgba(100,180,255,0.5);background:radial-gradient(circle,rgba(160,200,255,0.35),rgba(100,180,255,0.25));-webkit-transform:scaleY(1.15);transform:scaleY(1.15);}}@keyframes ventOpen{0%,100%{box-shadow:0 0 18px rgba(160,200,255,0.7),0 0 36px rgba(100,180,255,0.3);background:radial-gradient(circle,rgba(160,200,255,0.25),rgba(100,180,255,0.15));-webkit-transform:scaleY(1);transform:scaleY(1);}50%{box-shadow:0 0 28px rgba(160,200,255,0.9),0 0 50px rgba(100,180,255,0.5);background:radial-gradient(circle,rgba(160,200,255,0.35),rgba(100,180,255,0.25));-webkit-transform:scaleY(1.15);transform:scaleY(1.15);}}.map-device.anim-vent{-webkit-animation:ventOpen 1.2s ease-in-out infinite;animation:ventOpen 1.2s ease-in-out infinite;border-color:rgba(160,200,255,0.6);}@-webkit-keyframes pulsateWhite{0%,100%{box-shadow:0 0 20px rgba(255,255,255,0.8),0 0 40px rgba(255,255,255,0.4);background:radial-gradient(circle,rgba(255,255,255,0.3),rgba(255,255,255,0.15));}50%{box-shadow:0 0 32px rgba(255,255,255,1),0 0 60px rgba(255,255,255,0.6);background:radial-gradient(circle,rgba(255,255,255,0.4),rgba(255,255,255,0.25));}}@keyframes pulsateWhite{0%,100%{box-shadow:0 0 20px rgba(255,255,255,0.8),0 0 40px rgba(255,255,255,0.4);background:radial-gradient(circle,rgba(255,255,255,0.3),rgba(255,255,255,0.15));}50%{box-shadow:0 0 32px rgba(255,255,255,1),0 0 60px rgba(255,255,255,0.6);background:radial-gradient(circle,rgba(255,255,255,0.4),rgba(255,255,255,0.25));}}.map-device.anim-white{-webkit-animation:pulsateWhite 1.5s ease-in-out infinite;animation:pulsateWhite 1.5s ease-in-out infinite;border-color:rgba(255,255,255,0.7);}.map-device.anim-brown{-webkit-animation:pulsateBrown 2s ease-in-out infinite;animation:pulsateBrown 2s ease-in-out infinite;border-color:rgba(180,140,100,0.6);}@keyframes faultPulse{0%,100%{box-shadow:0 0 8px rgba(255,71,87,0.6),0 0 16px rgba(255,71,87,0.3);border-color:rgba(255,71,87,0.8);}50%{box-shadow:0 0 20px rgba(255,71,87,0.9),0 0 40px rgba(255,71,87,0.5);border-color:rgba(255,71,87,1);}}.map-device.anim-fault{animation:faultPulse 0.8s ease-in-out infinite;background:linear-gradient(135deg,rgba(255,71,87,0.2),rgba(255,71,87,0.1));}.current-badge{position:absolute;bottom:-22px;left:50%;transform:translateX(-50%);background:rgba(0,217,165,0.9);color:#fff;padding:2px 6px;border-radius:6px;font-size:0.65rem;font-weight:600;white-space:nowrap;box-shadow:0 2px 6px rgba(0,0,0,0.3);pointer-events:none;z-index:20;}.current-badge.fault{background:rgba(255,71,87,0.9);}.power-btn-on{background:linear-gradient(135deg,#10b981,#059669)!important;box-shadow:0 0 20px rgba(16,185,129,0.6),0 4px 12px rgba(0,0,0,0.3)!important;color:white!important;}.power-btn-on:hover{background:linear-gradient(135deg,#059669,#047857)!important;box-shadow:0 0 28px rgba(16,185,129,0.8),0 6px 16px rgba(0,0,0,0.4)!important;}.state-badge{display:inline-block;padding:0.4rem 0.9rem;border-radius:8px;font-size:0.85rem;font-weight:600;margin-top:15px;text-transform:uppercase;letter-spacing:0.5px;}.state-on{background:rgba(16,185,129,0.2);color:#10b981;border:1px solid rgba(16,185,129,0.4);}.state-off{background:rgba(100,116,139,0.2);color:#94a3b8;border:1px solid rgba(100,116,139,0.4);}.state-enabled{background:rgba(59,130,246,0.2);color:#3b82f6;border:1px solid rgba(59,130,246,0.4);}.state-disabled{background:rgba(248,113,113,0.2);color:#f87171;border:1px solid rgba(248,113,113,0.4);}.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);z-index:100;display:none;justify-content:center;align-items:center;}.modal-overlay.open{display:flex;animation:modalFadeIn 0.3s;}.modal-box{background:var(--surface-glass);backdrop-filter:blur(24px)saturate(180%);width:100%;max-width:540px;height:85vh;max-height:85vh;border-radius:28px;padding:0;position:relative;display:flex;flex-direction:column;overflow-y:auto;overflow-x:hidden;box-shadow:0 12px 48px rgba(0,0,0,0.6);animation:modalSlideUp 0.4s var(--ease-smooth);border:1px solid var(--glass-border);}@media(max-width:768px){.modal-box{max-width:95vw;max-height:90vh;border-radius:20px;margin:0 10px;}}@keyframes modalFadeIn{from{opacity:0;}to{opacity:1;}}@keyframes modalSlideUp{from{opacity:0;transform:translateY(40px)scale(0.95);}to{opacity:1;transform:translateY(0)scale(1);}}.settings-page{position:absolute;top:0;left:0;width:100%;height:100%;overflow-y:auto;background:var(--bg);transition:transform 0.3s cubic-bezier(0.4,0.0,0.2,1);transform:translateX(100%);display:flex;flex-direction:column;}.settings-page.active{transform:translateX(0);z-index:10;}.settings-header{padding:24px 24px 16px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;gap:16px;background:linear-gradient(135deg,rgba(31,39,57,0.4),rgba(15,23,42,0.2));position:sticky;top:0;z-index:20;backdrop-filter:blur(10px);}.settings-header h2,.settings-header h3{margin:0;font-size:1.3rem;font-weight:700;letter-spacing:0.025em;background:var(--primary-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}.back-btn{background:rgba(79,124,255,0.1);border:1px solid rgba(79,124,255,0.2);color:var(--primary);font-size:1.25rem;cursor:pointer;padding:8px 10px;display:flex;align-items:center;justify-content:center;border-radius:10px;transition:all 0.2s;width:40px;height:40px;}.back-btn:hover{background:rgba(79,124,255,0.2);border-color:rgba(79,124,255,0.4);transform:translateX(-2px);}.settings-content{padding:24px;}.settings-list{display:flex;flex-direction:column;gap:12px;}.list-item{display:flex;align-items:center;gap:16px;padding:16px 18px;cursor:pointer;transition:all 0.3s var(--ease-smooth);border:1px solid var(--glass-border);border-radius:14px;position:relative;background:rgba(31,39,57,0.4);}.list-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:0;background:var(--primary-gradient);transition:width 0.3s var(--ease-smooth);border-radius:14px 0 0 14px;}.list-item:hover{transform:translateX(4px);background:rgba(79,124,255,0.08);border-color:rgba(79,124,255,0.25);box-shadow:var(--shadow-sm),-4px 0 0 0 rgba(79,124,255,0.1);}.list-item .icon{font-size:1.4rem;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:var(--primary-gradient);color:white;border-radius:12px;box-shadow:var(--shadow-sm);flex-shrink:0;}.list-item .text-col{flex:1;}.list-item .title{font-size:1rem;font-weight:600;display:block;letter-spacing:0.02em;}.list-item .subtitle{font-size:0.85rem;color:var(--text-muted);display:block;margin-top:4px;}.list-item .arrow{color:var(--text-muted);font-size:1.2rem;transition:all 0.3s;}.list-item:hover .arrow{color:var(--primary);transform:translateX(2px);}.form-group{margin-bottom:1.5rem;}.form-label{display:block;margin-bottom:0.75rem;color:var(--text);font-size:0.95rem;font-weight:600;letter-spacing:0.01em;text-transform:uppercase;}.form-input{width:100%;padding:12px 16px;background:rgba(31,39,57,0.6);border:1.5px solid var(--glass-border);border-radius:10px;color:var(--text);font-size:1rem;transition:all 0.2s;font-family:inherit;}.form-input:focus{outline:none;border-color:var(--primary);background:rgba(31,39,57,0.8);box-shadow:0 0 0 3px rgba(79,124,255,0.15);}.form-input::placeholder{color:var(--text-muted);}.map-device,.palette-item{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}.map-wrapper{position:relative;width:100%;}.map-device,.palette-item{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}.map-wrapper{position:relative;width:100%;display:flex;align-items:center;justify-content:center;overflow:visible;min-height:400px;}@media(max-width:768px){.map-wrapper{min-height:65vh;margin:5px 0;}}.sparkline-container{height:100px;width:100%;position:relative;}.settings-section{margin-bottom:24px;padding:20px;background:rgba(31,39,57,0.4);border:1px solid var(--glass-border);border-radius:16px;backdrop-filter:blur(10px);}.settings-section-title{font-size:1.1rem;font-weight:700;color:var(--text);margin-bottom:16px;display:flex;align-items:center;gap:8px;letter-spacing:0.02em;}.settings-section-subtitle{font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;line-height:1.5;}</style></head><body style="background:#0a0e1a;"><nav><div class="brand" onclick="window.location.href='/home.html'" title="Dashboard" style="cursor:pointer;">üå± Greenhouse OS</div><div class="nav-right"><div id="nav-wifi" class="wifi-bars" title="WiFi Signal Strength"><div class="wifi-bar"></div><div class="wifi-bar"></div><div class="wifi-bar"></div><div class="wifi-bar"></div></div><div class="flex flex-col" style="text-align:right;"><span id="clock" style="font-family:monospace;font-size:0.9rem;white-space:nowrap;">--:--</span><span class="nav-location" id="nav-location" style="font-size:0.75rem;opacity:0.8;">üìç--</span></div><div id="status-indicator" class="status-dot"></div><button onclick="toggleSettings()" class="btn-icon" title="Settings">‚öôÔ∏è</button></div></nav><main><div class="card col-span-full"><div class="card-header"><div><div>Temperature Trend</div><div class="card-sub-header">Last Hour</div></div></div><div class="card-body" onclick="openHistoryModal()" style="cursor:pointer;"><div class="sparkline-container"><canvas id="sparkChart"></canvas></div></div></div><div class="card"><div class="card-header"><div><div>Indoor</div><div class="card-sub-header">Greenhouse Sensors</div></div></div><div class="card-body"><div class="env-display"><div><div class="metric-value"><span id="temp-display">--</span><span id="temp-unit-display" style="font-size:1.5rem">¬∞C</span></div><div class="metric-label">Avg Temp</div></div><div><div class="metric-value" style="color:var(--success);-webkit-text-fill-color:initial;"><span id="power-display">--</span><span style="font-size:1.5rem">A</span></div><div class="metric-label">Power</div></div></div></div></div><div class="card" id="weather-card" style="background:linear-gradient(135deg,rgba(33,150,243,0.15)0%,rgba(3,169,244,0.08)100%);cursor:pointer;" onclick="toggleWeatherExpand()"><div style="padding:1rem 1.25rem;"><div style="display:flex;align-items:flex-start;justify-content:space-between;"><div style="flex:1;"><div style="display:flex;align-items:baseline;gap:0.25rem;"><span id="out-temp" style="font-size:3.5rem;font-weight:300;line-height:1;">--</span><span id="weather-icon" style="font-size:2.5rem;margin-left:0.5rem;">üå§Ô∏è</span></div><div id="weather-loc" style="font-size:0.85rem;margin-top:0.5rem;color:var(--text-muted);">üìç Loading...</div><div id="out-desc" style="font-size:1rem;font-weight:500;margin-top:0.25rem;">--</div></div><div style="text-align:right;"><button onclick="refreshWeather(event)" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;padding:6px 10px;color:var(--text);cursor:pointer;font-size:0.8rem;margin-bottom:8px;pointer-events:all;" title="Refresh Weather" onmousedown="event.stopPropagation()">üîÑ</button><div id="weather-expand-arrow" style="font-size:1.5rem;transition:transform 0.3s ease;text-align:center;">‚ñº</div></div></div><div id="weather-expanded" style="display:none;margin-top:1rem;"><div style="display:flex;gap:0.5rem;margin-bottom:0.75rem;font-size:0.85rem;color:var(--text-muted);"><span>H:<span id="out-max">--</span>¬∞</span><span>L:<span id="out-min">--</span>¬∞</span><span>Feels:<span id="out-feels" style="color:var(--text);">--¬∞</span></span></div><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:0.5rem;margin-bottom:0.75rem;font-size:0.8rem;"><div style="padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:6px;"><div style="color:var(--text-muted);">üíß</div><div id="out-humi">--</div></div><div style="padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:6px;"><div style="color:var(--text-muted);">üí®</div><div id="out-wind">--</div></div><div style="padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:6px;"><div style="color:var(--text-muted);">üå°Ô∏è</div><div id="out-pressure">--</div></div><div style="padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:6px;"><div style="color:var(--text-muted);">‚òÅÔ∏è</div><div id="out-cloud">--</div></div><div style="padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:6px;"><div style="color:var(--text-muted);">üëÅÔ∏è</div><div id="out-visibility">--</div></div><div style="padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:6px;"><div style="color:var(--text-muted);">‚òÄÔ∏è</div><div id="out-uv">--</div></div><div style="padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:6px;"><div style="color:var(--text-muted);">üß≠</div><div id="out-wind-dir">--</div></div></div><div id="hourly-forecast" style="display:flex;gap:0.5rem;overflow-x:auto;padding-bottom:0.5rem;"></div></div></div></div><div class="card col-span-full map-card"><div class="card-header" style="display:flex;align-items:center;justify-content:space-between;"><span>Greenhouse Floorplan</span><button onclick="window.location.href='/routines.html'" title="Automation Routines" class="btn-routines" style="padding:0.4rem 0.8rem;font-size:0.85rem;position:relative;z-index:100;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/><circle cx="12" cy="12" r="3"/></svg><span class="btn-routines-text">Routines</span></button><div class="flex items-center gap-2" style="gap:0.75rem;display:flex;align-items:center;"><span id="save-indicator" style="font-size:0.8rem;color:var(--success);opacity:0;transition:opacity 0.5s;">Saved ‚úî</span><label class="toggle-switch"><input type="checkbox" id="edit-mode-toggle" onchange="toggleEditMode()"><span class="slider"></span></label><span style="font-size:0.8rem;">Edit</span></div></div><div class="card-body" style="padding:10px;position:relative;overflow:visible;"><div id="palette" class="palette-container" style="display:none;"><div class="palette-item" draggable="true" ondragstart="dragStartNew(event,'heater')"><span class="palette-icon">üî•</span><span class="palette-label">Heater</span></div><div class="palette-item" draggable="true" ondragstart="dragStartNew(event,'fan_circ')"><span class="palette-icon">üåÄ</span><span class="palette-label">Circ Fan</span></div><div class="palette-item" draggable="true" ondragstart="dragStartNew(event,'fan_cool')"><span class="palette-icon">‚ùÑÔ∏è</span><span class="palette-label">Cool Fan</span></div><div class="palette-item" draggable="true" ondragstart="dragStartNew(event,'vent')"><span class="palette-icon">ü™ü</span><span class="palette-label">Vent</span></div><div class="palette-item" draggable="true" ondragstart="dragStartNew(event,'light')"><span class="palette-icon">üí°</span><span class="palette-label">Light</span></div><div class="palette-item" draggable="true" ondragstart="dragStartNew(event,'sensor')"><span class="palette-icon">üå°Ô∏è</span><span class="palette-label">Sensor</span></div><div class="palette-item" draggable="true" ondragstart="dragStartNew(event,'blower')"><span class="palette-icon">üå™Ô∏è</span><span class="palette-label">Blower</span></div><div class="palette-item" draggable="true" ondragstart="dragStartNew(event,'camera')"><span class="palette-icon">üì∑</span><span class="palette-label">Camera</span></div></div><div class="map-wrapper"><div id="gh-map" class="gh-map" ondrop="dropNew(event)" ondragover="allowDrop(event)" ondblclick="toggleFullscreen()"></div></div></div></div></main><div id="device-config-modal" class="modal-overlay"><div class="modal-box"><div class="settings-header"><h3>Device Configuration</h3><button class="back-btn" onclick="closeDeviceConfig()">√ó</button></div><div class="settings-content"><input type="hidden" id="dev-cfg-id"><div class="form-group"><label class="form-label">Device Name</label><input type="text" id="dev-cfg-name" class="form-input" placeholder="My Device"></div><div class="form-group"><label class="form-label">Device Type(Virtual)</label><input type="text" id="dev-cfg-type" class="form-input" disabled style="opacity:0.6;"></div><div class="form-group"><label class="form-label">Icon Rotation</label><div style="display:flex;align-items:center;gap:10px;"><button type="button" onclick="adjustRotation(-15)" class="btn" style="padding:0.5rem 1rem;min-width:50px;">‚Ü∂-15¬∞</button><input type="number" id="dev-cfg-rotation" class="form-input" value="0" min="-180" max="180" step="15" style="text-align:center;flex:1;" oninput="updateRotationPreview()"><button type="button" onclick="adjustRotation(15)" class="btn" style="padding:0.5rem 1rem;min-width:50px;">‚Ü∑+15¬∞</button></div><div style="font-size:0.75rem;color:var(--text-muted);margin-top:8px;">Rotate icon in 15¬∞ increments(0¬∞ to 360¬∞)</div></div><div class="form-group"><label class="form-label">Device Status</label><div style="display:flex;gap:1rem;margin-top:0.5rem;"><label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="dev-enabled" id="dev-cfg-enabled" value="1" checked style="margin-right:0.5rem;"><span>‚úì Enabled</span></label><label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="dev-enabled" id="dev-cfg-disabled" value="0" style="margin-right:0.5rem;"><span>‚úó Disabled</span></label></div><div style="font-size:0.75rem;color:var(--text-muted);margin-top:8px;">Disabled devices won't respond to automation or manual control</div></div><div class="form-group"><label class="form-label">Physical Hardware Type</label><select id="dev-cfg-phys-type" class="form-input" onchange="updatePhysicalFields()"><option value="0">None(Virtual Only)</option><option value="1">Relay(15-Channel Board)</option><option value="2">DHT22(Temp&Humidity)</option><option value="3">DS18B20(Temperature)</option><option value="4">IP Camera(RTSP/HTTP)</option><option value="5">ESP32-CAM</option></select></div><div class="form-group" id="relay-channel-group" style="display:none;"><label class="form-label">Relay Channel</label><select id="dev-cfg-channel" class="form-input"><option value="0">Select Channel...</option><option value="1">Channel 1</option><option value="2">Channel 2</option><option value="3">Channel 3</option><option value="4">Channel 4</option><option value="5">Channel 5</option><option value="6">Channel 6</option><option value="7">Channel 7</option><option value="8">Channel 8</option><option value="9">Channel 9</option><option value="10">Channel 10</option><option value="11">Channel 11</option><option value="12">Channel 12</option><option value="13">Channel 13</option><option value="14">Channel 14</option><option value="15">Channel 15</option></select></div><div class="form-group" id="sensor-pin-group" style="display:none;"><label class="form-label">GPIO Pin</label><input type="number" id="dev-cfg-pin" class="form-input" placeholder="e.g.,4,5,16"><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">GPIO pin connected to sensor data line</div></div><div class="form-group" id="sensor-addr-group" style="display:none;"><label class="form-label">OneWire Address</label><input type="text" id="dev-cfg-addr" class="form-input" placeholder="28:AA:BB:CC:DD:EE:FF:00"><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">DS18B20 unique 64-bit address(optional if only one sensor)</div></div><div class="form-group" id="camera-url-group" style="display:none;"><label class="form-label">Camera URL/IP</label><input type="text" id="dev-cfg-url" class="form-input" placeholder="rtsp://192.168.1.100:554/stream"><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">RTSP stream or HTTP snapshot URL</div></div><div style="background:rgba(79,124,255,0.1);padding:12px;border-radius:8px;margin:16px 0;border:1px solid rgba(79,124,255,0.3);"><div style="font-size:0.85rem;color:var(--text-secondary);"><strong>‚ÑπÔ∏è Physical Hardware Status:</strong><br>Sensor and camera hardware will be added in future firmware updates. Configuration is saved and ready for when hardware is installed.</div></div><div style="display:flex;gap:10px;margin-top:20px;"><button class="btn" style="background:var(--danger);flex:1;" onclick="deleteCurrentDevice()">Delete</button><button class="btn btn-primary" style="flex:2;" onclick="saveDeviceConfig()">Save Config</button></div></div></div></div><div id="settings-modal" class="modal-overlay"><div class="modal-box"><div id="page-home" class="settings-page active"><div class="settings-header"><h2>Settings</h2></div><div class="settings-list"><div class="list-item" onclick="nav('wifi')"><div class="icon">üì∂</div><div class="text-col"><span class="title">Network&Internet</span><span class="subtitle" id="home-net-sub">Disconnected</span></div><span class="arrow">‚Ä∫</span></div><div class="list-item" onclick="nav('gh')"><div class="icon">üåø</div><div class="text-col"><span class="title">Greenhouse Config</span><span class="subtitle">Location&Weather</span></div><span class="arrow">‚Ä∫</span></div><div class="list-item" onclick="nav('time')"><div class="icon">üïí</div><div class="text-col"><span class="title">Date&Time</span><span class="subtitle" id="home-time-sub">Auto-NTP</span></div><span class="arrow">‚Ä∫</span></div><div class="list-item" onclick="nav('ota')"><div class="icon">üîÑ</div><div class="text-col"><span class="title">Firmware Update(OTA)</span><span class="subtitle">Update system remotely</span></div><span class="arrow">‚Ä∫</span></div><div class="list-item" onclick="window.location.href='/alerts.html'"><div class="icon">üì±</div><div class="text-col"><span class="title">Alerts & Notifications</span><span class="subtitle">WhatsApp alerts config</span></div><span class="arrow">‚Ä∫</span></div><div class="list-item" onclick="window.open('/README.html','_blank')"><div class="icon">‚ÑπÔ∏è</div><div class="text-col"><span class="title">About & Documentation</span><span class="subtitle">System setup & help</span></div><span class="arrow">‚Ä∫</span></div><div style="padding:20px;"><button class="btn" style="background:var(--success);margin-bottom:10px;" onclick="downloadLayout()">üíæ Backup Icon Layout</button><input type="file" id="restore-file" accept=".json" style="display:none;" onchange="restoreLayout(event)"><button class="btn" style="background:var(--primary);margin-bottom:10px;" onclick="document.getElementById('restore-file').click()">üìÇ Restore from Backup</button><button class="btn btn-primary" onclick="syncLocation()">üìç Sync Location from Phone</button><button class="btn" style="background:var(--border);margin-top:10px;" onclick="toggleSettings()">Close Settings</button></div></div></div><div id="page-wifi" class="settings-page"><div class="settings-header"><button class="back-btn" onclick="nav('home')">‚Üê</button><h3>Network & Internet</h3></div><div class="settings-content"><div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:12px;padding:16px;margin-bottom:24px;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><span style="font-weight:600;font-size:1.1rem;">Connected Network</span><span id="net-badge" style="background:var(--danger);padding:4px 10px;border-radius:6px;font-size:0.75rem;font-weight:600;">Offline</span></div><div style="font-size:1.3rem;font-weight:300;margin-bottom:12px;" id="net-ssid">--</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;font-size:0.85rem;color:var(--text-muted);"><div><span style="display:block;font-size:0.7rem;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px;">IP Address</span><span id="net-ip" style="color:var(--text);font-weight:600;">--</span></div><div><span style="display:block;font-size:0.7rem;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px;">Signal</span><span id="net-rssi" style="color:var(--text);font-weight:600;">--</span></div></div></div><div class="settings-section"><div class="settings-section-title">üì∂ Available Networks</div><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"><label class="form-label" style="margin:0;flex:1;">Scan for networks</label><button class="btn" style="width:auto;padding:0.5rem 1.2rem;font-size:0.85rem;background:var(--primary);color:white;border:none;" onclick="scanWifi()">‚Üª Scan</button></div><div id="wifi-list" style="max-height:280px;overflow-y:auto;border:1px solid var(--glass-border);border-radius:8px;background:rgba(31,39,57,0.4);"><div style="padding:20px;text-align:center;color:var(--text-muted);">Tap Scan to search for networks</div></div></div><div class="settings-section"><div class="settings-section-title">üîê Connect to WiFi</div><div class="form-group"><label class="form-label">Network Name (SSID)</label><input type="text" id="cfg-ssid" class="form-input" placeholder="Your WiFi name"></div><div class="form-group"><label class="form-label">Password</label><input type="password" id="cfg-pass" class="form-input" placeholder="Your WiFi password"></div><button class="btn btn-primary" onclick="saveConfig()" style="width:100%;">Connect & Save</button></div></div></div><div id="page-time" class="settings-page"><div class="settings-header"><button class="back-btn" onclick="nav('home')">‚Üê</button><h3>Date & Time</h3></div><div class="settings-content"><div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:12px;padding:16px;margin-bottom:24px;"><div style="font-weight:600;font-size:1.1rem;margin-bottom:8px;">üïí System Time</div><div id="sys-time-display" style="font-size:2rem;font-family:monospace;margin-bottom:8px;color:var(--primary);">--:--:--</div><div id="sys-time-status" style="font-size:0.85rem;color:var(--text-muted);">Waiting for sync...</div></div><div class="settings-section"><div class="settings-section-title">‚è∞ Time Settings</div><div class="form-group"><label class="form-label">Time Format</label><select id="cfg-timefmt" class="form-input" onchange="updateClockFormat()"><option value="24">24-Hour (14:30)</option><option value="12">12-Hour (2:30 PM)</option></select></div><div class="form-group"><label class="form-label">NTP Server</label><input type="text" id="cfg-ntp" class="form-input" placeholder="pool.ntp.org"><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Network Time Protocol server for auto-sync</div></div><div class="form-group"><button class="btn" style="background:var(--primary);color:white;width:100%;" onclick="syncBrowserTime(true)">üì± Sync Time Now</button></div></div><div class="settings-section"><div class="settings-section-title">üåç Timezone</div><div class="form-group"><label class="form-label">Timezone</label><select id="cfg-tz-select" class="form-input" onchange="updateTzInput()"><option value="auto">Auto (Detect from Location)</option><option value="-18000">EST (Eastern Time)</option><option value="-21600">CST (Central Time)</option><option value="-25200">MST (Mountain Time)</option><option value="-28800">PST (Pacific Time)</option><option value="0">GMT/UTC</option><option value="3600">CET (Central Europe)</option><option value="7200">SAST (South Africa)</option><option value="manual">Manual Offset</option></select></div><div id="cfg-gmt-wrapper" style="display:none;"><div class="form-group"><label class="form-label">GMT Offset (seconds)</label><input type="number" id="cfg-gmt" class="form-input" placeholder="e.g., -18000 for EST"><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Seconds offset from GMT/UTC</div></div></div><div class="form-group"><label class="form-label">Daylight Savings</label><input type="number" id="cfg-dst" class="form-input" placeholder="3600" value="0"><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Seconds (typically 3600 for 1 hour, or 0 if not active)</div></div></div><div class="settings-section"><div class="settings-section-title">üå°Ô∏è Display Units</div><div class="form-group"><label class="form-label">Temperature Unit</label><div style="display:flex;gap:8px;"><button id="btn-unit-c" class="btn" style="flex:1;background:var(--primary);color:white;" onclick="setTempUnit('C')">¬∞C Celsius</button><button id="btn-unit-f" class="btn" style="flex:1;background:transparent;border:1px solid var(--glass-border);" onclick="setTempUnit('F')">¬∞F Fahrenheit</button></div></div></div><button class="btn btn-primary" onclick="saveConfig()" style="width:100%;margin-top:20px;">Save Changes</button></div></div><div id="page-gh" class="settings-page"><div class="settings-header"><button class="back-btn" onclick="nav('home')">‚Üê</button><h3>Greenhouse Config</h3></div><div class="settings-content"><div class="settings-section"><div class="settings-section-title">üìç Location & Weather</div><div id="cfg-location-display" style="padding:12px;margin-bottom:12px;background:rgba(79,124,255,0.1);border:1px solid rgba(79,124,255,0.3);border-radius:8px;font-size:0.95rem;color:var(--text-muted);">Location will appear here</div><div style="display:flex;gap:10px;margin-bottom:12px;"><input type="text" id="cfg-lat" class="form-input" placeholder="Latitude (38.7123)" style="flex:1;"><input type="text" id="cfg-lon" class="form-input" placeholder="Longitude (-77.5678)" style="flex:1;"></div><button class="btn" style="background:var(--primary);color:white;width:100%;margin-bottom:12px;" onclick="syncLocation()">üìç Get Location from Phone</button><div style="font-size:0.75rem;color:var(--text-muted);line-height:1.5;">Used for weather data, sunrise/sunset times, and timezone detection. Alternatively, <a href="https://www.google.com/maps" target="_blank" style="color:var(--primary);">find coordinates on Google Maps</a> (right-click ‚Üí get coordinates)</div></div><div class="settings-section"><div class="settings-section-title">‚ö° Device Monitoring</div><div class="form-group"><label class="form-label">Amp Detection Threshold</label><input type="number" id="cfg-amp-thresh" class="form-input" placeholder="0.25" step="0.01" min="0.10" max="1.00" value="0.25"><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Minimum current (amps) to detect device is ON. Higher = less false-positives</div></div></div><div class="settings-section" style="background:rgba(255,193,7,0.08);border-color:rgba(255,193,7,0.2);"><div class="settings-section-title" style="color:rgba(255,193,7,0.9);">üîß Advanced</div><div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px;margin-bottom:12px;"><div><div style="font-weight:600;">Proxy Mode</div><div style="font-size:0.85rem;color:var(--text-muted);margin-top:2px;">Route via external controller</div></div><label class="toggle-switch"><input type="checkbox" id="cfg-proxy"><span class="slider"></span></label></div><div class="form-group"><label class="form-label">Controller IP Address</label><input type="text" id="cfg-pi-ip" class="form-input" placeholder="192.168.1.100"><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Raspberry Pi or external controller address</div></div></div><button class="btn btn-primary" onclick="saveConfig()" style="width:100%;margin-top:20px;">Save Changes</button></div></div><div id="page-ota" class="settings-page"><div class="settings-header"><button class="back-btn" onclick="nav('home')">‚Üê</button><h3>Firmware Update</h3></div><div class="settings-content"><div style="background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.3);border-radius:12px;padding:16px;margin-bottom:24px;"><div style="font-weight:600;margin-bottom:8px;">üì¶ Current Version</div><div style="font-size:1.5rem;font-weight:300;color:var(--primary);">v1.0.2</div><div style="font-size:0.85rem;color:var(--text-muted);margin-top:4px;">ESP32 Greenhouse Controller</div></div><div style="background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.2);border-radius:12px;padding:16px;margin-bottom:24px;"><div style="font-weight:600;margin-bottom:8px;color:rgba(255,193,7,0.9);">‚ö†Ô∏è Before Updating</div><div style="font-size:0.85rem;color:var(--text-muted);line-height:1.6;">‚úì Keep device powered throughout the update<br>‚úì Update takes 1-3 minutes<br>‚úì Device will restart automatically<br>‚úì Your settings will be preserved</div></div><div class="settings-section"><div class="settings-section-title">üì• Upload New Firmware</div><div class="form-group"><label class="form-label">Firmware File (.bin)</label><input type="file" id="ota-file" accept=".bin" class="form-input" style="padding:10px;"><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Select a .bin firmware file</div></div><div id="ota-progress" style="display:none;margin-bottom:20px;"><div style="background:var(--surface-elevated);border-radius:8px;height:40px;overflow:hidden;position:relative;border:1px solid var(--glass-border);"><div id="ota-progress-bar" style="height:100%;background:var(--primary-gradient);transition:width 0.3s;width:0%;display:flex;align-items:center;justify-content:center;font-weight:600;color:white;font-size:0.85rem;"></div></div><div id="ota-status" style="text-align:center;margin-top:10px;font-size:0.85rem;color:var(--text-muted);"></div></div><button class="btn btn-primary" onclick="startOTA()" id="ota-upload-btn" style="width:100%;">üöÄ Upload & Install Firmware</button></div><div class="settings-section" style="background:rgba(255,71,87,0.08);border-color:rgba(255,71,87,0.2);"><div class="settings-section-title" style="color:rgba(255,71,87,0.9);">üîÑ Device Control</div><button class="btn" style="background:rgba(255,71,87,0.2);color:rgba(255,71,87,1);width:100%;border:1px solid rgba(255,71,87,0.3);" onclick="if(confirm('Reboot device now? It will restart automatically.'))sendWS({type:'reboot'});">Restart Device</button></div></div></div></div></div><script>let socket;const statusDot=document.getElementById('status-indicator');let config={ssid:'',pass:'',proxy:false,piIp:''};let devices=[];let lastTemp=null;let isEditMode=false;let timeFormat=24;let tempUnit='C';let lastSysTime="";let sparkChart=null;let tempHistory=[];let lastWeatherData=null;let currentCity='';let currentRegion='';let currentRSSI=-999;let openControlModalDeviceId=null;let pendingToggle=false;let reconnectTimer=null;let devicePowerData={};function sendWS(data){if(socket&&socket.readyState===WebSocket.OPEN){socket.send(JSON.stringify(data));return true;}else{console.warn('WebSocket not connected,cannot send:',data);return false;}}function connectWebSocket(){socket=new WebSocket(`ws://${window.location.host}/ws`);socket.onopen=()=>{statusDot.classList.remove('status-offline');statusDot.classList.add('status-online');console.log('WebSocket connected');if(reconnectTimer){clearTimeout(reconnectTimer);reconnectTimer=null;}};socket.onclose=()=>{statusDot.classList.remove('status-online');statusDot.classList.add('status-offline');console.log('WebSocket disconnected,reconnecting in 3s...');if(!reconnectTimer){reconnectTimer=setTimeout(connectWebSocket,3000);}};socket.onerror=(err)=>{console.error('WebSocket error:',err);};socket.onmessage=handleWebSocketMessage;}connectWebSocket();function handleWebSocketMessage(event){const data=JSON.parse(event.data);if(data.type==='telemetry'){updateTelemetry(data);}else if(data.type==='weather'){updateWeather(data.data);}else if(data.type==='location'){if(data.city&&data.region){document.getElementById('nav-location').innerText='üìç '+data.city+', '+data.region;}}else if(data.type==='sync'){if(data.net){if(data.net.connected){document.getElementById('net-badge').innerText='Connected';document.getElementById('net-badge').style.background='var(--success)';document.getElementById('home-net-sub').innerText=data.net.ssid||'Connected';if(data.net.ip)document.getElementById('net-ip').innerText=data.net.ip;if(data.net.rssi){currentRSSI=data.net.rssi;document.getElementById('net-rssi').innerText=data.net.rssi;updateWifiBars(data.net.rssi);}if(data.net.ssid)document.getElementById('net-ssid').innerText=data.net.ssid;}else{document.getElementById('net-badge').innerText='AP Mode';document.getElementById('net-badge').style.background='var(--warning)';document.getElementById('home-net-sub').innerText='Access Point Only';}}if(data.sys&&data.sys.time){lastSysTime=data.sys.time;renderTime();if(data.sys.valid===false){console.log('NTP not synced,using browser time');syncBrowserTime(false);}}if(pendingToggle){setTimeout(()=>{pendingToggle=false;},100);return;}updateTelemetry(data);updateConfig(data.config);updateMap(data.devices);if(openControlModalDeviceId){const updatedDevice=data.devices.find(d=>d.id===openControlModalDeviceId);if(updatedDevice){openDeviceControlModal(openControlModalDeviceId);}}}};function renderTime(){if(!lastSysTime)return;const parts=lastSysTime.split(' ');if(parts.length<2)return;const timePart=parts[1];const [h,m,s]=timePart.split(':');let displayTime=timePart;if(timeFormat===12){let hour=parseInt(h);const ampm=hour>=12 ? 'PM':'AM';hour=hour % 12;hour=hour ? hour:12;displayTime=`${hour}:${m}${ampm}`;}document.getElementById('clock').innerText=displayTime;}setInterval(()=>{if(lastSysTime){const parts=lastSysTime.split(' ');if(parts.length>=2){const [date,time]=parts;const [h,m,s]=time.split(':').map(Number);let newS=s+1;let newM=m;let newH=h;if(newS>=60){newS=0;newM++;}if(newM>=60){newM=0;newH++;}if(newH>=24){newH=0;}lastSysTime=`${date}${String(newH).padStart(2,'0')}:${String(newM).padStart(2,'0')}:${String(newS).padStart(2,'0')}`;renderTime();}}},1000);function updateClockFormat(){const val=document.getElementById('cfg-timefmt').value;timeFormat=parseInt(val);localStorage.setItem('timeFormat',timeFormat);renderTime();}function updateTelemetry(data){if(data.temp){lastTemp=data.temp;document.getElementById('temp-display').innerText=formatTemp(data.temp);const dateObj=new Date();const timeStr=`${dateObj.getHours()}:${String(dateObj.getMinutes()).padStart(2,'0')}`;tempHistory.push({ts:timeStr,c:data.temp});if(tempHistory.length>60)tempHistory.shift();updateChartDisplay();}if(data.amps){document.getElementById('power-display').innerText=data.amps.toFixed(2);}if(data.power){document.getElementById('power-display').innerText=data.power.total_amps.toFixed(2);if(data.power.devices){data.power.devices.forEach(pd=>{devicePowerData[pd.ch]={amps:pd.amps,on:pd.on,healthy:pd.healthy};});}}}function updateWeather(data){if(data.valid){lastWeatherData={temp:data.temp,min:data.min,max:data.max,code:data.code,humi:data.humi,wind:data.wind,wind_direction:data.wind_direction,pressure:data.pressure,cloud_cover:data.cloud_cover,visibility:data.visibility,uv_index:data.uv_index,feels:data.feels,hourly:data.hourly||[]};const locName=(currentCity&&currentRegion)? 'üìç '+currentCity+", "+currentRegion:"üìç Greenhouse";document.getElementById('weather-loc').innerText=locName;const displayTemp=Math.round(data.temp);const displayMin=Math.round(data.min);const displayMax=Math.round(data.max);const displayFeels=Math.round(data.feels);document.getElementById('out-temp').innerText=displayTemp+'¬∞';document.getElementById('out-min').innerText=displayMin;document.getElementById('out-max').innerText=displayMax;const feelsElement=document.getElementById('out-feels');if(feelsElement){feelsElement.innerText=displayFeels+'¬∞';}document.getElementById('out-humi').innerText=(data.humi||'--')+'%';document.getElementById('out-wind').innerText=(data.wind||'--')+' km/h';document.getElementById('out-pressure').innerText=(data.pressure||'--')+' hPa';document.getElementById('out-cloud').innerText=(data.cloud_cover||'--')+'%';document.getElementById('out-visibility').innerText=((data.visibility||0)/1000).toFixed(1)+' km';document.getElementById('out-uv').innerText=data.uv_index||'--';const windDir=data.wind_direction||0;const directions=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];const dirIndex=Math.round(windDir/22.5)%16;document.getElementById('out-wind-dir').innerText=directions[dirIndex];const isDay=data.is_day!==0;const weatherInfo=getWeatherInfo(data.code,isDay);document.getElementById('out-desc').innerText=weatherInfo.text;document.getElementById('weather-icon').innerText=weatherInfo.icon;renderHourlyForecast(data.hourly||[]);}else{document.getElementById('weather-loc').innerText='üìç Offline';document.getElementById('out-temp').innerText='--¬∞';document.getElementById('out-desc').innerText='No connection';document.getElementById('weather-icon').innerText='üì°';const feelsElement=document.getElementById('out-feels');if(feelsElement){feelsElement.innerText='--¬∞';}document.getElementById('out-humi').innerText='--';document.getElementById('out-wind').innerText='--';document.getElementById('out-pressure').innerText='--';document.getElementById('out-cloud').innerText='--';document.getElementById('out-visibility').innerText='--';document.getElementById('out-uv').innerText='--';document.getElementById('out-wind-dir').innerText='--';document.getElementById('hourly-forecast').innerHTML='';weatherExpanded=false;document.getElementById('weather-expanded').style.display='none';document.getElementById('weather-expand-arrow').style.transform='rotate(0deg)';}}function renderHourlyForecast(hourly){const container=document.getElementById('hourly-forecast');if(!hourly||hourly.length===0){container.innerHTML='';return;}container.innerHTML=hourly.map((h,i)=>{const temp=Math.round(h.temp);const info=getWeatherInfo(h.code,h.is_day!==0);const timeLabel=i===0?'Now':formatHour(h.time);return `<div style="min-width:60px;text-align:center;padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:12px;"><div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:0.25rem;">${timeLabel}</div><div style="font-size:1.25rem;">${info.icon}</div><div style="font-size:0.9rem;font-weight:500;margin-top:0.25rem;">${temp}¬∞</div></div>`;}).join('');}function formatHour(time){if(!time)return'';const[h,m]=time.split(':');const hour=parseInt(h);if(timeFormat===12){const ampm=hour>=12?'PM':'AM';const h12=hour%12||12;return h12+' '+ampm;}return h+':'+m;}function refreshWeather(e){if(e)e.stopPropagation();sendWS({type:'refresh_weather'});document.getElementById('weather-card').style.opacity='0.7';setTimeout(()=>{document.getElementById('weather-card').style.opacity='1';},500);}let weatherExpanded=false;function toggleWeatherExpand(){weatherExpanded=!weatherExpanded;const expandedDiv=document.getElementById('weather-expanded');const arrow=document.getElementById('weather-expand-arrow');if(weatherExpanded){expandedDiv.style.display='block';arrow.style.transform='rotate(180deg)';}else{expandedDiv.style.display='none';arrow.style.transform='rotate(0deg)';}}function openWeatherModal(){refreshWeather();}function getWeatherInfo(code,isDay){const now=new Date();const hour=now.getHours();const isDayLocal=(hour>6&&hour<20);const effectiveDay=typeof isDay==='boolean'?isDay:isDayLocal;if(code===0)return{icon:effectiveDay?"‚òÄÔ∏è":"üåô",text:effectiveDay?"Clear":"Clear Night"};if(code===1)return{icon:effectiveDay?"üå§Ô∏è":"üåô",text:effectiveDay?"Mostly Clear":"Mostly Clear"};if(code===2)return{icon:effectiveDay?"‚õÖ":"‚òÅÔ∏è",text:"Partly Cloudy"};if(code===3)return{icon:"‚òÅÔ∏è",text:"Overcast"};if(code>=45&&code<=48)return{icon:"üå´Ô∏è",text:"Foggy"};if(code>=51&&code<=55)return{icon:"üå¶Ô∏è",text:"Drizzle"};if(code>=56&&code<=57)return{icon:"ü•∂",text:"Freezing Drizzle"};if(code>=61&&code<=65)return{icon:"üåßÔ∏è",text:"Rainy"};if(code>=66&&code<=67)return{icon:"ü•∂üåßÔ∏è",text:"Freezing Rain"};if(code>=71&&code<=75)return{icon:"üå®Ô∏è",text:"Snowy"};if(code===77)return{icon:"‚ùÑÔ∏è",text:"Snow Grains"};if(code>=80&&code<=82)return{icon:"üåßÔ∏è",text:"Showers"};if(code>=85&&code<=86)return{icon:"üå®Ô∏è",text:"Snow Showers"};if(code===95)return{icon:"‚õàÔ∏è",text:"Thunderstorm"};if(code>=96&&code<=99)return{icon:"‚õàÔ∏èüßä",text:"Thunderstorm+Hail"};return{icon:effectiveDay?"üå§Ô∏è":"üåô",text:"Unknown"};}function formatTemp(val){if(val===undefined||val===null)return "--";if(tempUnit==='F'){return((val*9/5)+32).toFixed(1);}return val.toFixed(1);}function updateConfig(cfg){if(!cfg)return;config=cfg;if(cfg.ssid){document.getElementById('cfg-ssid').value=cfg.ssid;document.getElementById('net-ssid').innerText=cfg.ssid;}if(cfg.pass)document.getElementById('cfg-pass').value=cfg.pass;if(cfg.piIp)document.getElementById('cfg-pi-ip').value=cfg.piIp;document.getElementById('cfg-proxy').checked=cfg.proxy||false;if(cfg.city&&cfg.region){if(!cfg.lat||!cfg.lon){currentCity=cfg.city;currentRegion=cfg.region;document.getElementById('nav-location').innerText='üìç '+cfg.city+', '+cfg.region;}}if(cfg.ntp)document.getElementById('cfg-ntp').value=cfg.ntp;if(cfg.gmt!==undefined){document.getElementById('cfg-gmt').value=cfg.gmt;const tzSelect=document.getElementById('cfg-tz-select');const matchingOption=Array.from(tzSelect.options).find(opt=>opt.value===String(cfg.gmt));if(matchingOption){tzSelect.value=matchingOption.value;}else{tzSelect.value='manual';document.getElementById('cfg-gmt-wrapper').style.display='block';}}if(cfg.dst!==undefined)document.getElementById('cfg-dst').value=cfg.dst;const settingsModal=document.getElementById('settings-modal');const settingsOpen=settingsModal&&settingsModal.classList.contains('open');if(!settingsOpen){if(cfg.lat){document.getElementById('cfg-lat').value=cfg.lat;reverseGeocode(cfg.lat,cfg.lon);}if(cfg.lon)document.getElementById('cfg-lon').value=cfg.lon;}if(cfg.ip)document.getElementById('net-ip').innerText=cfg.ip;if(cfg.rssi)document.getElementById('net-rssi').innerText=cfg.rssi;if(cfg.unit){tempUnit=cfg.unit.toUpperCase();localStorage.setItem('tempUnit',tempUnit);setTempUnit(tempUnit);}if(cfg.ampThresh!==undefined){document.getElementById('cfg-amp-thresh').value=cfg.ampThresh;}}let isDraggingDevice=false;let lastMovedDevices=new Map();function updateMap(devs){if(isDraggingDevice)return;devices=devs||[];const map=document.getElementById('gh-map');map.innerHTML='';const isMobile=window.innerWidth<=768;const now=Date.now();for(const [deviceId,data] of lastMovedDevices.entries()){if(now-data.timestamp>2000){lastMovedDevices.delete(deviceId);}}devices.forEach(d=>{const el=document.createElement('div');el.id='dev-'+d.id;el.className='map-device';el.setAttribute('data-device-id',d.id);const recentMove=lastMovedDevices.get(d.id);const useRecentPosition=recentMove&&recentMove.isMobile===isMobile;if(isMobile){if(useRecentPosition){el.style.left=recentMove.x+'%';el.style.top=recentMove.y+'%';console.log(`[MOBILE PRESERVED] ${d.id}at(${recentMove.x},${recentMove.y})`);}else{const mobileX=(d.x_mobile!==undefined&&d.x_mobile!==null)? d.x_mobile:d.x;const mobileY=(d.y_mobile!==undefined&&d.y_mobile!==null)? d.y_mobile:d.y;el.style.left=mobileX+'%';el.style.top=mobileY+'%';console.log(`[MOBILE] ${d.id}at(${mobileX},${mobileY}),data:x=${d.x},y=${d.y},x_mobile=${d.x_mobile},y_mobile=${d.y_mobile}`);}}else{if(useRecentPosition){el.style.left=recentMove.x+'%';el.style.top=recentMove.y+'%';console.log(`[DESKTOP PRESERVED] ${d.id}at(${recentMove.x},${recentMove.y})`);}else{el.style.left=d.x+'%';el.style.top=d.y+'%';console.log(`[DESKTOP] ${d.id}at(${d.x},${d.y})`);}}const rotation=isMobile ?(d.rotation_mobile!==undefined ? d.rotation_mobile:(d.rotation||0)):(d.rotation||0);el.style.transform=rotation!==0 ? `rotate(${rotation}deg)`:'rotate(0deg)';el.innerHTML=getDeviceIcon(d.type);el.oncontextmenu=(e)=>e.preventDefault();if(d.enabled===false){el.style.opacity='0.3';el.style.filter='grayscale(100%)';}if(d.state&&d.enabled!==false&&d.phys_type===1){const type=d.type.toLowerCase();const pwrData=devicePowerData[d.ch];const isHealthy=!pwrData||pwrData.healthy!==false;const deviceAmps=pwrData?pwrData.amps:0;if(!isHealthy){el.classList.add('anim-fault');}else if(type.includes('heat')||type==='heater'){el.classList.add('anim-fire');}else if(type.includes('fan_circ')||type.includes('circ')){el.classList.add('anim-orange');}else if(type.includes('fan_cool')||type.includes('cool')){el.classList.add('anim-blue');}else if(type.includes('vent')){el.classList.add('anim-vent');}else if(type.includes('light')||type.includes('lamp')){el.classList.add('anim-white');}if(deviceAmps>0.20){const ampBadge=document.createElement('div');ampBadge.className='current-badge'+(isHealthy?'':' fault');ampBadge.textContent=deviceAmps.toFixed(2)+'A';el.appendChild(ampBadge);}}if((d.phys_type===2||d.phys_type===3)&&d.value!==undefined){el.classList.add('anim-brown');const tempLabel=document.createElement('div');tempLabel.className='temp-label';const displayTemp=tempUnit==='F' ? toFahrenheit(d.value):d.value;tempLabel.textContent=`${displayTemp.toFixed(1)}¬∞${tempUnit}`;el.appendChild(tempLabel);}if(isEditMode){el.style.cursor='grab';let devicePosX=parseFloat(el.style.left)||0;let devicePosY=parseFloat(el.style.top)||0;const deviceRotation=isMobile ?(d.rotation_mobile!==undefined ? d.rotation_mobile:(d.rotation||0)):(d.rotation||0);let isDragging=false;let hasMovedEnough=false;let dragStartX,dragStartY;const onMouseMove=(e)=>{if(!isDragging)return;const rect=map.getBoundingClientRect();const deltaX=e.clientX-dragStartX;const deltaY=e.clientY-dragStartY;const distMoved=Math.sqrt(deltaX*deltaX+deltaY*deltaY);if(distMoved>5)hasMovedEnough=true;const deltaXPct=(deltaX/rect.width)*100;const deltaYPct=(deltaY/rect.height)*100;const newX=devicePosX+deltaXPct;const newY=devicePosY+deltaYPct;el.style.left=Math.max(-10,Math.min(110,newX))+'%';el.style.top=Math.max(-10,Math.min(110,newY))+'%';e.preventDefault();};const onMouseUp=(e)=>{if(!isDragging)return;isDragging=false;isDraggingDevice=false;el.style.zIndex='5';el.style.cursor='grab';el.classList.remove('dragging');el.style.transform=deviceRotation!==0 ? `rotate(${deviceRotation}deg)`:'rotate(0deg)';document.removeEventListener('mousemove',onMouseMove);document.removeEventListener('mouseup',onMouseUp);if(hasMovedEnough){const finalX=Math.round(parseFloat(el.style.left));const finalY=Math.round(parseFloat(el.style.top));devicePosX=finalX;devicePosY=finalY;lastMovedDevices.set(d.id,{x:finalX,y:finalY,isMobile:false,timestamp:Date.now()});sendWS({type:'move_device',id:d.id,x:finalX,y:finalY});}else{openDeviceConfigModal(d.id);}};el.onmousedown=(e)=>{if(e.button!==0)return;isDragging=true;isDraggingDevice=true;hasMovedEnough=false;dragStartX=e.clientX;dragStartY=e.clientY;el.style.zIndex='100';el.style.cursor='grabbing';el.classList.add('dragging');el.style.transform=deviceRotation!==0 ? `rotate(${deviceRotation}deg)scale(1.15)`:'scale(1.15)';document.addEventListener('mousemove',onMouseMove);document.addEventListener('mouseup',onMouseUp);e.preventDefault();e.stopPropagation();};let isTouchDragging=false;let touchHasMoved=false;let touchStartX,touchStartY;el.ontouchstart=(e)=>{if(e.touches.length!==1)return;const touch=e.touches[0];const currentLeft=parseFloat(el.style.left)||0;const currentTop=parseFloat(el.style.top)||0;isTouchDragging=true;isDraggingDevice=true;touchHasMoved=false;touchStartX=touch.clientX;touchStartY=touch.clientY;devicePosX=currentLeft;devicePosY=currentTop;console.log(`[TOUCH] ${d.id}start at(${devicePosX},${devicePosY})`);el.style.zIndex='100';el.classList.add('dragging');el.style.transform=deviceRotation!==0 ? `rotate(${deviceRotation}deg)scale(1.15)`:'scale(1.15)';e.preventDefault();};el.ontouchmove=(e)=>{if(!isTouchDragging||e.touches.length!==1)return;const touch=e.touches[0];const rect=map.getBoundingClientRect();let deltaX=touch.clientX-touchStartX;let deltaY=touch.clientY-touchStartY;const distMoved=Math.sqrt(deltaX*deltaX+deltaY*deltaY);if(distMoved>5)touchHasMoved=true;const deltaXPct=(deltaX/rect.width)*100;const deltaYPct=(deltaY/rect.height)*100;const newX=devicePosX+deltaXPct;const newY=devicePosY+deltaYPct;el.style.left=Math.max(-10,Math.min(110,newX))+'%';el.style.top=Math.max(-10,Math.min(110,newY))+'%';e.preventDefault();};el.ontouchend=(e)=>{if(!isTouchDragging)return;isTouchDragging=false;isDraggingDevice=false;el.style.zIndex='5';el.classList.remove('dragging');el.style.transform=deviceRotation!==0 ? `rotate(${deviceRotation}deg)`:'rotate(0deg)';if(touchHasMoved){const finalX=Math.round(parseFloat(el.style.left));const finalY=Math.round(parseFloat(el.style.top));devicePosX=finalX;devicePosY=finalY;lastMovedDevices.set(d.id,{x:finalX,y:finalY,isMobile:true,timestamp:Date.now()});sendWS({type:'move_device',id:d.id,x_mobile:finalX,y_mobile:finalY});}else{openDeviceConfigModal(d.id);}};el.ontouchcancel=(e)=>{if(!isTouchDragging)return;isTouchDragging=false;isDraggingDevice=false;el.style.zIndex='5';el.classList.remove('dragging');};}else{if(d.enabled!==false){el.onclick=()=>openDeviceControlModal(d.id);el.style.cursor='pointer';let tapStartTime=0;let tapStartX=0;let tapStartY=0;el.ontouchstart=(e)=>{tapStartTime=Date.now();tapStartX=e.touches[0].clientX;tapStartY=e.touches[0].clientY;};el.ontouchend=(e)=>{const tapDuration=Date.now()-tapStartTime;const tapEndX=e.changedTouches[0].clientX;const tapEndY=e.changedTouches[0].clientY;const moveDistance=Math.sqrt(Math.pow(tapEndX-tapStartX,2)+Math.pow(tapEndY-tapStartY,2));if(tapDuration<300&&moveDistance<10){openDeviceControlModal(d.id);e.preventDefault();}};}else{el.style.cursor='not-allowed';el.onclick=()=>{};}}if(d.state)el.classList.add('active');if((d.phys_type===2||d.phys_type===3)&&d.value!==undefined){const badge=document.createElement('div');badge.className='temp-badge';badge.style.position='absolute';badge.style.top='-20px';badge.style.left='50%';badge.style.transform='translateX(-50%)';badge.style.background='rgba(59,130,246,0.9)';badge.style.padding='2px 6px';badge.style.borderRadius='6px';badge.style.fontSize='0.7rem';badge.style.fontWeight='600';badge.style.whiteSpace='nowrap';badge.innerText=formatTemp(d.value)+'¬∞';el.appendChild(badge);}map.appendChild(el);});}function getDeviceIcon(type){const icons={'heater':'üî•','heat':'üî•','fan_circ':'üåÄ','circ':'üåÄ','fan_cool':'‚ùÑÔ∏è','cool':'‚ùÑÔ∏è','vent':'ü™ü','light':'üí°','sensor':'üå°Ô∏è','blower':'üå™Ô∏è','camera':'üì∑'};return icons[type]||'‚ùì';}function toggleEditMode(){isEditMode=document.getElementById('edit-mode-toggle').checked;const palette=document.getElementById('palette');const map=document.getElementById('gh-map');const isFullscreen=document.body.classList.contains('fullscreen-map');if(isEditMode){palette.style.display='flex';map.classList.add('edit-mode');if(isFullscreen){document.body.classList.add('edit-mode');}}else{palette.style.display='none';map.classList.remove('edit-mode');document.body.classList.remove('edit-mode');sendWS({type:'force_save_layout'});console.log('[SAVE] Forced layout save on exit edit mode');}updateMap(devices);}function toggleFullscreen(){const wasFullscreen=document.body.classList.contains('fullscreen-map');document.body.classList.toggle('fullscreen-map');if(wasFullscreen){document.body.classList.remove('edit-mode');setTimeout(()=>{document.querySelector('.map-card').scrollIntoView({behavior:'smooth',block:'center'});},100);}else{if(isEditMode){document.body.classList.add('edit-mode');}setTimeout(()=>{window.scrollTo(0,1);},100);}}function toggleSettings(){const modal=document.getElementById('settings-modal');const isOpen=modal.classList.contains('open');if(isOpen){modal.classList.remove('open');}else{nav('home');modal.classList.add('open');}}document.querySelectorAll('.modal-overlay').forEach(modal=>{modal.addEventListener('click',(e)=>{if(e.target===modal){modal.classList.remove('open');}});});let navigationStack=['home'];function nav(pageId){if(pageId!==navigationStack[navigationStack.length-1]){history.pushState({page:pageId},'','#'+pageId);navigationStack.push(pageId);}document.querySelectorAll('.settings-page').forEach(p=>p.classList.remove('active'));const target=document.getElementById('page-'+pageId);if(target)target.classList.add('active');}window.addEventListener('popstate',(event)=>{if(event.state&&event.state.page){navigationStack.pop();const pageId=event.state.page;document.querySelectorAll('.settings-page').forEach(p=>p.classList.remove('active'));const target=document.getElementById('page-'+pageId);if(target)target.classList.add('active');}else{nav('home');}});window.addEventListener('load',()=>{const hash=window.location.hash.substring(1);if(hash&&document.getElementById('page-'+hash)){nav(hash);}else{history.replaceState({page:'home'},'','#home');}});function allowDrop(ev){ev.preventDefault();}function dragStartNew(ev,type){ev.dataTransfer.setData("type",type);}let draggedDeviceId=null;function dragDevice(ev,deviceId){draggedDeviceId=deviceId;ev.dataTransfer.effectAllowed='move';ev.dataTransfer.setData("deviceId",deviceId);}function dropNew(ev){ev.preventDefault();const deviceId=ev.dataTransfer.getData("deviceId");const type=ev.dataTransfer.getData("type");const rect=document.getElementById('gh-map').getBoundingClientRect();const xPct=Math.round(((ev.clientX-rect.left)/rect.width)*100);const yPct=Math.round(((ev.clientY-rect.top)/rect.height)*100);const finalX=Math.max(-10,Math.min(110,xPct));const finalY=Math.max(-10,Math.min(110,yPct));if(deviceId&&draggedDeviceId){sendWS({type:'move_device',id:draggedDeviceId,x:finalX,y:finalY});draggedDeviceId=null;return;}if(!type||!isEditMode)return;sendWS({type:'create_device',type_id:type,x:finalX,y:finalY});}function openDeviceConfigModal(id){const device=devices.find(d=>d.id===id);if(!device)return;const isMobile=window.innerWidth<=768;document.getElementById('dev-cfg-id').value=device.id;document.getElementById('dev-cfg-name').value=device.name;document.getElementById('dev-cfg-type').value=device.type;document.getElementById('dev-cfg-rotation').value=isMobile ?(device.rotation_mobile!==undefined ? device.rotation_mobile:(device.rotation||0)):(device.rotation||0);document.getElementById('dev-cfg-phys-type').value=device.phys_type||0;document.getElementById('dev-cfg-channel').value=device.ch||0;document.getElementById('dev-cfg-pin').value=device.phys_pin||'';document.getElementById('dev-cfg-addr').value=device.phys_addr||'';document.getElementById('dev-cfg-url').value=device.phys_addr||'';if(device.enabled===false){document.getElementById('dev-cfg-disabled').checked=true;}else{document.getElementById('dev-cfg-enabled').checked=true;}updatePhysicalFields();updateRotationPreview();document.getElementById('device-config-modal').classList.add('open');}function openDeviceControlModal(id){const device=devices.find(d=>d.id===id);if(!device)return;openControlModalDeviceId=id;let modal=document.getElementById('device-control-modal');if(!modal){modal=document.createElement('div');modal.id='device-control-modal';modal.className='modal-overlay';modal.innerHTML=`<div class="modal-box" style="max-width:320px;max-height:70vh;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding:15px 15px 0 15px;"><h2 id="ctrl-device-name" style="margin:0;font-size:1.1rem;">Device</h2><button class="btn" style="width:auto;padding:0.4rem;" onclick="closeDeviceControl()">‚úï</button></div><div id="ctrl-content" style="padding:0 15px 15px 15px;"></div></div>`;modal.onclick=(e)=>{if(e.target===modal)closeDeviceControl();};document.body.appendChild(modal);}document.getElementById('ctrl-device-name').innerText=device.name;const content=document.getElementById('ctrl-content');if(device.phys_type===1){const btnClass=device.state ? 'btn btn-primary power-btn-on':'btn btn-primary';const stateLabel=device.state ? 'ON':'OFF';const stateBadgeClass=device.state ? 'state-badge state-on':'state-badge state-off';const pwrData=devicePowerData[device.ch];const deviceAmps=pwrData?pwrData.amps:0;const isHealthy=!pwrData||pwrData.healthy!==false;const healthStatus=device.state?(isHealthy?(deviceAmps>0.20?'‚úì Drawing '+deviceAmps.toFixed(2)+'A':'‚ö° Waiting...'):'‚ö†Ô∏è Fault: No current detected'):'';const healthColor=device.state?(isHealthy?'var(--success)':'var(--danger)'):'var(--text-muted)';content.innerHTML=`<div style="text-align:center;"><div style="margin-bottom:12px;"><div style="font-size:2.75rem;margin-bottom:10px;">${getDeviceIcon(device.type)}</div><div class="${stateBadgeClass}">${stateLabel}</div>${healthStatus?`<div style="font-size:0.85rem;color:${healthColor};margin-top:8px;">${healthStatus}</div>`:''}</div><button class="${btnClass}" style="width:100px;height:100px;border-radius:50%;font-size:3rem;line-height:100px;text-align:center;margin:0 auto;padding:0;transition:all 0.3s ease;cursor:pointer;display:flex;align-items:center;justify-content:center;" onclick="toggleDevice('${device.id}')"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v10"></path><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path></svg></button><div style="margin-top:12px;font-size:0.85rem;color:var(--text-muted);">Relay Channel ${device.ch||0}</div><div class="state-badge state-enabled" style="margin-top:8px;">${device.enabled!==false ? 'Enabled':'Disabled'}</div></div>`;}else if(device.phys_type===2||device.phys_type===3){const tempVal=device.value!==undefined ? formatTemp(device.value):'--';const isReading=device.value!==undefined;const stateBadgeClass=isReading ? 'state-badge state-on':'state-badge state-off';content.innerHTML=`<div style="text-align:center;"><div style="font-size:4rem;margin-bottom:10px;">${getDeviceIcon(device.type)}</div><div style="font-size:3rem;font-weight:300;margin:20px 0;">${tempVal}¬∞</div><div class="${stateBadgeClass}">${isReading ? 'Active':'Inactive'}</div><div style="font-size:1.1rem;color:var(--text-muted);margin-top:15px;">${device.phys_type===2 ? 'DHT22 Sensor':'DS18B20 Sensor'}</div><div style="font-size:0.85rem;color:var(--text-muted);margin-top:10px;">GPIO Pin ${device.phys_pin||'--'}</div><div class="state-badge state-enabled" style="margin-top:12px;">${device.enabled!==false ? 'Enabled':'Disabled'}</div></div>`;}else if(device.phys_type===4||device.phys_type===5){content.innerHTML=`<div style="text-align:center;"><div style="font-size:4rem;margin-bottom:10px;">üì∑</div><div style="font-size:1.2rem;font-weight:600;margin-bottom:20px;">${device.phys_type===4 ? 'IP Camera':'ESP32-CAM'}</div><button class="btn btn-primary" onclick="window.open('${device.phys_addr}','_blank')">üì∫ Open Stream</button><div style="font-size:0.75rem;color:var(--text-muted);margin-top:10px;word-break:break-all;">${device.phys_addr||'No URL configured'}</div><div class="state-badge state-enabled" style="margin-top:15px;">${device.enabled!==false ? 'Enabled':'Disabled'}</div></div>`;}else{const stateBadgeClass=device.state ? 'state-badge state-on':'state-badge state-off';const stateLabel=device.state ? 'ON':'OFF';content.innerHTML=`<div style="text-align:center;"><div style="font-size:4rem;margin-bottom:10px;">${getDeviceIcon(device.type)}</div><div class="${stateBadgeClass}">${stateLabel}</div><div style="font-size:0.9rem;color:var(--text-muted);margin-top:15px;">Virtual Device</div><div class="state-badge state-enabled" style="margin-top:12px;">${device.enabled!==false ? 'Enabled':'Disabled'}</div><div style="margin:20px 0;padding:20px;background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);border-radius:8px;"><div style="font-weight:600;margin-bottom:4px;">‚ö†Ô∏è Virtual Device</div><div style="font-size:0.85rem;color:var(--text-muted);">No physical hardware assigned.<br>Enable Edit Mode to configure.</div></div></div>`;}modal.classList.add('open');}function closeDeviceControl(){openControlModalDeviceId=null;const modal=document.getElementById('device-control-modal');if(modal)modal.classList.remove('open');}function startOTA(){const fileInput=document.getElementById('ota-file');const file=fileInput.files[0];if(!file){alert('Please select a firmware file first');return;}if(!file.name.endsWith('.bin')){alert('Please select a valid .bin firmware file');return;}const progressDiv=document.getElementById('ota-progress');const progressBar=document.getElementById('ota-progress-bar');const statusText=document.getElementById('ota-status');const uploadBtn=document.getElementById('ota-upload-btn');progressDiv.style.display='block';uploadBtn.disabled=true;uploadBtn.style.opacity='0.5';statusText.innerText='Uploading firmware...';const xhr=new XMLHttpRequest();xhr.upload.addEventListener('progress',(e)=>{if(e.lengthComputable){const percent=Math.round((e.loaded/e.total)*100);progressBar.style.width=percent+'%';progressBar.innerText=percent+'%';statusText.innerText=`Uploading... ${percent}%`;}});xhr.addEventListener('load',()=>{if(xhr.status===200){progressBar.style.width='100%';progressBar.innerText='100%';statusText.innerText='‚úÖ Update successful!Device rebooting...';statusText.style.color='var(--success)';setTimeout(()=>{location.reload();},5000);}else{statusText.innerText='‚ùå Update failed:'+xhr.statusText;statusText.style.color='var(--danger)';uploadBtn.disabled=false;uploadBtn.style.opacity='1';}});xhr.addEventListener('error',()=>{statusText.innerText='‚ùå Upload error. Check connection.';statusText.style.color='var(--danger)';uploadBtn.disabled=false;uploadBtn.style.opacity='1';});const formData=new FormData();formData.append('firmware',file);xhr.open('POST','/update');xhr.send(formData);}function toggleDevice(id){const device=devices.find(d=>d.id===id);if(!device||device.enabled===false){return;}pendingToggle=true;device.state=!device.state;openDeviceControlModal(id);updateMap(devices);sendWS({type:'toggle',id:id});setTimeout(()=>{pendingToggle=false;},2000);}function closeDeviceConfig(){document.getElementById('device-config-modal').classList.remove('open');}function adjustRotation(degrees){const input=document.getElementById('dev-cfg-rotation');let current=parseInt(input.value)||0;current+=degrees;if(current>180)current-=360;if(current<-180)current+=360;input.value=current;updateRotationPreview();}function updateRotationPreview(){const rotation=parseInt(document.getElementById('dev-cfg-rotation').value)||0;const deviceId=document.getElementById('dev-cfg-id').value;if(!deviceId)return;const deviceEl=document.querySelector(`[data-device-id="${deviceId}"]`);if(deviceEl){if(rotation!==0){deviceEl.style.transform=`rotate(${rotation}deg)`;}else{deviceEl.style.transform='';}}}function updatePhysicalFields(){const physType=parseInt(document.getElementById('dev-cfg-phys-type').value);document.getElementById('relay-channel-group').style.display='none';document.getElementById('sensor-pin-group').style.display='none';document.getElementById('sensor-addr-group').style.display='none';document.getElementById('camera-url-group').style.display='none';if(physType===1){document.getElementById('relay-channel-group').style.display='block';}else if(physType===2){document.getElementById('sensor-pin-group').style.display='block';}else if(physType===3){document.getElementById('sensor-pin-group').style.display='block';document.getElementById('sensor-addr-group').style.display='block';}else if(physType===4||physType===5){document.getElementById('camera-url-group').style.display='block';}}function saveDeviceConfig(){const id=document.getElementById('dev-cfg-id').value;const name=document.getElementById('dev-cfg-name').value;const rotation=parseInt(document.getElementById('dev-cfg-rotation').value)||0;const isMobile=window.innerWidth<=768;const physType=parseInt(document.getElementById('dev-cfg-phys-type').value);const channel=parseInt(document.getElementById('dev-cfg-channel').value);const pin=parseInt(document.getElementById('dev-cfg-pin').value)||-1;const address=document.getElementById('dev-cfg-addr').value||document.getElementById('dev-cfg-url').value||'';const enabled=document.getElementById('dev-cfg-enabled').checked;const payload={type:'update_device_physical',id:id,name:name,channel:channel,phys_type:physType,phys_addr:address,phys_pin:pin,enabled:enabled};if(isMobile){payload.rotation_mobile=rotation;}else{payload.rotation=rotation;}sendWS(payload);setTimeout(()=>{sendWS({type:'force_save_layout'});console.log('[SAVE] Forced layout save after device config update');},100);closeDeviceConfig();}function deleteCurrentDevice(){const id=document.getElementById('dev-cfg-id').value;if(confirm('Delete this device?')){sendWS({type:'delete_device',id:id});closeDeviceConfig();}}function saveConfig(){const lat=document.getElementById('cfg-lat').value;const lon=document.getElementById('cfg-lon').value;const payload={type:'config_update',ssid:document.getElementById('cfg-ssid').value,pass:document.getElementById('cfg-pass').value,proxy:document.getElementById('cfg-proxy').checked,piIp:document.getElementById('cfg-pi-ip').value,ntp:document.getElementById('cfg-ntp').value,gmt:parseInt(document.getElementById('cfg-gmt').value),dst:parseInt(document.getElementById('cfg-dst').value),ampThresh:parseFloat(document.getElementById('cfg-amp-thresh').value)||0.25};sendWS(payload);if(lat&&lon){sendWS({type:'set_location',lat:lat,lon:lon});updateLocationGlobally(lat,lon);alert('Settings and Location Saved!');}else{alert('Settings Saved!');}toggleSettings();}function syncLocation(){if(!navigator.geolocation){alert('Geolocation not supported by this browser. Please manually enter coordinates from Google Maps.');return;}const btn=event.target;const originalText=btn.innerHTML;btn.innerHTML='‚è≥ Requesting location...';btn.disabled=true;navigator.geolocation.getCurrentPosition(pos=>{const lat=pos.coords.latitude.toFixed(6);const lon=pos.coords.longitude.toFixed(6);document.getElementById('cfg-lat').value=lat;document.getElementById('cfg-lon').value=lon;sendWS({type:'set_location',lat:lat,lon:lon});btn.innerHTML=originalText;btn.disabled=false;alert('‚úì Location obtained!\n\nLat:'+lat+'\nLon:'+lon+'\n\nClick "Save Settings" to keep these coordinates.');},(error)=>{btn.innerHTML=originalText;btn.disabled=false;let msg='‚ùå Location Error\n\n';if(error.code===1){msg+='Permission denied. Please click "Allow" when your browser asks for location access.\n\nIf you don\'t see a popup,check your browser\'s address bar for a blocked location icon.';}else if(error.code===2){msg+='Location unavailable. Make sure GPS/location services are enabled on your device.';}else if(error.code===3){msg+='Request timeout. Try again or enter coordinates manually from Google Maps.';}msg+='\n\nüí° Tip:This works best on phones/tablets at the greenhouse. Or manually enter coordinates from Google Maps.';alert(msg);},{enableHighAccuracy:true,timeout:10000,maximumAge:0});}async function reverseGeocode(lat,lon){if(!lat||!lon)return null;try{const response=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);const data=await response.json();if(data&&data.address){const addr=data.address;let city='';let region='';if(addr.city)city=addr.city;else if(addr.town)city=addr.town;else if(addr.village)city=addr.village;else if(addr.county)city=addr.county;if(addr.state)region=addr.state;if(city&&region){currentCity=city;currentRegion=region;const locationText=city+', '+region;document.getElementById('nav-location').innerText='üìç '+locationText;document.getElementById('weather-loc').innerText='üìç '+locationText;const locDisplay=document.getElementById('cfg-location-display');if(locDisplay){locDisplay.innerText=locationText;locDisplay.style.color='var(--success)';}return{city,region};}}}catch(error){}return null;}async function updateLocationGlobally(lat,lon){if(!lat||!lon)return;const location=await reverseGeocode(lat,lon);if(location){sendWS({type:'update_location_names',city:location.city,region:location.region});}sendWS({type:'weather_refresh'});}function syncBrowserTime(showAlert=false){const now=new Date();const year=now.getFullYear();const month=String(now.getMonth()+1).padStart(2,'0');const day=String(now.getDate()).padStart(2,'0');const hours=String(now.getHours()).padStart(2,'0');const minutes=String(now.getMinutes()).padStart(2,'0');const seconds=String(now.getSeconds()).padStart(2,'0');const unixTime=Math.floor(now.getTime()/1000);const offset=now.getTimezoneOffset()*-60;const success=sendWS({type:'set_time',unix:unixTime,gmt:offset,dst:0});lastSysTime=`${year}-${month}-${day}${hours}:${minutes}:${seconds}`;renderTime();if(showAlert){if(success){alert(`‚úì Time synced:${now.toLocaleString()}`);}else{alert('‚ö†Ô∏è WebSocket not connected');}}}function openHistoryModal(){alert('History modal-coming soon');}function updateChartDisplay(){if(sparkChart&&tempHistory.length>0){const labels=tempHistory.map(d=>d.ts);const values=tempHistory.map(d=>{let val=d.c;if(tempUnit==='F')val=(val*9/5)+32;return val;});sparkChart.data.labels=labels;sparkChart.data.datasets[0].data=values;sparkChart.update('none');}}function initSparkline(){const ctx=document.getElementById('sparkChart');if(!ctx)return;Chart.defaults.color='#94a3b8';Chart.defaults.borderColor='#334155';sparkChart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[{data:[],borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',borderWidth:2,pointRadius:0,tension:0.4,fill:true}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:false}},scales:{y:{display:false},x:{display:false}},animation:false}});}function scanWifi(){const list=document.getElementById('wifi-list');list.innerHTML='<div style="padding:20px;text-align:center;color:var(--text-muted);">Scanning...</div>';sendWS({type:'scan_wifi'});const originalOnMessage=socket.onmessage;socket.onmessage=(event)=>{const data=JSON.parse(event.data);if(data.type==='wifi_scan_result'){displayWifiList(data.networks);socket.onmessage=originalOnMessage;}else{originalOnMessage(event);}};}function displayWifiList(networks){const list=document.getElementById('wifi-list');if(!networks||networks.length===0){list.innerHTML='<div style="padding:20px;text-align:center;color:var(--text-muted);">No networks found</div>';return;}list.innerHTML='';networks.forEach(net=>{const item=document.createElement('div');item.className='list-item';item.style.cursor='pointer';item.style.padding='12px 16px';item.style.borderBottom='1px solid var(--border)';item.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;"><div><div style="font-weight:600;">${getWifiIcon(net.rssi)}${net.ssid}</div><div style="font-size:0.85rem;color:var(--text-muted);">${net.encrypted ? 'üîí Secured':'üîì Open'}‚Ä¢ ${net.rssi}dBm</div></div></div>`;item.onclick=()=>{document.getElementById('cfg-ssid').value=net.ssid;document.getElementById('cfg-pass').focus();};list.appendChild(item);});}function updateWifiBars(rssi){const wifiContainer=document.getElementById('nav-wifi');const bars=wifiContainer.querySelectorAll('.wifi-bar');let activeBars=0;let color='';if(rssi>=-50){activeBars=4;color='#00d9a5';}else if(rssi>=-60){activeBars=3;color='#7ed957';}else if(rssi>=-70){activeBars=2;color='#ffa726';}else if(rssi>=-80){activeBars=1;color='#ff8a65';}else{activeBars=0;color='#ff5252';}bars.forEach((bar,index)=>{if(index<activeBars){bar.classList.add('active');bar.style.background=color;}else{bar.classList.remove('active');bar.style.background='var(--text-muted)';}});wifiContainer.title='WiFi:'+rssi+' dBm('+(activeBars===4 ? 'Excellent':activeBars===3 ? 'Good':activeBars===2 ? 'Fair':activeBars===1 ? 'Weak':'Very Weak')+')';}function updateWifiBars(rssi){const wifiContainer=document.getElementById('nav-wifi');const bars=wifiContainer.querySelectorAll('.wifi-bar');let activeBars=0;let color='';if(rssi>=-50){activeBars=4;color='#00d9a5';}else if(rssi>=-60){activeBars=3;color='#7ed957';}else if(rssi>=-70){activeBars=2;color='#ffa726';}else if(rssi>=-80){activeBars=1;color='#ff8a65';}else{activeBars=0;color='#ff5252';}bars.forEach((bar,index)=>{if(index<activeBars){bar.classList.add('active');bar.style.background=color;}else{bar.classList.remove('active');bar.style.background='var(--text-muted)';}});wifiContainer.title='WiFi:'+rssi+' dBm('+(activeBars===4 ? 'Excellent':activeBars===3 ? 'Good':activeBars===2 ? 'Fair':activeBars===1 ? 'Weak':'Very Weak')+')';}function getWifiIcon(rssi){if(rssi>=-50)return 'üì∂';if(rssi>=-60)return 'üì∂';if(rssi>=-70)return 'üì∂';if(rssi>=-80)return 'üì∂';return '‚ö†Ô∏è';}function updateTzInput(){const select=document.getElementById('cfg-tz-select');const wrapper=document.getElementById('cfg-gmt-wrapper');const gmtInput=document.getElementById('cfg-gmt');if(select.value==='manual'){wrapper.style.display='block';}else if(select.value==='auto'){wrapper.style.display='none';if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{const lat=pos.coords.latitude;const lon=pos.coords.longitude;const tzOffset=Math.round(lon/15)*3600;gmtInput.value=tzOffset;document.getElementById('cfg-lat').value=lat.toFixed(6);document.getElementById('cfg-lon').value=lon.toFixed(6);});}}else{wrapper.style.display='none';const gmtValue=parseInt(select.value);gmtInput.value=gmtValue;sendWS({type:'set_timezone',gmt:gmtValue,dst:parseInt(document.getElementById('cfg-dst').value)||0});}}function setTempUnit(unit){tempUnit=unit;localStorage.setItem('tempUnit',tempUnit);const btnC=document.getElementById('btn-unit-c');const btnF=document.getElementById('btn-unit-f');if(unit==='C'){btnC.style.background='var(--primary)';btnC.style.color='white';btnF.style.background='transparent';btnF.style.color='var(--text)';}else{btnF.style.background='var(--primary)';btnF.style.color='white';btnC.style.background='transparent';btnC.style.color='var(--text)';}const unitSymbol=unit==='C' ? '¬∞C':'¬∞F';document.getElementById('temp-unit-display').innerText=unitSymbol;if(lastTemp!==null){document.getElementById('temp-display').innerText=formatTemp(lastTemp);}const outTemp=document.getElementById('out-temp').innerText;if(outTemp!=='--¬∞'&&lastWeatherData){sendWS({type:'refresh_weather'});}updateChartDisplay();sendWS({type:'config_unit',unit:unit.toLowerCase()});}function downloadLayout(){if(devices.length===0){alert('‚ö†Ô∏è No devices to backup. Add some icons first!');return;}const layoutData={version:'1.0',timestamp:new Date().toISOString(),devices:devices.map(d=>({id:d.id,type:d.type,name:d.name,x:d.x,y:d.y,x_mobile:d.x_mobile||d.x,y_mobile:d.y_mobile||d.y,rotation:d.rotation||0,rotation_mobile:d.rotation_mobile||d.rotation||0,ch:d.ch||0,enabled:d.enabled!==false,phys_type:d.phys_type||0,phys_addr:d.phys_addr||'',phys_pin:d.phys_pin||-1}))};const jsonStr=JSON.stringify(layoutData,null,2);const blob=new Blob([jsonStr],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`greenhouse-layout-${new Date().toISOString().split('T')[0]}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);alert('‚úì Layout backup downloaded!\n\nSave this file safely. You can restore it after uploadfs by manually re-arranging icons or sending layout via WebSocket.');}function restoreLayout(event){const file=event.target.files[0];if(!file){return;}if(!file.name.endsWith('.json')){alert('‚ùå Please select a valid JSON backup file');return;}const reader=new FileReader();reader.onload=(e)=>{try{const layoutData=JSON.parse(e.target.result);if(!layoutData.devices||!Array.isArray(layoutData.devices)){alert('‚ùå Invalid backup file format');return;}if(!confirm(`Restore ${layoutData.devices.length}devices from backup?\n\nTimestamp:${layoutData.timestamp||'Unknown'}\n\nThis will DELETE all current devices and restore from backup.`)){return;}devices.forEach(d=>{sendWS({type:'delete_device',id:d.id});});setTimeout(()=>{let deviceIdCounter=0;layoutData.devices.forEach((d,index)=>{setTimeout(()=>{sendWS({type:'create_device',type_id:d.type,x:d.x||50,y:d.y||50});setTimeout(()=>{const newDeviceId=deviceIdCounter++;sendWS({type:'update_device_physical',id:newDeviceId,name:d.name,x:d.x,y:d.y,x_mobile:d.x_mobile||d.x,y_mobile:d.y_mobile||d.y,rotation:d.rotation||0,rotation_mobile:d.rotation_mobile||d.rotation||0,channel:d.ch||0,phys_type:d.phys_type||0,phys_addr:d.phys_addr||'',phys_pin:d.phys_pin||-1,enabled:d.enabled!==false});},300);},index*500);});setTimeout(()=>{alert('‚úì Restore complete!Refreshing...');location.reload();},layoutData.devices.length*500+1500);},1000);}catch(error){alert('‚ùå Error reading backup file:'+error.message);}};reader.readAsText(file);event.target.value='';}socket.addEventListener('open',()=>{setTempUnit(tempUnit);});initSparkline();const storedFmt=localStorage.getItem('timeFormat');if(storedFmt){timeFormat=parseInt(storedFmt);document.getElementById('cfg-timefmt').value=timeFormat;}const storedUnit=localStorage.getItem('tempUnit');if(storedUnit){tempUnit=storedUnit;}(()=>{const map=document.getElementById('gh-map');let lastTap=0;map.addEventListener('touchend',(e)=>{const currentTime=new Date().getTime();const tapLength=currentTime-lastTap;if(tapLength<300&&tapLength>0){e.preventDefault();toggleFullscreen();}lastTap=currentTime;});})();</script></body></html>