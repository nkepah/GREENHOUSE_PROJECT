<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Version timestamp to force cache busting -->
    <meta name="version" content="2.14-202601311740">
    <title>üåæ Smart Farm Hub - Unified Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåæ</text></svg>">
    <style>
        :root {
            /* Core Colors */
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: #21262d;
            --bg-card-hover: #30363d;
            
            /* Inputs & Widgets */
            --widget-bg: rgba(255, 255, 255, 0.08); 
            --input-bg: rgba(0, 0, 0, 0.2);
            --badge-bg-success: rgba(78, 204, 163, 0.15);
            --badge-bg-error: rgba(248, 81, 73, 0.15);
            
            /* Accents */
            --accent: #4ecca3;
            --accent-blue: #58a6ff;
            --accent-orange: #f39c12;
            --accent-red: #f85149;
            --accent-yellow: #d29922;
            
            /* Text */
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            
            /* Borders & Graphics */
            --border: #30363d;
            --banner-gradient: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            transition: background 0.3s, color 0.3s;
        }
        
        /* Header */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background 0.3s, border-color 0.3s;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            font-size: 3.5rem;
            line-height: 1;
        }
        
        .logo h1 {
            font-size: 2rem;
            font-weight: 700;
            white-space: nowrap;
        }
        
        .logo span {
            color: var(--accent);
        }
        
        .header-status {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .clock-widget {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--widget-bg);
            padding: 6px 12px;
            border-radius: 30px;
            border: 1px solid var(--border);
        }

        .clock-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .clock-time {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1rem;
            letter-spacing: 0.5px;
        }

        .settings-btn {
            background: var(--widget-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
        }

        .settings-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            min-width: 260px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
            z-index: 1000;
            overflow: hidden;
        }

        .settings-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(10px);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: none;
            color: var(--text-primary);
            text-align: left;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: var(--bg-card-hover);
        }

        .dropdown-header {
            padding: 12px 16px 8px;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }
        
        .connection-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--badge-bg-success);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text-primary);
        }
        
        .connection-badge.offline {
            background: var(--badge-bg-error);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 2s infinite;
        }
        
        .status-dot.offline {
            background: var(--accent-red);
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Main Content */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        /* Weather Section */
        .weather-banner {
            background: var(--banner-gradient);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 24px;
            align-items: start;
            color: #fff; /* Always white text on banner */
        }
        
        .weather-current {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .weather-current .weather-icon {
            font-size: 3.5rem;
        }
        
        .weather-temp {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1;
        }
        
        .weather-banner .weather-details {
             color: rgba(255, 255, 255, 0.9);
             font-size: 0.95rem;
        }
        
        .weather-sun {
            text-align: center;
            padding: 0 24px;
            border-left: 1px solid rgba(255,255,255,0.2);
            border-right: 1px solid rgba(255,255,255,0.2);
        }
        
        .sun-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
            font-size: 0.9rem;
        }
        
        /* 24-Hour Hourly Forecast */
        .weather-forecast-hourly-container {
            grid-column: 1 / -1;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.2);
            overflow: hidden;
        }
        
        .weather-forecast-hourly {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 8px 0;
        }
        
        .hourly-card {
            flex: 0 0 auto;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px 12px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            min-width: 80px;
            white-space: normal;
        }
        
        .hourly-card:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }
        
        .hourly-time {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 6px;
            font-weight: 600;
            letter-spacing: 0.5px;
            min-height: 14px;
        }
        
        .hourly-time.now {
            color: #ffeb3b;
            font-weight: 700;
            font-size: 0.8rem;
        }
        
        .hourly-icon {
            font-size: 1.8rem;
            margin: 4px 0;
            display: block;
        }
        
        .hourly-temp {
            font-size: 0.9rem;
            font-weight: bold;
            color: #fff;
        }
        
        /* Scrollbar styling for hourly forecast */
        .weather-forecast-hourly::-webkit-scrollbar {
            height: 4px;
        }
        
        .weather-forecast-hourly::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }
        
        .weather-forecast-hourly::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }
        
        .weather-forecast-hourly::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }
        
        @media (max-width: 768px) {
            .weather-banner {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .weather-sun {
                padding: 0;
                border: none;
                border-bottom: 1px solid rgba(255,255,255,0.2);
                padding-bottom: 12px;
            }
            
            .hourly-card {
                min-width: 60px;
                padding: 10px 8px;
            }
            
            .hourly-icon {
                font-size: 1.5rem;
            }
        }
        
        /* Device Grid */
        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .section-title h2 {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .device-count {
            font-size: 0.85rem;
            color: var(--text-secondary);
            background: var(--bg-card);
            padding: 4px 12px;
            border-radius: 12px;
        }
        
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        
        /* Device Card */
        .device-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .device-card:hover {
            background: var(--bg-card-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        
        .device-card.offline {
            opacity: 0.6;
        }
        
        .device-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent);
        }
        
        .device-card.offline::before {
            background: var(--accent-red);
        }
        
        .device-card.greenhouse::before { background: var(--accent); }
        .device-card.coop::before { background: var(--accent-orange); }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .device-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .device-icon {
            font-size: 2rem;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .device-name {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .device-ip {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .device-status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(78, 204, 163, 0.15);
            color: var(--accent);
        }
        
        .device-status-badge.offline {
            background: rgba(248, 81, 73, 0.15);
            color: var(--accent-red);
        }
        
        .device-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .metric {
            text-align: center;
            padding: 12px 8px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        
        .metric-value {
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .metric-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-value.warning { color: var(--accent-yellow); }
        .metric-value.danger { color: var(--accent-red); }
        
        /* Quick Actions */
        .device-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .action-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .action-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent);
        }
        
        .action-btn.primary {
            background: var(--accent);
            color: #111;
            border-color: var(--accent);
        }
        
        .action-btn.primary:hover {
            filter: brightness(1.1);
        }
        
        /* Farm Features */
        .farm-features {
            background: linear-gradient(135deg, #1a4731 0%, #2d5a27 100%);
            border-radius: 16px;
            padding: 24px;
            margin-top: 32px;
        }
        
        .farm-features h3 {
            margin-bottom: 16px;
            font-size: 1.1rem;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255,255,255,0.1);
            padding: 12px 16px;
            border-radius: 8px;
        }
        
        .feature-icon {
            font-size: 1.5rem;
        }
        
        .feature-text {
            font-size: 0.9rem;
        }
        
        /* Footer */
        footer {
            max-width: 1400px;
            margin: 32px auto 0;
            padding: 24px;
            border-top: 1px solid var(--border);
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px 8px;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 24px;
        }
        
        /* Default state for mobile location (Hidden on Desktop) */
        #mobile-location-container {
            display: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .weather-banner {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .weather-sun {
                border: none;
                border-top: 1px solid var(--border);
                border-bottom: 1px solid var(--border);
                padding: 16px 0;
            }
            
            .sun-item {
                justify-content: center;
            }
            
            .devices-grid {
                grid-template-columns: 1fr;
            }
            
            .device-metrics {
                grid-template-columns: repeat(3, 1fr);
            }
            
            /* Mobile Header Adjustments */
            header {
                padding: 12px 16px;
            }
            
            .header-status {
                display: contents; /* Allows children to participate in parent grid */
            }

            .header-content {
                display: grid;
                grid-template-columns: 1fr auto;
                grid-template-rows: auto auto;
                grid-template-areas:
                    "logo settings"
                    "clock clock";
                row-gap: 8px;
                align-items: center;
            }

            .logo {
                grid-area: logo;
            }
            
            .settings-wrapper {
                grid-area: settings;
                justify-self: end;
            }

            .logo-icon {
                font-size: 2rem;
            }
            
            .logo h1 {
                font-size: 1.1rem;
            }

            #clock {
                grid-area: clock;
                display: flex !important;
                flex-wrap: nowrap !important; 
                gap: 5px;
                background: none !important;
                border: none !important;
                padding: 0 !important;
                margin-top: 4px;
                align-items: center;
                overflow: hidden;
                width: 100%;
            }
            
            /* Scale down for mobile */
            #clock .clock-time {
                font-size: 0.85rem !important;
                white-space: nowrap;
            }
            
            /* Show date again but smaller */
            #clock .clock-date {
                display: inline-block !important;
                font-size: 0.8rem !important;
                white-space: nowrap;
            }
            
            #mobile-location-container {
                display: inline-flex !important;
                margin-left: auto; /* Push to far right */
                font-size: 0.7rem !important;
                color: var(--text-secondary);
                background: var(--bg-card); 
                padding: 1px 4px;
                border: 1px solid var(--border);
                border-radius: 4px;
                align-items: center;
                gap: 2px;
                white-space: nowrap;
                flex-shrink: 0;
            }
            
            /* Pulsating glowing orange colon */
            .clock-colon {
                color: #ff8c00;
                font-weight: bold;
                animation: toggle-colon 1s infinite steps(2, start);
                display: inline-block;
            }
            
            .clock-number {
                color: #cccccc;
                background: radial-gradient(ellipse at center, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 70%);
                padding: 0 3px;
                border-radius: 3px;
                box-shadow: 0 0 10px rgba(255,255,255,0.4), inset 0 0 5px rgba(255,255,255,0.2);
                display: inline-block;
                text-shadow: 0 0 3px rgba(255,255,255,0.3);
            }
            
            @keyframes toggle-colon {
                0%, 50% {
                    opacity: 1;
                    text-shadow: 0 0 8px #ff8c00, 0 0 16px #ff6600, 0 0 24px #ff4500;
                }
                51%, 100% {
                    opacity: 0;
                    text-shadow: none;
                }
            }
        }
        
        @media (max-width: 768px) {
            #header-location {
                 display: none !important; 
            }
        }       
        
        /* Loading State */
            .settings-dropdown {
                position: fixed !important;
                top: auto !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                border-radius: 16px 16px 0 0;
                border: 1px solid var(--border);
                border-bottom: none;
                transform: translateY(100%);
                box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
                background: var(--bg-card);
                max-height: 80vh;
                overflow-y: auto;
                z-index: 9999;
                opacity: 0;
                visibility: hidden;
                transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s;
            }

            .settings-dropdown.show {
                transform: translateY(0) !important;
                opacity: 1 !important;
                visibility: visible !important;
            }
            
            /* Overlay for mobile dropdown */
            .settings-dropdown.show::before {
                content: '';
                position: fixed;
                top: -200vh; /* Extend far up */
                left: 0;
                right: 0;
                height: 300vh; /* Cover everything */
                background: rgba(0,0,0,0.6);
                z-index: -1;
                pointer-events: auto; /* Capture clicks to close */
            }
        }
        
        /* Loading State */
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 48px;
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Settings Modal Overlay Style */
        .settings-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .settings-modal-overlay.open {
            display: flex;
            animation: modalFadeIn 0.3s;
        }
        
        .settings-modal-box {
            background: var(--bg-card);
            width: 90%;
            max-width: 500px;
            height: auto;
            max-height: 85vh;
            border-radius: 20px;
            padding: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: modalSlideUp 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        @media (max-width: 768px) {
            .settings-modal-box {
                width: 85vw;
                max-width: 90%;
                margin: 0 10px;
            }
        }

        .settings-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex; 
            justify-content: space-between;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 700;
            background: rgba(255,255,255,0.03);
        }

        .settings-list {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            cursor: pointer;
            border-radius: 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .settings-item:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.1);
        }

        .settings-item span.icon {
            font-size: 1.4rem;
        }

        .settings-item div.text {
            flex: 1;
            font-size: 1rem;
            font-weight: 500;
        }
        
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalSlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Temperature Warning Animations */
        @keyframes frostPulse {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 0 8px rgba(100, 150, 255, 0.6));
            }
            50% {
                transform: scale(1.15);
                filter: drop-shadow(0 0 20px rgba(100, 150, 255, 1));
            }
        }

        @keyframes heatPulse {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 0 8px rgba(255, 100, 100, 0.8)) drop-shadow(0 0 16px rgba(255, 165, 0, 0.3));
            }
            50% {
                transform: scale(1.15);
                filter: drop-shadow(0 0 20px rgba(255, 50, 50, 1)) drop-shadow(0 0 30px rgba(255, 165, 0, 0.7));
            }
        }

        .temp-warning-banner {
            width: 100%;
            padding: 12px 20px;
            margin-top: 12px;
            background: rgba(100, 150, 255, 0.15);
            border: 2px solid rgba(100, 150, 255, 0.8);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 1.3rem;
            color: rgba(100, 200, 255, 1);
            font-weight: 700;
            white-space: nowrap;
            animation: frostPulse 1.5s ease-in-out infinite;
            backdrop-filter: blur(4px);
        }

        .temp-warning-banner.heat {
            background: rgba(255, 100, 50, 0.15);
            border: 2px solid rgba(255, 100, 50, 0.9);
            color: rgba(255, 150, 100, 1);
            animation: heatPulse 1.5s ease-in-out infinite;
        }

        /* Navigation Bar */
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">üåæ</span>
                <h1 id="farmName">Smart Farm <span>Hub</span></h1>
                
                <!-- NEW: Integrated Location Badge in Header -->
                <div id="header-location" onclick="openSettingsPage('location')" 
                     style="display:inline-flex; align-items:center; gap:5px; margin-left:15px; 
                            background:rgba(255,255,255,0.1); padding:4px 8px; border-radius:6px; 
                            font-size:0.8rem; cursor:pointer; vertical-align:middle; flex-shrink:0;">
                    <span>üìç</span>
                    <span id="header-city" style="white-space:nowrap;">--</span>
                </div>
            </div>
            <div class="header-status">
                <div id="clock" style="color: var(--text-primary); font-weight: 500;">--:--:--</div>
                
                <div class="settings-wrapper" style="position: relative;">
                    <button class="settings-btn" id="settingsBtn" onclick="toggleSettings(event)">‚öôÔ∏è</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Settings Menu Overlay -->
    <div id="settings-modal" class="settings-modal-overlay">
        <div class="settings-modal-box">
            <div class="settings-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button id="settings-back-btn" onclick="openSettingsPage('main')" style="display:none; background:none; border:none; color:var(--text-primary); font-size:1.2rem; cursor:pointer;">‚Üê</button>
                    <span id="settings-title">Settings</span>
                </div>
                <button onclick="toggleSettings()" style="background:none; border:none; color:var(--text-secondary); font-size:1.5rem; cursor:pointer;">‚úï</button>
            </div>
            
            <div class="settings-body" style="flex:1; overflow-y:auto;">
                <!-- MAIN MENU -->
                <div id="page-main" class="settings-page">
                    <div class="settings-list">
                        <div class="settings-item" onclick="openSettingsPage('units')">
                            <span class="icon">üìè</span>
                            <div class="text">Units & Date Format</div>
                            <span style="color:var(--text-secondary)">‚Ä∫</span>
                        </div>
                        <div class="settings-item" onclick="openSettingsPage('location')">
                            <span class="icon">üìç</span>
                            <div class="text">Location & Time Zone</div>
                            <span style="color:var(--text-secondary)">‚Ä∫</span>
                        </div>
                        <div class="settings-item" onclick="openSettingsPage('thresholds')">
                            <span class="icon">üå°Ô∏è</span>
                            <div class="text">Thresholds</div>
                            <span style="color:var(--text-secondary)">‚Ä∫</span>
                        </div>
                        <div class="settings-item" onclick="openSettingsPage('themes')">
                            <span class="icon">üé®</span>
                            <div class="text">Themes</div>
                            <span style="color:var(--text-secondary)">‚Ä∫</span>
                        </div>
                        <div style="height:1px; background:var(--border); margin:8px 10px;"></div>
                        <div class="settings-item" onclick="openSettingsPage('about')">
                            <span class="icon">‚ÑπÔ∏è</span>
                            <div class="text">About</div>
                            <span style="color:var(--text-secondary)">‚Ä∫</span>
                        </div>
                    </div>
                </div>

                <!-- UNITS PAGE -->
                <div id="page-units" class="settings-page" style="display:none; padding:20px;">
                    <div class="form-group" style="margin-bottom:20px;">
                        <label style="display:block; margin-bottom:8px; color:var(--text-secondary)">Temperature</label>
                        <select id="unit-temp" class="form-control" onchange="saveUnits()" style="width:100%; padding:10px; border-radius:8px; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-primary);">
                            <option value="C">Celsius (¬∞C)</option>
                            <option value="F">Fahrenheit (¬∞F)</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:20px;">
                        <label style="display:block; margin-bottom:8px; color:var(--text-secondary)">Wind Speed</label>
                        <select id="unit-speed" class="form-control" onchange="saveUnits()" style="width:100%; padding:10px; border-radius:8px; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-primary);">
                            <option value="kmh">Kilometers/hour (km/h)</option>
                            <option value="mph">Miles/hour (mph)</option>
                            <option value="ms">Meters/second (m/s)</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:20px;">
                        <label style="display:block; margin-bottom:8px; color:var(--text-secondary)">Pressure</label>
                        <select id="unit-pressure" class="form-control" onchange="saveUnits()" style="width:100%; padding:10px; border-radius:8px; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-primary);">
                            <option value="hpa">Hectopascal (hPa)</option>
                            <option value="inHg">Inches of Mercury (inHg)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display:block; margin-bottom:8px; color:var(--text-secondary)">Unit Date & Time Format</label>
                        <select id="unit-date" class="form-control" onchange="saveUnits()" style="width:100%; padding:10px; border-radius:8px; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-primary);">
                            <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display:block; margin-bottom:8px; color:var(--text-secondary)">Time Format</label>
                        <select id="unit-time" class="form-control" onchange="saveUnits()" style="width:100%; padding:10px; border-radius:8px; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-primary);">
                            <option value="12h">12-hour (12:30 PM)</option>
                            <option value="24h">24-hour (14:30)</option>
                        </select>
                    </div>
                </div>

                <!-- LOCATION PAGE -->
                <div id="page-location" class="settings-page" style="display:none; padding:20px;">
                    <div style="background:rgba(78, 204, 163, 0.1); border:1px solid var(--accent); padding:15px; border-radius:8px; margin-bottom:20px;">
                        <div id="location-display" style="font-weight:bold; color:var(--accent);">Detecting...</div>
                        <div id="timezone-display" style="font-size:0.9em; color:var(--text-secondary);">--</div>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                        <div>
                            <label style="display:block; font-size:0.8em; margin-bottom:5px; color:var(--text-secondary)">Latitude</label>
                            <input type="text" id="loc-lat" placeholder="0.0000" style="width:100%; padding:10px; border-radius:8px; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-primary);">
                        </div>
                        <div>
                            <label style="display:block; font-size:0.8em; margin-bottom:5px; color:var(--text-secondary)">Longitude</label>
                            <input type="text" id="loc-lon" placeholder="0.0000" style="width:100%; padding:10px; border-radius:8px; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-primary);">
                        </div>
                    </div>
                    
                    <button onclick="detectLocation()" style="width:100%; padding:12px; background:var(--accent); color:var(--bg-primary); border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-bottom:20px;">üìç Detect My Location</button>
                    
                    <div class="form-group" style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border);">
                        <label style="display:block; margin-bottom:8px; color:var(--text-secondary)">Time Zone</label>
                        <select id="loc-timezone" onchange="updateTimezone()" style="width:100%; padding:10px; border-radius:8px; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-primary);">
                            <option value="UTC">UTC</option>
                            <option value="Africa/Douala">Africa/Douala (WAT)</option>
                            <option value="Europe/Paris">Europe/Paris (CET)</option>
                            <option value="America/New_York">America/New_York (EST)</option>
                            <!-- More can be added -->
                        </select>
                        <p style="font-size:0.8em; color:var(--text-secondary); margin-top:8px;">
                            * System time will sync to this zone. Connected sensors will maintain sync via internal NTP.
                        </p>
                    </div>
                    <button onclick="saveLocation(event)" style="width:100%; padding:12px; background:var(--bg-card-hover); color:var(--text-primary); border:1px solid var(--border); border-radius:8px; font-weight:bold; cursor:pointer; margin-top:10px;">üíæ Save Coordinates</button>
                </div>

                <!-- THEMES PAGE -->
                <div id="page-themes" class="settings-page" style="display:none; padding:20px;">
                    <h4 style="margin-bottom:15px; color:var(--text-secondary)">Dark Themes</h4>
                    <div class="theme-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(80px, 1fr)); gap:10px; margin-bottom:25px;">
                        <button onclick="applyTheme('default')" data-theme="default" class="theme-btn" style="background:#0d1117; border:2px solid var(--accent); height:60px; border-radius:10px; cursor:pointer;" title="Default Dark"></button>
                        <button onclick="applyTheme('dark-ocean')" data-theme="dark-ocean" class="theme-btn" style="background:#0f172a; border:1px solid #38bdf8; height:60px; border-radius:10px; cursor:pointer;" title="Deep Ocean"></button>
                        <button onclick="applyTheme('dark-forest')" data-theme="dark-forest" class="theme-btn" style="background:#14532d; border:1px solid #4ade80; height:60px; border-radius:10px; cursor:pointer;" title="Forest Night"></button>
                        <button onclick="applyTheme('dark-purple')" data-theme="dark-purple" class="theme-btn" style="background:#3b0764; border:1px solid #c084fc; height:60px; border-radius:10px; cursor:pointer;" title="Nebula"></button>
                        <button onclick="applyTheme('dark-orange')" data-theme="dark-orange" class="theme-btn" style="background:#431407; border:1px solid #f97316; height:60px; border-radius:10px; cursor:pointer;" title="Sunset"></button>
                    </div>

                    <h4 style="margin-bottom:15px; color:var(--text-secondary)">Light Themes</h4>
                    <div class="theme-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(80px, 1fr)); gap:10px;">
                        <button onclick="applyTheme('light-default')" data-theme="light-default" class="theme-btn" style="background:#f8fafc; border:1px solid #94a3b8; height:60px; border-radius:10px; cursor:pointer;" title="Standard Light"></button>
                        <button onclick="applyTheme('light-blue')" data-theme="light-blue" class="theme-btn" style="background:#eff6ff; border:1px solid #3b82f6; height:60px; border-radius:10px; cursor:pointer;" title="Sky"></button>
                        <button onclick="applyTheme('light-green')" data-theme="light-green" class="theme-btn" style="background:#f0fdf4; border:1px solid #22c55e; height:60px; border-radius:10px; cursor:pointer;" title="Mint"></button>
                        <button onclick="applyTheme('light-solar')" data-theme="light-solar" class="theme-btn" style="background:#fefce8; border:1px solid #eab308; height:60px; border-radius:10px; cursor:pointer;" title="Warm Sun"></button>
                        <button onclick="applyTheme('light-lilac')" data-theme="light-lilac" class="theme-btn" style="background:#faf5ff; border:1px solid #a855f7; height:60px; border-radius:10px; cursor:pointer;" title="Lavender"></button>
                    </div>
                </div>

                <!-- THRESHOLDS PAGE -->
                <div id="page-thresholds" class="settings-page" style="display:none; padding:20px;">
                    <h3 style="margin-bottom:20px; color:var(--text-primary);">Temperature Alert Thresholds</h3>
                    
                    <div style="background:rgba(100, 150, 255, 0.1); border:1px solid rgba(100, 150, 255, 0.3); border-radius:8px; padding:16px; margin-bottom:20px;">
                        <h4 style="margin-bottom:12px; color:rgba(100, 200, 255, 1); display:flex; align-items:center; gap:8px;">
                            <span>‚ùÑÔ∏è</span> Frost Warning Threshold
                        </h4>
                        <div style="display:flex; gap:12px; align-items:flex-end;">
                            <div style="flex:1;">
                                <label style="display:block; margin-bottom:6px; font-size:0.9rem; color:var(--text-secondary);">Celsius (¬∞C)</label>
                                <input type="number" id="frostThreshold-c" placeholder="0" style="width:100%; padding:10px; border-radius:8px; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-primary);">
                            </div>
                            <div style="flex:1;">
                                <label style="display:block; margin-bottom:6px; font-size:0.9rem; color:var(--text-secondary);">Fahrenheit (¬∞F)</label>
                                <input type="number" id="frostThreshold-f" placeholder="32" style="width:100%; padding:10px; border-radius:8px; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-primary);">
                            </div>
                        </div>
                    </div>
                    
                    <div style="background:rgba(255, 100, 50, 0.1); border:1px solid rgba(255, 100, 50, 0.3); border-radius:8px; padding:16px; margin-bottom:20px;">
                        <h4 style="margin-bottom:12px; color:rgba(255, 150, 100, 1); display:flex; align-items:center; gap:8px;">
                            <span>üî•</span> Heat Warning Threshold
                        </h4>
                        <div style="display:flex; gap:12px; align-items:flex-end;">
                            <div style="flex:1;">
                                <label style="display:block; margin-bottom:6px; font-size:0.9rem; color:var(--text-secondary);">Celsius (¬∞C)</label>
                                <input type="number" id="heatThreshold-c" placeholder="35" style="width:100%; padding:10px; border-radius:8px; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-primary);">
                            </div>
                            <div style="flex:1;">
                                <label style="display:block; margin-bottom:6px; font-size:0.9rem; color:var(--text-secondary);">Fahrenheit (¬∞F)</label>
                                <input type="number" id="heatThreshold-f" placeholder="95" style="width:100%; padding:10px; border-radius:8px; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-primary);">
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="saveThresholds()" style="width:100%; padding:12px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:1rem;">
                        üíæ Save Thresholds
                    </button>
                </div>

                <!-- ABOUT PAGE -->
                <div id="page-about" class="settings-page" style="display:none; padding:20px;">
                    <div style="text-align:center; margin-bottom:20px;">
                        <div style="font-size:3rem; margin-bottom:10px;">üåæ</div>
                        <h2 style="margin-bottom:5px;">Smart Farm Hub</h2>
                        <div style="color:var(--text-secondary); font-size:0.9rem;">Version 2.0.1</div>
                    </div>
                    
                    <div style="background:var(--bg-primary); padding:20px; border-radius:12px; border:1px solid var(--border); line-height:1.6; color:var(--text-primary);">
                        <p style="margin-bottom:15px;">
                            Welcome to <strong>Our Organic Farm</strong> data center. This system manages the automated climate control, irrigation, and monitoring for our greenhouse and chicken coops.
                        </p>
                        <p style="margin-bottom:15px;">
                            <strong>Our Mission:</strong> To produce high-quality, sustainable food using advanced technology while respecting nature. We believe in transparency and precision agriculture.
                        </p>
                        <div style="border-top:1px solid var(--border); margin:15px 0; padding-top:10px;">
                            <strong>System Specs:</strong><br>
                            ‚Ä¢ Core: Raspberry Pi 4 (Server)<br>
                            ‚Ä¢ Nodes: ESP32 Microcontrollers<br>
                            ‚Ä¢ Network: Private Mesh<br>
                            ‚Ä¢ Protocol: WebSocket over WiFi
                        </div>
                    </div>
                    
                    <div style="text-align:center; margin-top:20px; color:var(--text-secondary); font-size:0.8rem;">
                        &copy; 2026 Smart Farm Hub. All rights reserved.
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <main>
        <!-- Weather Section -->
        <section class="weather-banner" id="weatherSection">
            <div class="weather-current">
                <div class="weather-icon" id="weatherIcon">üå§Ô∏è</div>
                <div>
                    <div id="weatherLocation" style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 4px;">üìç Location</div>
                    <div class="weather-temp"><span id="weatherTemp">--</span><span id="weatherTempUnit">¬∞C</span></div>
                    <div class="weather-details">
                        <div id="weatherDesc">Loading weather...</div>
                        <div>üíß <span id="weatherHumidity">--</span>% humidity</div>
                        <div>üí® <span id="windSpeed">-- km/h</span></div>
                    </div>
                </div>
            </div>
            <div class="weather-sun">
                <div class="sun-item">
                    <span>üåÖ</span>
                    <span>Sunrise: <strong id="sunrise">--:--</strong></span>
                </div>
                <div class="sun-item">
                    <span>üåá</span>
                    <span>Sunset: <strong id="sunset">--:--</strong></span>
                </div>
            </div>
            <!-- Temperature Warning Banner -->
            <div id="tempWarning" class="temp-warning-banner" style="display: none;">
                <span id="warningIcon">‚ùÑÔ∏è</span>
                <span id="warningText">FROST WARNING</span>
            </div>
            <!-- 24-Hour Hourly Forecast -->
            <div class="weather-forecast-hourly-container">
                <div class="weather-forecast-hourly" id="hourlyForecast">
                    <!-- Hourly cards will be populated here -->
                </div>
            </div>
        </section>
        
        <!-- Greenhouse Section -->
        <section>
            <div class="section-title">
                <h2>üå± Greenhouse</h2>
            </div>
            <div class="devices-grid" id="greenhouseDevices">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading devices...</p>
                </div>
            </div>
        </section>
        
        <!-- Chicken Coops Section -->
        <section>
            <div class="section-title">
                <h2>üêî Chicken Coops</h2>
                <span class="device-count"><span id="coopCount">0</span> coops</span>
            </div>
            <div class="devices-grid" id="coopDevices">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading devices...</p>
                </div>
            </div>
        </section>
        
        <!-- Farm Features -->
        <section class="farm-features">
            <h3>üåø Our Organic Farm</h3>
            <div class="features-grid">
                <div class="feature-item">
                    <span class="feature-icon">üêÑ</span>
                    <span class="feature-text">Grass-Fed Beef</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üêî</span>
                    <span class="feature-text">Free-Range Chickens</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ü•ö</span>
                    <span class="feature-text">Farm Fresh Eggs</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üêê</span>
                    <span class="feature-text">Grass-Fed Goats</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ü•¨</span>
                    <span class="feature-text">Organic Vegetables</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">‚òÄÔ∏è</span>
                    <span class="feature-text">Sustainable Farming</span>
                </div>
            </div>
        </section>
    </main>
    
    <footer>
        <p>Farm Hub Dashboard ‚Ä¢ Last updated: <span id="lastUpdate">--:--:--</span> | <span style="color: #4ecca3; font-weight: bold;">v2.3-LIVE</span></p>
    </footer>
    
    <!-- Device Detail Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Device Details</h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>
    
    <script>
        // Version 2.3 - Complete Settings Function Rewrite
        console.log('üåæ Farm Hub Dashboard v2.3-LIVE LOADED');
        console.log('showSettingsPage function:', typeof showSettingsPage);
        
        // ==== DECLARE ALL GLOBALS FIRST ====
        let devices = {};
        let weather = null;
        let ws = null;
        let userSettings = { units: { time: '24h', date: 'short' } }; // Store user settings

        // ==== DEFINE ALL FUNCTIONS IMMEDIATELY ====
        function showSettingsPage(pageId) {
            console.log('showSettingsPage called with pageId:', pageId);
            // Hide all pages
            document.querySelectorAll('.settings-page').forEach(page => {
                page.style.display = 'none';
            });
            
            // Show target page
            const target = document.getElementById('page-' + pageId);
            if (target) target.style.display = 'block';
            
            // Update Header
            const titleEl = document.getElementById('settings-title');
            const backBtn = document.getElementById('settings-back-btn');
            
            if (pageId === 'main') {
                if(titleEl) titleEl.textContent = 'Settings';
                if(backBtn) backBtn.style.display = 'none';
            } else {
                 if(backBtn) backBtn.style.display = 'block';
                 // Set title based on page
                 if(titleEl) {
                     if(pageId === 'units') titleEl.textContent = 'Units';
                     if(pageId === 'location') titleEl.textContent = 'Location';
                     if(pageId === 'themes') titleEl.textContent = 'Themes';
                     if(pageId === 'about') titleEl.textContent = 'About';
                 }
            }
        }
        
        function toggleSettings(event) {
            console.log('toggleSettings called, showSettingsPage is:', typeof showSettingsPage);
            if (event) event.stopPropagation();
            const modal = document.getElementById('settings-modal');
            
            if (modal.classList.contains('open')) {
                modal.classList.remove('open');
            } else {
                showSettingsPage('main');
                modal.classList.add('open');
                loadSettings();
            }
        }
        
        function openSettingsPage(pageId) {
            showSettingsPage(pageId);
        }
        
        // WebSocket connection
        function connectWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/ws`);
            
            ws.onopen = () => {
                updateConnectionStatus(true);
                ws.send(JSON.stringify({ type: 'get_status' }));
            };
            
            ws.onclose = () => {
                updateConnectionStatus(false);
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onmessage = (e) => {
                try {
                    const data = JSON.parse(e.data);
                    handleMessage(data);
                } catch (err) {
                    console.error('Parse error:', err);
                }
            };
        }
        
        function handleMessage(data) {
            switch (data.type) {
                case 'init':
                    if (data.farmName) {
                        document.getElementById('farmName').innerHTML = 
                            data.farmName.replace(/(\w+)$/, '<span>$1</span>');
                    }
                    if (data.devices) updateDevices(data.devices);
                    break;
                    
                case 'status':
                case 'status_update':
                    if (data.devices) updateDevices(data.devices);
                    break;
            }
        }
        
        function updateConnectionStatus(connected) {
            // UI elements removed, but we keep the function to avoid breaking listeners
            console.log('Connection status:', connected ? 'Online' : 'Offline');
        }
        
        // --- Smart Controller Settings System ---
        
        // Theme Definitions - Expanded for full UI coverage
        const themes = {
            'default': { 
                bg: '#0d1117', bgSec: '#161b22', card: '#21262d', border: '#30363d', 
                text: '#f0f6fc', textSec: '#8b949e', accent: '#4ecca3',
                widget: 'rgba(255,255,255,0.08)', input: 'rgba(0,0,0,0.3)',
                badgeSuccess: 'rgba(78, 204, 163, 0.15)', badgeError: 'rgba(248, 81, 73, 0.15)',
                banner: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)'
            },
            'dark-ocean': { 
                bg: '#0f172a', bgSec: '#1e293b', card: '#334155', border: '#475569', 
                text: '#f1f5f9', textSec: '#94a3b8', accent: '#38bdf8',
                widget: 'rgba(255,255,255,0.1)', input: 'rgba(0,0,0,0.25)',
                badgeSuccess: 'rgba(56, 189, 248, 0.15)', badgeError: 'rgba(248, 113, 113, 0.15)',
                banner: 'linear-gradient(135deg, #0c4a6e 0%, #0369a1 100%)'
            },
            'dark-forest': { 
                bg: '#022c22', bgSec: '#064e3b', card: '#065f46', border: '#115e59', 
                text: '#ecfdf5', textSec: '#6ee7b7', accent: '#34d399',
                widget: 'rgba(255,255,255,0.1)', input: 'rgba(0,0,0,0.25)',
                badgeSuccess: 'rgba(52, 211, 153, 0.2)', badgeError: 'rgba(248, 113, 113, 0.2)',
                banner: 'linear-gradient(135deg, #064e3b 0%, #047857 100%)'
            },
            'dark-purple': { 
                bg: '#2e1065', bgSec: '#4c1d95', card: '#5b21b6', border: '#6d28d9', 
                text: '#f3e8ff', textSec: '#d8b4fe', accent: '#c084fc',
                widget: 'rgba(255,255,255,0.1)', input: 'rgba(0,0,0,0.25)',
                badgeSuccess: 'rgba(192, 132, 252, 0.2)', badgeError: 'rgba(248, 113, 113, 0.2)',
                banner: 'linear-gradient(135deg, #4c1d95 0%, #6d28d9 100%)'
            },
            'dark-orange': { 
                bg: '#431407', bgSec: '#7c2d12', card: '#9a3412', border: '#c2410c', 
                text: '#fff7ed', textSec: '#fdba74', accent: '#fb923c',
                widget: 'rgba(255,255,255,0.1)', input: 'rgba(0,0,0,0.25)',
                badgeSuccess: 'rgba(251, 146, 60, 0.2)', badgeError: 'rgba(248, 113, 113, 0.2)',
                banner: 'linear-gradient(135deg, #7c2d12 0%, #c2410c 100%)'
            },
            'light-default': { 
                bg: '#f1f5f9', bgSec: '#ffffff', card: '#ffffff', border: '#cbd5e1', 
                text: '#0f172a', textSec: '#64748b', accent: '#0f172a',
                widget: '#e2e8f0', input: '#f8fafc',
                badgeSuccess: 'rgba(15, 23, 42, 0.1)', badgeError: 'rgba(220, 38, 38, 0.1)',
                banner: 'linear-gradient(135deg, #475569 0%, #1e293b 100%)'
            },
            'light-blue': { 
                bg: '#eff6ff', bgSec: '#bfdbfe', card: '#ffffff', border: '#93c5fd', 
                text: '#1e3a8a', textSec: '#3b82f6', accent: '#2563eb',
                widget: '#dbeafe', input: '#f0f9ff',
                badgeSuccess: 'rgba(37, 99, 235, 0.1)', badgeError: 'rgba(220, 38, 38, 0.1)',
                banner: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)'
            },
            'light-green': { 
                bg: '#f0fdf4', bgSec: '#bbf7d0', card: '#ffffff', border: '#86efac', 
                text: '#064e3b', textSec: '#22c55e', accent: '#16a34a',
                widget: '#dcfce7', input: '#f0fdf9',
                badgeSuccess: 'rgba(22, 163, 74, 0.1)', badgeError: 'rgba(220, 38, 38, 0.1)',
                banner: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)'
            },
            'light-lilac': { 
                bg: '#faf5ff', bgSec: '#e9d5ff', card: '#ffffff', border: '#d8b4fe', 
                text: '#581c87', textSec: '#9333ea', accent: '#7c3aed',
                widget: '#f3e8ff', input: '#faf5ff',
                badgeSuccess: 'rgba(124, 58, 237, 0.1)', badgeError: 'rgba(220, 38, 38, 0.1)',
                banner: 'linear-gradient(135deg, #a855f7 0%, #7c3aed 100%)'
            },
            'light-solar': { 
                bg: '#fffbeb', bgSec: '#fde68a', card: '#ffffff', border: '#fcd34d', 
                text: '#78350f', textSec: '#d97706', accent: '#d97706',
                widget: '#fef3c7', input: '#fffbeb',
                badgeSuccess: 'rgba(217, 119, 6, 0.1)', badgeError: 'rgba(220, 38, 38, 0.1)',
                banner: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'
            }
        };

        // ========================================
        // DO NOT REDEFINE - Already defined above!
        // ========================================
        
        function applyTheme(themeName, save = true) {
            const t = themes[themeName];
            if (!t) return;
            
            const root = document.documentElement;
            // Backgrounds
            root.style.setProperty('--bg-primary', t.bg);
            root.style.setProperty('--bg-secondary', t.bgSec || t.card); // Fallback
            root.style.setProperty('--bg-card', t.card);
            root.style.setProperty('--bg-card-hover', t.border); // Use lighter/darker border color for hover
            
            // UI Elements
            root.style.setProperty('--border', t.border);
            root.style.setProperty('--widget-bg', t.widget);
            root.style.setProperty('--input-bg', t.input);
            root.style.setProperty('--badge-bg-success', t.badgeSuccess);
            root.style.setProperty('--badge-bg-error', t.badgeError);
            root.style.setProperty('--banner-gradient', t.banner);
            
            // Text & Accents
            root.style.setProperty('--text-primary', t.text);
            root.style.setProperty('--text-secondary', t.textSec);
            root.style.setProperty('--accent', t.accent);
            
            // Persist to Server DB
            if (save) {
                fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key: 'theme', value: themeName })
                }).catch(e => console.error('Failed to save theme', e));
            }
            
            // Visualize selection
            document.querySelectorAll('.theme-btn').forEach(btn => {
                if(btn.dataset.theme === themeName) {
                    btn.style.borderColor = 'var(--text-primary)';
                    btn.style.transform = 'scale(1.05)';
                    btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                } else {
                    btn.style.borderColor = 'transparent';
                    btn.style.transform = 'scale(1)';
                    btn.style.boxShadow = 'none';
                }
            });
        }
        
        // Location Services
        function detectLocation() {
            const btn = document.querySelector('.detect-btn');
            const display = document.getElementById('location-display');
            const originalText = btn ? btn.textContent : 'üìç Detect My Location';
            
            if (!navigator.geolocation) {
                display.textContent = '‚ö†Ô∏è Geolocation not available. Enter coordinates manually.';
                if(btn) btn.textContent = originalText;
                return;
            }
            
            if(btn) btn.textContent = 'üõ∞Ô∏è Locating...';
            display.textContent = 'Acquiring GPS signal...';
            
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    const lat = pos.coords.latitude.toFixed(6);
                    const lon = pos.coords.longitude.toFixed(6);
                    
                    document.getElementById('loc-lat').value = lat;
                    document.getElementById('loc-lon').value = lon;
                    
                    // Auto-detect timezone
                    try {
                        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                        const select = document.getElementById('loc-timezone');
                        if (select.querySelector(`option[value="${tz}"]`)) {
                            select.value = tz;
                        }
                    } catch(e) { console.error('Timezone detect failed', e); }
                    
                    // Fetch Address
                    display.textContent = 'Fetching address...';
                    try {
                        const res = await fetch(`/api/geocode?lat=${lat}&lon=${lon}`);
                        if(res.ok) {
                            const data = await res.json();
                            const addr = `${data.city}, ${data.country}`;
                            display.textContent = 'üìç ' + addr;
                            window.detectedAddress = addr; 
                        } else {
                             display.textContent = 'Lat: ' + lat + ', Lon: ' + lon;
                        }
                    } catch(e) {
                        display.textContent = 'Lat: ' + lat + ', Lon: ' + lon;
                    }
                    
                    if(btn) btn.textContent = originalText;
                },
                (err) => {
                    console.error('Geolocation error:', err);
                    let msg = '‚ùå Location detection failed: ';
                    if (err.code === 1) msg += 'Permission denied. Requires HTTPS for security.';
                    else if (err.code === 2) msg += 'Position unavailable.';
                    else if (err.code === 3) msg += 'Timeout - try again.';
                    else msg += err.message;
                    
                    display.textContent = msg;
                    console.warn(msg);
                    
                    if(btn) btn.textContent = originalText;                    alert(`${msg}\n\nError: ${err.message}\n\nPlease enter coordinates manually.`);
                    
                    if(btn) btn.textContent = originalText;
                    display.textContent = 'Location detection failed';
                },
                { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }
            );
        }
        
        function updateTimezone() {
            const tz = document.getElementById('loc-timezone').value;
            console.log('Timezone changed to:', tz);
            // This will be saved when saveLocation() is called
        }
        
        async function saveLocation(event) {
            const lat = document.getElementById('loc-lat').value;
            const lon = document.getElementById('loc-lon').value;
            const display = document.getElementById('location-display');
            
            // Try to fetch address if not present or changed
            let address = window.detectedAddress || 'Custom Location';
            if (lat && lon) {
                 try {
                     const res = await fetch(`/api/geocode?lat=${lat}&lon=${lon}`);
                     if (res.ok) {
                         const data = await res.json();
                         // Use cityComponent which already includes City, State format
                         address = data.cityComponent || data.city || 'Location';
                         
                         // Update display
                         if(display) display.textContent = 'üìç ' + address;
                         window.detectedAddress = address;
                     }
                 } catch(e) { console.log('Address lookup failed', e); }
            }

            const config = {
                lat: lat,
                lon: lon,
                timezone: document.getElementById('loc-timezone').value,
                address: address
            };
            
            try {
                // Save to Server DB
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key: 'location', value: config })
                });
                
                // Visual feedback
                const btn = event ? event.target : document.querySelector('#page-location button:last-child');
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ Saved';
                    setTimeout(() => btn.textContent = originalText, 1500);
                }
            } catch(e) {
                alert('Failed to save settings: ' + e.message);
            }
        }

        // Persistence
        async function loadSettings() {
            try {
                const res = await fetch(`/api/settings?v=${Math.random()}`);
                if (!res.ok) throw new Error('Failed to fetch settings');
                const settings = await res.json();
                
                // Theme
                if (settings.theme) applyTheme(settings.theme, false); // false = don't save again
                
                // Location - Always re-geocode to get fresh address
                if (settings.location) {
                    const loc = typeof settings.location === 'string' ? JSON.parse(settings.location) : settings.location;
                    if(document.getElementById('loc-lat')) document.getElementById('loc-lat').value = loc.lat || '';
                    if(document.getElementById('loc-lon')) document.getElementById('loc-lon').value = loc.lon || '';
                    if(document.getElementById('loc-timezone')) document.getElementById('loc-timezone').value = loc.timezone || 'UTC';
                    userSettings.timezone = loc.timezone || 'UTC'; // Store timezone globally
                    
                    // Always fetch fresh address from geocode endpoint
                    if (loc.lat && loc.lon && document.getElementById('location-display')) {
                        try {
                            const geoRes = await fetch(`/api/geocode?lat=${loc.lat}&lon=${loc.lon}`);
                            if (geoRes.ok) {
                                const geoData = await geoRes.json();
                                const address = geoData.cityComponent || geoData.city || 'Location';
                                document.getElementById('location-display').textContent = 'üìç ' + address;
                                window.detectedAddress = address;
                            }
                        } catch(e) { console.log('Fresh geocode failed, using stored:', e); }
                    }
                }
                
                // Units
                if (settings.units) {
                    const units = typeof settings.units === 'string' ? JSON.parse(settings.units) : settings.units;
                    userSettings.units = units; // Store in global
                    ['temp', 'speed', 'pressure', 'date', 'time'].forEach(key => {
                        const el = document.getElementById(`unit-${key}`);
                        if (el && units[key]) el.value = units[key];
                    });
                    updateClock(); // Refresh clock with new format
                }
            } catch (err) {
                console.warn('Could not load settings from server, falling back to local defaults', err);
            }
        }
        
        async function saveUnits() {
            const units = {
                temp: document.getElementById('unit-temp').value,
                speed: document.getElementById('unit-speed').value,
                pressure: document.getElementById('unit-pressure').value,
                date: document.getElementById('unit-date').value,
                time: document.getElementById('unit-time').value
            };
            
            // Update global settings immediately for instant UI response
            userSettings.units = units;
            
            // Update UI immediately with new units
            updateClock(); // Refresh clock display with new format
            
            // CONVERSION SOURCE 2: Unit change detected
            // Fetch from cache and re-convert with new unit preference
            try {
                const response = await fetch(`/api/weather-convert?v=${Math.random()}`);
                if (response.ok) {
                    const data = await response.json();
                    // Update weather display with new unit conversion
                    if (data.weather) {
                        updateWeather(data.weather, data.daily, data.hourly, weather?.location);
                    }
                }
            } catch (err) {
                console.error('Weather re-conversion failed:', err);
            }
            
            // Save to database in background (don't block UI)
            fetch('/api/settings', {
                 method: 'POST',
                 headers: {'Content-Type': 'application/json'},
                 body: JSON.stringify({ key: 'units', value: units })
            })
            .then(res => {
                if (res.ok) {
                    console.log('‚úì Units saved');
                    // Show success notification
                    const notification = document.createElement('div');
                    notification.textContent = '‚úÖ Units updated';
                    notification.style.cssText = 'position:fixed; top:20px; right:20px; background:#4ecca3; color:#0d1117; padding:10px 15px; border-radius:5px; z-index:9999;';
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 1500);
                }
            })
            .catch(e => console.error('Save failed:', e));
        }
        
        // Load and save temperature thresholds
        async function loadThresholds() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                
                const thresholds = data.thresholds || {
                    frost_c: 0,
                    frost_f: 32,
                    heat_c: 35,
                    heat_f: 95
                };
                
                document.getElementById('frostThreshold-c').value = thresholds.frost_c;
                document.getElementById('frostThreshold-f').value = thresholds.frost_f;
                document.getElementById('heatThreshold-c').value = thresholds.heat_c;
                document.getElementById('heatThreshold-f').value = thresholds.heat_f;
                
                // Store in global for warning detection
                userSettings.thresholds = thresholds;
            } catch (err) {
                console.error('Failed to load thresholds:', err);
            }
        }
        
        async function saveThresholds() {
            const thresholds = {
                frost_c: parseFloat(document.getElementById('frostThreshold-c').value) || 0,
                frost_f: parseFloat(document.getElementById('frostThreshold-f').value) || 32,
                heat_c: parseFloat(document.getElementById('heatThreshold-c').value) || 35,
                heat_f: parseFloat(document.getElementById('heatThreshold-f').value) || 95
            };
            
            // Update global settings immediately
            userSettings.thresholds = thresholds;
            
            // Save to database
            fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ key: 'thresholds', value: thresholds })
            })
            .then(res => {
                if (res.ok) {
                    console.log('‚úì Thresholds saved:', thresholds);
                    // Show success notification
                    const notification = document.createElement('div');
                    notification.textContent = '‚úÖ Thresholds saved successfully';
                    notification.style.cssText = 'position:fixed; top:20px; right:20px; background:#4ecca3; color:#0d1117; padding:10px 15px; border-radius:5px; z-index:9999;';
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 1500);
                }
            })
            .catch(e => console.error('Failed to save thresholds:', e));
        }
        
        // Initializer
        document.addEventListener('DOMContentLoaded', () => {
             loadSettings();
             // Close modal check
             document.getElementById('settings-modal').addEventListener('click', (e) => {
                 if (e.target.id === 'settings-modal') toggleSettings();
             });
        });
        
        // Fetch initial data
        async function fetchDashboardData() {
            try {
                const response = await fetch(`/api/dashboard?v=${Math.random()}`);
                const data = await response.json();
                
                if (data.farmName) {
                    document.getElementById('farmName').innerHTML = 
                        data.farmName.replace(/(\w+)$/, '<span>$1</span>');
                    document.title = `üåæ ${data.farmName}`;
                }

                // Update Header Location
                if (data.location) {
                    const loc = data.location;
                    // Prefer address if available (from DB settings), otherwise fallback to city
                    let displayLoc = loc.address || loc.city || 'Unknown';
                    
                    // Logic to shorten long addresses is now handled by server/client save logic.
                    // If displayLoc is already formatted as "City, State", we just use it.
                    // But if it's the raw OpenStreetMap display_name (very long), we might want to trunc.
                    
                    // If the address is super long (> 40 chars), try to take first 2 parts
                    if (displayLoc.length > 40 && displayLoc.includes(',')) {
                         const parts = displayLoc.split(',');
                         if (parts.length >= 2) {
                             displayLoc = parts[0].trim() + ', ' + parts[1].trim();
                         }
                    }
                    
                    // Update the header element which feeds the clock
                    const headCity = document.getElementById('header-city');
                    if(headCity) headCity.textContent = displayLoc;
                }
                
                // Store weather data globally for unit changes
                if (data.weather) {
                    weather = {
                        current: data.weather,
                        daily: data.daily,
                        hourly: data.hourly,
                        location: data.location
                    };
                    updateWeather(data.weather, data.daily, data.hourly, data.location);
                }
                if (data.devices) renderDevices(data.devices);
                
                document.getElementById('lastUpdate').innerHTML = 
                    `<span class="clock-number">${now.getHours().toString().padStart(2, '0')}</span><span class="clock-colon">:</span><span class="clock-number">${now.getMinutes().toString().padStart(2, '0')}</span><span class="clock-colon">:</span><span class="clock-number">${now.getSeconds().toString().padStart(2, '0')}</span>`;
                    
                    
            } catch (err) {
                console.error('Failed to fetch dashboard:', err);
            }
        }
        
        // No conversion needed - server provides pre-converted temperatures
        function convertTemp(temp) {
            // Temperatures are already converted on server side
            // This function now just returns the temperature as-is
            return Math.round(temp);
        }
        
        // Weather display
        function updateWeather(current, daily, hourly, location) {
            if (!current) return;
            
            const tempUnit = userSettings?.units?.temp || 'C';
            const tempSymbol = tempUnit === 'F' ? '¬∞F' : '¬∞C';
            
            // Display location
            if (location) {
                const locDisplay = location.address || location.cityComponent || location.city || 'Unknown Location';
                document.getElementById('weatherLocation').textContent = 'üìç ' + locDisplay;
            }
            
            // Get temperature - data comes pre-converted from server
            // temperature_2m field has the correct unit (C or F) based on preferred_unit
            let displayTemp = current.temperature_2m || 0;
            
            // Use the first hourly data point if available (should be current time)
            // This ensures the main temperature matches the "Now" card
            if (hourly && hourly.temperature_2m_c && hourly.temperature_2m_c.length > 0) {
                // Use the appropriate temperature array based on unit
                if (tempUnit === 'F' && hourly.temperature_2m_f) {
                    displayTemp = hourly.temperature_2m_f[0];
                } else if (hourly.temperature_2m_c) {
                    displayTemp = hourly.temperature_2m_c[0];
                }
            }
            
            document.getElementById('weatherTemp').textContent = 
                Math.round(displayTemp);
            document.getElementById('weatherTempUnit').textContent = tempSymbol;
            document.getElementById('weatherHumidity').textContent = 
                current.relative_humidity_2m || '--';
            
            // Display wind speed with correct unit from API response
            const windSpeedUnit = current.wind_speed_unit || 'km/h';
            document.getElementById('windSpeed').textContent = 
                (current.wind_speed_10m || '--') + ' ' + windSpeedUnit;
            
            // Check for temperature warnings (Frost/Heat) using saved thresholds
            const warningEl = document.getElementById('tempWarning');
            const warningIcon = document.getElementById('warningIcon');
            const warningText = document.getElementById('warningText');
            
            // Get thresholds from saved settings or use defaults
            const thresholds = userSettings?.thresholds || {
                frost_c: 0,
                frost_f: 32,
                heat_c: 35,
                heat_f: 95
            };
            
            // Determine which threshold to use based on current temperature unit
            const tempThreshold = tempUnit === 'F' ? thresholds.frost_f : thresholds.frost_c;
            const heatThreshold = tempUnit === 'F' ? thresholds.heat_f : thresholds.heat_c;
            const roundedTemp = Math.round(displayTemp);
            
            if (roundedTemp <= tempThreshold) {
                // Frost warning
                warningEl.classList.remove('heat');
                warningIcon.textContent = '‚ùÑÔ∏è';
                warningText.textContent = 'FROST WARNING';
                warningEl.style.display = 'flex';
                warningEl.title = `Frost Warning: Temperature at or below ${tempThreshold}${tempSymbol}!`;
            } else if (roundedTemp >= heatThreshold) {
                // Heat warning
                warningEl.classList.add('heat');
                warningIcon.textContent = 'üî•';
                warningText.textContent = 'HEAT WARNING';
                warningEl.style.display = 'flex';
                warningEl.title = `Heat Warning: Temperature at or above ${heatThreshold}${tempSymbol}!`;
            } else {
                // No warning
                warningEl.style.display = 'none';
            }
            
            // Weather icon based on code
            const code = current.weather_code;
            document.getElementById('weatherIcon').textContent = getWeatherIcon(code);
            document.getElementById('weatherDesc').textContent = getWeatherDesc(code);
            
            // Update hourly forecast for next 24 hours
            if (hourly && hourly.time && hourly.temperature_2m_c && hourly.temperature_2m_f) {
                const container = document.getElementById('hourlyForecast');
                container.innerHTML = ''; // Clear existing cards
                
                // Get current time in user's timezone to find starting index
                const timezone = userSettings.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
                const now = new Date();
                
                // Create formatter for timezone time
                const tzFormatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: timezone,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                
                // Get current time parts in selected timezone
                const nowParts = tzFormatter.formatToParts(now);
                let currentHour, currentDate, currentMonth, currentYear;
                nowParts.forEach(part => {
                    if (part.type === 'hour') currentHour = parseInt(part.value);
                    if (part.type === 'day') currentDate = parseInt(part.value);
                    if (part.type === 'month') currentMonth = parseInt(part.value); // formatToParts returns 1-indexed months
                    if (part.type === 'year') currentYear = parseInt(part.value);
                });
                
                // Find the index of the current hour in the API data
                let startIndex = 0;
                for (let i = 0; i < hourly.time.length; i++) {
                    // Format each API time in the selected timezone
                    const apiDate = new Date(hourly.time[i]);
                    const apiParts = tzFormatter.formatToParts(apiDate);
                    let apiHour, apiDate_day, apiMonth, apiYear;
                    apiParts.forEach(part => {
                        if (part.type === 'hour') apiHour = parseInt(part.value);
                        if (part.type === 'day') apiDate_day = parseInt(part.value);
                        if (part.type === 'month') apiMonth = parseInt(part.value);
                        if (part.type === 'year') apiYear = parseInt(part.value);
                    });
                    
                    if (apiHour === currentHour &&
                        apiDate_day === currentDate &&
                        apiMonth === currentMonth &&
                        apiYear === currentYear) {
                        startIndex = i;
                        break;
                    }
                }
                
                // Display 24 hourly cards starting from current hour
                for (let i = 0; i < 24; i++) {
                    const apiIndex = startIndex + i;
                    if (apiIndex >= hourly.time.length) break; // Stop if we run out of data
                    
                    const forecastTime = new Date(hourly.time[apiIndex]);
                    
                    // Format forecast time in user's timezone
                    const forecastParts = tzFormatter.formatToParts(forecastTime);
                    let forecastHour, forecastMinute;
                    forecastParts.forEach(part => {
                        if (part.type === 'hour') forecastHour = part.value;
                        if (part.type === 'minute') forecastMinute = part.value;
                    });
                    
                    // Use pre-converted temperature data from server
                    const tempUnit = userSettings?.units?.temp || 'C';
                    let temp;
                    if (tempUnit === 'F' && hourly.temperature_2m_f) {
                        temp = Math.round(hourly.temperature_2m_f[apiIndex]);
                    } else if (hourly.temperature_2m_c) {
                        temp = Math.round(hourly.temperature_2m_c[apiIndex]);
                    } else {
                        temp = 0;
                    }
                    
                    const code = hourly.weather_code?.[apiIndex] || 0;
                    
                    // Determine time label
                    let timeLabel = '';
                    
                    // Check if this is the current hour
                    const isCurrentHour = (i === 0); // First card is always "Now"
                    
                    if (isCurrentHour) {
                        timeLabel = 'Now';
                    } else {
                        // Get user's time format setting for hourly display
                        const timeFormat = userSettings.units?.time || '24h';
                        if (timeFormat === '12h') {
                            let hour12 = parseInt(forecastHour) % 12 || 12;
                            const ampm = parseInt(forecastHour) >= 12 ? 'PM' : 'AM';
                            timeLabel = `${hour12}:${forecastMinute}${ampm}`;
                        } else {
                            // Show time in 24h format
                            timeLabel = `${forecastHour}:${forecastMinute}`;
                        }
                    }
                    
                    const timeClass = isCurrentHour ? 'now' : '';
                    
                    const card = document.createElement('div');
                    card.className = 'hourly-card';
                    card.innerHTML = `
                        <div class="hourly-time ${timeClass}">${timeLabel}</div>
                        <div class="hourly-icon">${getWeatherIcon(code)}</div>
                        <div class="hourly-temp">${temp}${tempSymbol}</div>
                    `;
                    container.appendChild(card);
                }
            }
            
            // Sunrise/Sunset from daily data
            if (daily && daily.sunrise?.[0]) {
                const sr = new Date(daily.sunrise[0]);
                document.getElementById('sunrise').textContent = 
                    sr.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            if (daily && daily.sunset?.[0]) {
                const ss = new Date(daily.sunset[0]);
                document.getElementById('sunset').textContent = 
                    ss.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
        }
        
        function getWeatherIcon(code) {
            // WMO Weather codes mapping to emojis (comprehensive)
            const iconMap = {
                0: '‚òÄÔ∏è',      // Clear sky
                1: 'üå§Ô∏è',      // Mainly clear
                2: '‚õÖ',      // Partly cloudy
                3: '‚òÅÔ∏è',      // Overcast
                45: 'üå´Ô∏è',     // Foggy
                48: 'üå´Ô∏è',     // Depositing rime fog
                51: 'üåßÔ∏è',     // Light drizzle
                53: 'üåßÔ∏è',     // Moderate drizzle
                55: 'üåßÔ∏è',     // Dense drizzle
                61: 'üåßÔ∏è',     // Slight rain
                63: 'üåßÔ∏è',     // Moderate rain
                65: 'üåßÔ∏è',     // Heavy rain
                71: 'üå®Ô∏è',     // Slight snow
                73: 'üå®Ô∏è',     // Moderate snow
                75: 'üå®Ô∏è',     // Heavy snow
                77: 'üå®Ô∏è',     // Snow grains
                80: 'üå¶Ô∏è',     // Slight rain showers
                81: 'üå¶Ô∏è',     // Moderate rain showers
                82: 'üå¶Ô∏è',     // Violent rain showers
                85: 'üå®Ô∏è',     // Slight snow showers
                86: 'üå®Ô∏è',     // Heavy snow showers
                95: '‚õàÔ∏è',     // Thunderstorm
                96: '‚õàÔ∏è',     // Thunderstorm with slight hail
                99: '‚õàÔ∏è'      // Thunderstorm with heavy hail
            };
            
            // Check if code exists in map, otherwise try to determine by range
            if (iconMap.hasOwnProperty(code)) {
                return iconMap[code];
            }
            
            // Fallback: determine by code ranges for any unmapped codes
            if (code >= 71 && code <= 86) {
                // All 70-86 range codes are snow/snow showers
                if ((code >= 71 && code <= 77) || (code >= 85 && code <= 86)) {
                    return 'üå®Ô∏è'; // Snow icon
                }
            }
            
            // Default to cloud
            return '‚òÅÔ∏è';
        }
        
        function getWeatherDesc(code) {
            // WMO Weather codes descriptions (comprehensive)
            const descMap = {
                0: 'Clear sky',
                1: 'Mainly clear',
                2: 'Partly cloudy',
                3: 'Overcast',
                45: 'Foggy',
                48: 'Depositing rime fog',
                51: 'Light drizzle',
                53: 'Moderate drizzle',
                55: 'Dense drizzle',
                61: 'Slight rain',
                63: 'Moderate rain',
                65: 'Heavy rain',
                71: 'Slight snow',
                73: 'Moderate snow',
                75: 'Heavy snow',
                77: 'Snow grains',
                80: 'Slight rain showers',
                81: 'Moderate rain showers',
                82: 'Violent rain showers',
                85: 'Slight snow showers',
                86: 'Heavy snow showers',
                95: 'Thunderstorm',
                96: 'Thunderstorm with slight hail',
                99: 'Thunderstorm with heavy hail'
            };
            
            // Return mapped description or default
            return descMap[code] || 'Weather data';
        }
        
        // Device rendering
        function renderDevices(devicesData) {
            devices = devicesData;
            
            const greenhouseContainer = document.getElementById('greenhouseDevices');
            const coopContainer = document.getElementById('coopDevices');
            
            let greenhouseHTML = '';
            let coopHTML = '';
            let coopCount = 0;
            
            for (const [id, device] of Object.entries(devicesData)) {
                const card = createDeviceCard(id, device);
                
                if (device.type === 'greenhouse') {
                    greenhouseHTML += card;
                } else if (device.type === 'coop') {
                    coopHTML += card;
                    coopCount++;
                }
            }
            
            greenhouseContainer.innerHTML = greenhouseHTML || '<p style="color: var(--text-secondary)">No greenhouse devices configured</p>';
            coopContainer.innerHTML = coopHTML || '<p style="color: var(--text-secondary)">No coop devices configured</p>';
            document.getElementById('coopCount').textContent = coopCount;
        }
        
        function createDeviceCard(id, device) {
            const status = device.status || {};
            const online = status.online !== false;
            const type = device.type || 'unknown';
            
            const icon = type === 'greenhouse' ? 'üå±' : 'üêî';
            const temp = status.temperature !== undefined ? status.temperature.toFixed(1) : '--';
            const humidity = status.humidity !== undefined ? status.humidity : '--';
            const activeDevices = status.active_devices !== undefined ? status.active_devices : '--';
            
            // Extra metrics for coops
            let extraMetrics = '';
            if (type === 'coop') {
                const door = status.door === 'open' ? 'üîì Open' : 'üîí Closed';
                const feed = status.feed_level !== undefined ? status.feed_level + '%' : '--';
                extraMetrics = `
                    <div class="metric">
                        <div class="metric-value">${door}</div>
                        <div class="metric-label">Door</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value ${status.feed_level < 20 ? 'warning' : ''}">${feed}</div>
                        <div class="metric-label">Feed</div>
                    </div>
                `;
            }
            
            return `
                <div class="device-card ${type} ${online ? '' : 'offline'}" onclick="openDevice('${id}')">
                    <div class="device-header">
                        <div class="device-info">
                            <div class="device-icon">${icon}</div>
                            <div>
                                <div class="device-name">${device.name}</div>
                                <div class="device-ip">${device.ip}</div>
                            </div>
                        </div>
                        <div class="device-status-badge ${online ? '' : 'offline'}">
                            <div class="status-dot ${online ? '' : 'offline'}"></div>
                            ${online ? 'Online' : 'Offline'}
                        </div>
                    </div>
                    <div class="device-metrics">
                        <div class="metric">
                            <div class="metric-value">${temp}¬∞C</div>
                            <div class="metric-label">Temp</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${humidity}%</div>
                            <div class="metric-label">Humidity</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${activeDevices}</div>
                            <div class="metric-label">Active</div>
                        </div>
                        ${extraMetrics}
                    </div>
                    <div class="device-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); openDeviceUI('${id}')">
                            üñ•Ô∏è Open UI
                        </button>
                        <button class="action-btn primary" onclick="event.stopPropagation(); refreshDevice('${id}')">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
            `;
        }
        
        function updateDevices(devicesUpdate) {
            for (const [id, status] of Object.entries(devicesUpdate)) {
                if (devices[id]) {
                    devices[id].status = status;
                }
            }
            renderDevices(devices);
        }
        
        // Device actions
        function openDevice(deviceId) {
            const device = devices[deviceId];
            if (!device) return;
            
            document.getElementById('modalTitle').textContent = device.name;
            document.getElementById('modalBody').innerHTML = `
                <p><strong>IP Address:</strong> ${device.ip}</p>
                <p><strong>Type:</strong> ${device.type}</p>
                <p><strong>Status:</strong> ${device.status?.online ? 'Online' : 'Offline'}</p>
                <hr style="margin: 16px 0; border-color: var(--border)">
                <p style="color: var(--text-secondary)">
                    Click "Open UI" to access the full device control panel.
                </p>
            `;
            document.getElementById('modalOverlay').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }
        
        function openDeviceUI(deviceId) {
            const device = devices[deviceId];
            if (device) {
                window.open(`/device/${deviceId}/`, '_blank');
            }
        }
        
        function refreshDevice(deviceId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'refresh' }));
            }
            fetchDashboardData();
        }
        




        // Clock
        function updateClock() {
            const now = new Date();
            const timezone = userSettings.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            // Format time in selected timezone
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: timezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            const parts = formatter.formatToParts(now);
            const tzTime = {};
            parts.forEach(part => {
                if (part.type !== 'literal') {
                    tzTime[part.type] = part.value;
                }
            });
            
            // Get user's date format setting
            const dateFormat = userSettings.units?.date || 'short';
            let dateStr;
            if (dateFormat === 'short') {
                dateStr = now.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
            } else {
                dateStr = now.toLocaleDateString('en-GB', { weekday: 'short', day: '2-digit', month: '2-digit', year: '2-digit' });
            }
            
            // Get user's time format setting
            const timeFormat = userSettings.units?.time || '24h';
            let timeStr, hourStr, minuteStr;
            
            const tzHour = parseInt(tzTime.hour);
            const tzMinute = tzTime.minute;
            
            if (timeFormat === '12h') {
                let hour12 = tzHour % 12 || 12;
                hourStr = hour12.toString().padStart(2, '0');
                const ampm = tzHour >= 12 ? 'PM' : 'AM';
                minuteStr = tzMinute;
                timeStr = `${hourStr}${minuteStr}${ampm}`;
            } else {
                hourStr = tzHour.toString().padStart(2, '0');
                minuteStr = tzMinute;
                timeStr = `${hourStr}${minuteStr}`;
            }
            
            const clockEl = document.getElementById('clock');
            
            // Get current location text from the header badge
            const cityEl = document.getElementById('header-city');
            const currentLoc = cityEl ? cityEl.textContent : '--';

            if (clockEl) {
                // Use class for styling instead of inline
                clockEl.className = 'clock-widget';
                if (timeFormat === '12h') {
                    const hour12 = tzHour % 12 || 12;
                    const ampm = now.getHours() >= 12 ? 'PM' : 'AM';
                    clockEl.innerHTML = `
                        <span class="clock-date">${dateStr}</span>
                        <span class="clock-time"><span class="clock-number">${hour12.toString().padStart(2, '0')}</span><span class="clock-colon">:</span><span class="clock-number">${minuteStr}</span><small style="margin-left:2px;">${ampm}</small></span>
                        <!-- Mobile only location display (controlled by CSS) -->
                        <div id="mobile-location-container" onclick="openSettingsPage('location')">
                            üìç <span>${currentLoc}</span>
                        </div>
                    `;
                } else {
                    clockEl.innerHTML = `
                        <span class="clock-date">${dateStr}</span>
                        <span class="clock-time"><span class="clock-number">${hourStr}</span><span class="clock-colon">:</span><span class="clock-number">${minuteStr}</span></span>
                        <!-- Mobile only location display (controlled by CSS) -->
                        <div id="mobile-location-container" onclick="openSettingsPage('location')">
                            üìç <span>${currentLoc}</span>
                        </div>
                    `;
                }
            }
            console.log('[CLOCK] Updated with format:', timeFormat, dateFormat);
        }

        // Initialize
        async function syncUnitsToDatabase() {
            try {
                const units = userSettings.units || {
                    temp: document.getElementById('unit-temp')?.value || 'celsius',
                    speed: document.getElementById('unit-speed')?.value || 'kmh',
                    pressure: document.getElementById('unit-pressure')?.value || 'hpa',
                    date: document.getElementById('unit-date')?.value || 'short',
                    time: document.getElementById('unit-time')?.value || '24h'
                };
                
                // Sync to database
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key: 'units', value: units })
                });
                
                console.log('[SYNC] Units synced to database:', units);
            } catch(e) {
                console.error('[SYNC] Failed to sync units:', e.message);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            fetchDashboardData();
            connectWebSocket();
            updateClock();
            loadSettings(); // Load settings first
            setInterval(updateClock, 1000);
            setInterval(fetchDashboardData, 2500); // Refresh every 2.5 seconds (async/await handles priority)
            setInterval(syncUnitsToDatabase, 10000); // Sync units every 10 seconds for ESP32 routines
        });
        
        // Close modal on overlay click
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeModal();
        });
        
        // Escape key closes modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
