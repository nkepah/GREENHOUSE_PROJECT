<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><meta name="theme-color" content="#0a0e1a"><title>Alerts-Greenhouse OS</title><style>:root{--bg:#0a0e1a;--surface:#151b2e;--surface-elevated:#1f2739;--primary:#4f7cff;--success:#00d9a5;--danger:#ff4757;--warning:#ffa726;--text:#f8fafc;--text-secondary:#cbd5e1;--text-muted:#94a3b8;--border:rgba(148,163,184,0.12);--shadow-md:0 4px 16px rgba(0,0,0,0.25);}*{box-sizing:border-box;margin:0;padding:0;}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(135deg,#0a0e1a 0%,#1a1f35 100%);color:var(--text);padding:0;min-height:100vh;display:flex;flex-direction:column;}nav{background:rgba(21,27,46,0.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(148,163,184,0.12);padding:0.875rem 1.25rem;display:flex;justify-content:space-between;align-items:center;height:64px;box-shadow:0 4px 16px rgba(0,0,0,0.25);position:sticky;top:0;z-index:10000;}@media(max-width:768px){nav{padding:0.5rem 0.75rem;height:56px;}}.brand{font-size:1.25rem;font-weight:700;background:linear-gradient(135deg,#00d9a5,#00b386);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-transform:uppercase;letter-spacing:0.075em;display:flex;align-items:center;cursor:pointer;transition:transform 0.3s;text-decoration:none;}@media(max-width:768px){.brand{font-size:1rem;}}.brand:hover{transform:scale(1.05);}main{padding:16px;max-width:900px;margin:0 auto;width:100%;flex:1;}@media(min-width:768px){main{padding:20px;}}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.05);flex-wrap:wrap;gap:12px;}.header h1{font-size:1.5rem;background:linear-gradient(135deg,#25D366,#128C7E);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}@media(min-width:768px){.header h1{font-size:2rem;}}.btn{padding:10px 18px;border-radius:12px;border:none;font-weight:600;cursor:pointer;transition:all 0.2s;font-size:0.9rem;}.btn-primary{background:linear-gradient(135deg,#4f7cff,#7c3aed);color:white;}.btn-success{background:linear-gradient(135deg,#00d9a5,#00b386);color:white;}.btn-danger{background:linear-gradient(135deg,#ff4757,#d63447);color:white;}.btn-whatsapp{background:linear-gradient(135deg,#25D366,#128C7E);color:white;}.btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);}.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px;}.card-header{font-size:1.1rem;font-weight:600;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;}.toggle-switch{position:relative;display:inline-block;width:48px;height:26px;}.toggle-switch input{opacity:0;width:0;height:0;}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--surface-elevated);border:2px solid var(--border);transition:all 0.3s;border-radius:26px;}.slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;bottom:2px;background:var(--text-muted);transition:all 0.3s;border-radius:50%;}input:checked+.slider{background:var(--success);border-color:var(--success);}input:checked+.slider:before{transform:translateX(22px);background:white;}.form-group{margin-bottom:12px;}.form-label{display:block;margin-bottom:6px;color:var(--text-muted);font-size:0.85rem;}.form-input{width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.95rem;}.form-input:focus{outline:none;border-color:var(--primary);}.contact-item{background:var(--surface-elevated);border-radius:12px;padding:12px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;gap:10px;}.contact-info{flex:1;}.contact-name{font-weight:600;}.contact-phone{font-size:0.85rem;color:var(--text-muted);}.alert-type-item{background:var(--surface-elevated);border-radius:10px;padding:10px 12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;gap:10px;}.alert-type-info{flex:1;}.alert-type-name{font-weight:500;font-size:0.9rem;}.alert-type-desc{font-size:0.75rem;color:var(--text-muted);}.priority-badge{font-size:0.7rem;padding:2px 6px;border-radius:4px;font-weight:600;}.priority-low{background:rgba(100,200,255,0.2);color:#64C8FF;}.priority-medium{background:rgba(255,167,38,0.2);color:#ffa726;}.priority-high{background:rgba(255,71,87,0.2);color:#ff4757;}.priority-critical{background:rgba(255,0,0,0.3);color:#FF5555;}.tabs{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:8px;}.tab{padding:8px 16px;background:var(--surface-elevated);border:1px solid var(--border);border-radius:20px;cursor:pointer;font-size:0.85rem;white-space:nowrap;transition:all 0.2s;}.tab.active{background:var(--primary);border-color:var(--primary);color:white;}.tab:hover:not(.active){border-color:var(--primary);}.tab-content{display:none;}.tab-content.active{display:block;}.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px;}.status-connected{background:var(--success);box-shadow:0 0 8px var(--success);}.status-disconnected{background:var(--danger);}.info-box{background:rgba(79,124,255,0.1);border:1px solid rgba(79,124,255,0.3);border-radius:10px;padding:12px;margin-bottom:16px;font-size:0.85rem;color:var(--text-secondary);}.stat-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);}.stat-row:last-child{border-bottom:none;}.stat-label{color:var(--text-muted);}.stat-value{font-weight:600;}.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:1000;}.modal-overlay.open{display:flex;}.modal-box{background:var(--surface);border-radius:16px;padding:20px;width:90%;max-width:400px;max-height:80vh;overflow-y:auto;}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}.modal-header h3{font-size:1.1rem;}.close-btn{background:none;border:none;color:var(--text);font-size:1.5rem;cursor:pointer;}</style></head><body><nav><div class="brand" onclick="window.location.href='/'" title="Back to Home">ğŸŒ± Greenhouse OS</div><div style="flex:1;"></div></nav><main><h1>ğŸ“± Alerts&Notifications</h1><div style="display:flex;gap:10px;"><button class="btn btn-success" onclick="testAlert()">ğŸ”” Test Alert</button><a href="/" class="btn btn-primary">â† Back</a></div></div><div class="card" style="background:linear-gradient(135deg,rgba(37,211,102,0.1),rgba(18,140,126,0.05));"><div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;"><span style="font-size:2rem;">ğŸ“²</span><div><div style="font-weight:600;font-size:1.1rem;">WhatsApp Notifications</div><div style="font-size:0.85rem;color:var(--text-muted);">Medium+alerts via CallMeBot</div></div><label class="toggle-switch" style="margin-left:auto;"><input type="checkbox" id="alerts-enabled" onchange="toggleAlertsEnabled()"><span class="slider"></span></label></div><div class="info-box" style="margin-bottom:0;"><strong>How to get your API key:</strong><br>1. Add<strong>+34 644 91 98 03</strong>to your phone contacts<br>2. Send "I allow callmebot to send me messages" to this number via WhatsApp<br>3. You'll receive your API key in a few minutes<br><a href="https://www.callmebot.com/blog/free-api-whatsapp-messages/" target="_blank" style="color:var(--primary);">Learn more â†’</a></div></div><div class="card" style="background:linear-gradient(135deg,rgba(0,136,204,0.1),rgba(0,88,153,0.05));"><div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;"><span style="font-size:2rem;">âœˆï¸</span><div><div style="font-weight:600;font-size:1.1rem;">Telegram Notifications</div><div style="font-size:0.85rem;color:var(--text-muted);">All alerts via Telegram Bot</div></div><span id="telegram-count" style="margin-left:auto;background:rgba(0,136,204,0.2);padding:4px 10px;border-radius:12px;font-size:0.8rem;">0 bots</span></div><div class="info-box" style="margin-bottom:0;"><strong>How to set up Telegram:</strong><br>1. Open Telegram and search for<strong>@BotFather</strong><br>2. Send<strong>/newbot</strong>and follow the instructions<br>3. Copy the bot token you receive<br>4. Start a chat with your bot and send any message<br>5. Get your Chat ID from<a href="https://t.me/userinfobot" target="_blank" style="color:var(--primary);">@userinfobot</a></div></div><div class="tabs"><div class="tab active" onclick="switchTab('contacts')">ğŸ‘¥ WhatsApp</div><div class="tab" onclick="switchTab('telegram')">âœˆï¸ Telegram</div><div class="tab" onclick="switchTab('alerts')">ğŸ”” Alert Types</div><div class="tab" onclick="switchTab('history')">ğŸ“Š History</div></div><div id="tab-contacts" class="tab-content active"><div class="card"><div class="card-header"><span>WhatsApp Contacts</span><button class="btn btn-whatsapp" style="padding:6px 12px;font-size:0.8rem;" onclick="openAddContactModal()">+Add</button></div><div id="contacts-list"><div style="text-align:center;padding:20px;color:var(--text-muted);">Loading contacts...</div></div></div></div><div id="tab-telegram" class="tab-content"><div class="card"><div class="card-header"><span>Telegram Bots</span><button class="btn btn-primary" style="padding:6px 12px;font-size:0.8rem;background:linear-gradient(135deg,#0088cc,#005899);" onclick="openAddTelegramModal()">+Add Bot</button></div><div id="telegram-list"><div style="text-align:center;padding:20px;color:var(--text-muted);">Loading Telegram bots...</div></div></div><div class="info-box"><strong>ğŸ’¡ Why Telegram?</strong><br>â€¢ Free with no message limits<br>â€¢ Official API,more reliable<br>â€¢ Receives ALL alerts by default<br>â€¢ WhatsApp receives Medium+priority only</div></div><div id="tab-alerts" class="tab-content"><div class="card"><div class="card-header">Environment Alerts</div><div id="env-alerts-list"></div></div><div class="card"><div class="card-header">ğŸŒ¡ï¸ Temperature Sensors</div><div id="temp-alerts-list"></div></div><div class="card"><div class="card-header">Frost Warnings</div><div id="frost-alerts-list"></div></div><div class="card"><div class="card-header">System Alerts</div><div id="system-alerts-list"></div></div><div class="card"><div class="card-header">Device Alerts</div><div id="device-alerts-list"></div></div></div><div id="tab-history" class="tab-content"><div class="card"><div class="card-header">Alert Statistics</div><div id="alert-stats"><div class="stat-row"><span class="stat-label">Alerts sent today</span><span class="stat-value" id="stat-today">0</span></div><div class="stat-row"><span class="stat-label">Alerts this hour</span><span class="stat-value" id="stat-hour">0</span></div><div class="stat-row"><span class="stat-label">Last alert</span><span class="stat-value" id="stat-last">Never</span></div></div></div><div class="card"><div class="card-header">Recent Alerts</div><div id="recent-alerts"><div style="text-align:center;padding:20px;color:var(--text-muted);">No recent alerts</div></div></div></div><div id="add-contact-modal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><h3>Add WhatsApp Contact</h3><button class="close-btn" onclick="closeModal('add-contact-modal')">Ã—</button></div><div class="form-group"><label class="form-label">Contact Name</label><input type="text" id="new-contact-name" class="form-input" placeholder="e.g.,John's Phone"></div><div class="form-group"><label class="form-label">Phone Number(with country code)</label><div style="display:flex;gap:8px;"><select id="country-code" class="form-input" style="width:110px;"><option value="+1">ğŸ‡ºğŸ‡¸+1</option><option value="+27">ğŸ‡¿ğŸ‡¦+27</option><option value="+44">ğŸ‡¬ğŸ‡§+44</option><option value="+91">ğŸ‡®ğŸ‡³+91</option><option value="+234">ğŸ‡³ğŸ‡¬+234</option><option value="+254">ğŸ‡°ğŸ‡ª+254</option><option value="+263">ğŸ‡¿ğŸ‡¼+263</option><option value="+267">ğŸ‡§ğŸ‡¼+267</option><option value="+61">ğŸ‡¦ğŸ‡º+61</option><option value="+49">ğŸ‡©ğŸ‡ª+49</option><option value="+33">ğŸ‡«ğŸ‡·+33</option><option value="+55">ğŸ‡§ğŸ‡·+55</option><option value="+86">ğŸ‡¨ğŸ‡³+86</option></select><input type="tel" id="new-contact-phone" class="form-input" style="flex:1;" placeholder="821234567" oninput="formatPhoneInput(this)"></div><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Enter number without leading zero</div></div><div class="form-group"><label class="form-label">CallMeBot API Key</label><input type="text" id="new-contact-apikey" class="form-input" placeholder="e.g.,1234567"><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;"><a href="#" onclick="openWhatsAppForKey()" style="color:var(--success);">ğŸ“² Tap here to get API key via WhatsApp</a></div></div><div class="form-group"><label class="form-label">Minimum Priority Level</label><select id="new-contact-priority" class="form-input"><option value="0">ğŸ“¬ All Alerts</option><option value="1">ğŸ“¢ Medium&Above</option><option value="2">âš ï¸ High&Critical</option><option value="3">ğŸš¨ Critical Only</option></select></div><button class="btn btn-whatsapp" style="width:100%;" onclick="addContact()">Add Contact</button></div></div><div id="add-telegram-modal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><h3>Add Telegram Bot</h3><button class="close-btn" onclick="closeModal('add-telegram-modal')">Ã—</button></div><div class="form-group"><label class="form-label">Bot Name</label><input type="text" id="new-telegram-name" class="form-input" placeholder="e.g.,Greenhouse Bot"></div><div class="form-group"><label class="form-label">Bot Token</label><input type="text" id="new-telegram-token" class="form-input" placeholder="e.g.,123456789:ABCdef..."><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Get this from<a href="https://t.me/BotFather" target="_blank" style="color:var(--primary);">@BotFather</a></div></div><div class="form-group"><label class="form-label">Chat ID</label><input type="text" id="new-telegram-chatid" class="form-input" placeholder="e.g.,123456789"><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Get this from<a href="https://t.me/userinfobot" target="_blank" style="color:var(--primary);">@userinfobot</a></div></div><div class="form-group"><label class="form-label">Minimum Priority Level</label><select id="new-telegram-priority" class="form-input"><option value="0" selected>ğŸ“¬ All Alerts(Recommended)</option><option value="1">ğŸ“¢ Medium&Above</option><option value="2">âš ï¸ High&Critical</option><option value="3">ğŸš¨ Critical Only</option></select></div><button class="btn btn-primary" style="width:100%;background:linear-gradient(135deg,#0088cc,#005899);" onclick="addTelegramBot()">Add Telegram Bot</button></div></div><div id="edit-alert-modal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><h3 id="edit-alert-title">Edit Alert</h3><button class="close-btn" onclick="closeModal('edit-alert-modal')">Ã—</button></div><input type="hidden" id="edit-alert-type"><div class="form-group"><label class="form-label">Cooldown(minutes)</label><input type="number" id="edit-alert-cooldown" class="form-input" min="0" max="1440"><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Time between repeated alerts of the same type</div></div><div class="form-group"><label class="form-label">Max Alerts Per Hour</label><input type="number" id="edit-alert-maxhour" class="form-input" min="0" max="60"></div><div class="form-group" id="threshold-group" style="display:none;"><label class="form-label">Threshold Value</label><input type="number" id="edit-alert-threshold" class="form-input" step="0.1"></div><div class="form-group"><label class="form-label">Trigger Routine(optional)</label><select id="edit-alert-routine" class="form-input"><option value="">None</option></select><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Automatically start a routine when this alert fires</div></div><button class="btn btn-primary" style="width:100%;" onclick="saveAlertConfig()">Save Configuration</button></div></div><script>let socket;let alertsConfig={enabled:false,contacts:[],alerts:{}};let routinesList=[];const alertTypes={env:[{type:0,name:'Temperature Anomaly',desc:'Temp 30%+above/below threshold',priority:2,hasThreshold:true},{type:1,name:'Unexpected Current',desc:'Device drawing unexpected power',priority:2},{type:12,name:'Humidity High',desc:'Humidity above threshold',priority:1,hasThreshold:true},{type:13,name:'Humidity Low',desc:'Humidity below threshold',priority:1,hasThreshold:true},{type:14,name:'Power Anomaly',desc:'Unusual power consumption',priority:2},],temp:[{type:20,name:'Sensor Offline',desc:'Temperature sensor not responding',priority:2},{type:21,name:'Sensor Online',desc:'Temperature sensor back online',priority:1},{type:22,name:'High Warning',desc:'Temperature above warning threshold',priority:1,hasThreshold:true},{type:23,name:'High Critical',desc:'Temperature critically high',priority:3,hasThreshold:true},{type:24,name:'Low Warning',desc:'Temperature below warning threshold',priority:1,hasThreshold:true},{type:25,name:'Low Critical',desc:'Temperature critically low',priority:3,hasThreshold:true},{type:26,name:'Rapid Rise',desc:'Temperature rising too quickly',priority:2,hasThreshold:true},{type:27,name:'Rapid Drop',desc:'Temperature dropping too quickly',priority:2,hasThreshold:true},{type:28,name:'Erratic Sensor',desc:'Sensor showing unstable readings',priority:2},{type:29,name:'Zone Imbalance',desc:'Large temp difference between zones',priority:1,hasThreshold:true},],frost:[{type:2,name:'Frost Warning 12h',desc:'Frost expected in 12 hours',priority:1},{type:3,name:'Frost Warning 2h',desc:'Frost expected in 2 hours',priority:2},{type:4,name:'Frost Warning 30m',desc:'Frost expected in 30 minutes',priority:3},{type:5,name:'Frost Now',desc:'Temperature at freezing point',priority:3},],system:[{type:8,name:'Connection Lost',desc:'Internet connection down',priority:2},{type:9,name:'Connection Restored',desc:'Internet connection restored',priority:0},{type:10,name:'Sensor Failure',desc:'Sensor not responding',priority:2},{type:17,name:'System Reboot',desc:'Device has rebooted',priority:1},{type:18,name:'Daily Summary',desc:'Daily status report',priority:0},],device:[{type:6,name:'Routine Triggered',desc:'Automation routine started',priority:0},{type:7,name:'Routine Completed',desc:'Automation routine finished',priority:0},{type:11,name:'Relay State Change',desc:'Device turned on/off',priority:0},{type:16,name:'Lamp Extended On',desc:'Light on for extended time',priority:1},{type:15,name:'Water Leak',desc:'Water leak detected',priority:3},{type:19,name:'Door Open',desc:'Door open for extended time',priority:1},]};const priorityNames=['Low','Medium','High','Critical'];const priorityClasses=['priority-low','priority-medium','priority-high','priority-critical'];function connectWebSocket(){socket=new WebSocket(`ws://${window.location.host}/ws`);socket.onopen=()=>{console.log('WebSocket connected');requestAlertsConfig();requestRoutines();};socket.onclose=()=>{console.log('WebSocket disconnected,reconnecting...');setTimeout(connectWebSocket,3000);};socket.onmessage=handleMessage;}function handleMessage(event){const data=JSON.parse(event.data);if(data.type==='alerts_config'){alertsConfig=data;renderAll();}else if(data.type==='routines_list'){routinesList=data.routines||[];populateRoutinesDropdown();}}function sendWS(msg){if(socket&&socket.readyState===WebSocket.OPEN){socket.send(JSON.stringify(msg));}}function requestAlertsConfig(){sendWS({type:'get_alerts_config'});}function requestRoutines(){sendWS({type:'get_routines'});}function renderAll(){document.getElementById('alerts-enabled').checked=alertsConfig.enabled;renderContacts();renderTelegramBots();renderAlertTypes('env','env-alerts-list');renderAlertTypes('temp','temp-alerts-list');renderAlertTypes('frost','frost-alerts-list');renderAlertTypes('system','system-alerts-list');renderAlertTypes('device','device-alerts-list');const telegramCount=(alertsConfig.telegram||[]).length;document.getElementById('telegram-count').textContent=telegramCount+' bot'+(telegramCount!==1 ? 's':'');}function renderContacts(){const container=document.getElementById('contacts-list');const contacts=alertsConfig.contacts||[];if(contacts.length===0){container.innerHTML=`<div style="text-align:center;padding:20px;color:var(--text-muted);">No contacts added yet.<br><small>Add a WhatsApp contact to receive alerts.</small></div>`;return;}container.innerHTML=contacts.map((c,i)=>`<div class="contact-item"><label class="toggle-switch"><input type="checkbox" ${c.enabled ? 'checked':''}onchange="toggleContact(${i})"><span class="slider"></span></label><div class="contact-info"><div class="contact-name">${c.name||'Contact '+(i+1)}</div><div class="contact-phone">${c.phone}</div><div style="font-size:0.75rem;color:var(--text-muted);">${priorityNames[c.minPriority||0]}+priority</div></div><button class="btn btn-danger" style="padding:6px 10px;font-size:0.75rem;" onclick="removeContact(${i})">ğŸ—‘ï¸</button></div>`).join('');}function renderTelegramBots(){const container=document.getElementById('telegram-list');const bots=alertsConfig.telegram||[];if(bots.length===0){container.innerHTML=`<div style="text-align:center;padding:20px;color:var(--text-muted);">No Telegram bots added yet.<br><small>Add a Telegram bot to receive ALL alerts.</small></div>`;return;}container.innerHTML=bots.map((bot,i)=>`<div class="contact-item" style="border-left:3px solid #0088cc;"><label class="toggle-switch"><input type="checkbox" ${bot.enabled ? 'checked':''}onchange="toggleTelegramBot(${i})"><span class="slider"></span></label><div class="contact-info"><div class="contact-name">âœˆï¸ ${bot.name||'Bot '+(i+1)}</div><div class="contact-phone">Chat ID:${bot.chatId}</div><div style="font-size:0.75rem;color:var(--text-muted);">${priorityNames[bot.minPriority||0]}+priority</div></div><button class="btn btn-danger" style="padding:6px 10px;font-size:0.75rem;" onclick="removeTelegramBot(${i})">ğŸ—‘ï¸</button></div>`).join('');}function renderAlertTypes(category,containerId){const container=document.getElementById(containerId);const types=alertTypes[category];container.innerHTML=types.map(at=>{const config=alertsConfig.alerts?.[at.type]||{enabled:true,cooldown:30,maxPerHour:5};return `<div class="alert-type-item"><label class="toggle-switch"><input type="checkbox" ${config.enabled ? 'checked':''}onchange="toggleAlertType(${at.type})"><span class="slider"></span></label><div class="alert-type-info" onclick="openEditAlertModal(${at.type})" style="cursor:pointer;"><div class="alert-type-name">${at.name}</div><div class="alert-type-desc">${at.desc}</div></div><span class="priority-badge ${priorityClasses[at.priority]}">${priorityNames[at.priority]}</span></div>`;}).join('');}function populateRoutinesDropdown(){const select=document.getElementById('edit-alert-routine');select.innerHTML='<option value="">None</option>';routinesList.forEach(r=>{const opt=document.createElement('option');opt.value=r.name;opt.textContent=r.name;select.appendChild(opt);});}function switchTab(tab){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));const tabPositions={contacts:1,telegram:2,alerts:3,history:4};document.querySelector(`.tab:nth-child(${tabPositions[tab]||1})`).classList.add('active');document.getElementById('tab-'+tab).classList.add('active');}function toggleAlertsEnabled(){const enabled=document.getElementById('alerts-enabled').checked;sendWS({type:'update_alerts_config',enabled:enabled});}function toggleContact(index){const contacts=alertsConfig.contacts||[];if(contacts[index]){contacts[index].enabled=!contacts[index].enabled;sendWS({type:'update_alerts_config',contacts:contacts});}}function toggleTelegramBot(index){const bots=alertsConfig.telegram||[];if(bots[index]){bots[index].enabled=!bots[index].enabled;sendWS({type:'update_alerts_config',telegram:bots});}}function toggleAlertType(type){const alerts=alertsConfig.alerts||{};if(!alerts[type])alerts[type]={enabled:true,cooldown:30,maxPerHour:5};alerts[type].enabled=!alerts[type].enabled;sendWS({type:'update_alert_setting',alertType:type,config:alerts[type]});}function openAddContactModal(){document.getElementById('new-contact-name').value='';document.getElementById('new-contact-phone').value='';document.getElementById('new-contact-apikey').value='';document.getElementById('new-contact-priority').value='0';document.getElementById('country-code').value='+1';document.getElementById('add-contact-modal').classList.add('open');}function formatPhoneInput(input){let value=input.value.replace(/[^\d]/g,'');if(value.startsWith('0')){value=value.substring(1);}input.value=value;}function openWhatsAppForKey(){const message=encodeURIComponent('I allow callmebot to send me messages');const phone='34644919803';window.open(`https://wa.me/${phone}?text=${message}`,'_blank');}function addContact(){const name=document.getElementById('new-contact-name').value.trim();const countryCode=document.getElementById('country-code').value;let phoneNumber=document.getElementById('new-contact-phone').value.trim();const apiKey=document.getElementById('new-contact-apikey').value.trim();const minPriority=parseInt(document.getElementById('new-contact-priority').value);if(!phoneNumber||!apiKey){alert('Phone number and API key are required');return;}phoneNumber=phoneNumber.replace(/[^\d]/g,'');const fullPhone=countryCode+phoneNumber;sendWS({type:'add_alert_contact',phone:fullPhone,apiKey:apiKey,name:name||'Contact',minPriority:minPriority});closeModal('add-contact-modal');}function removeContact(index){if(confirm('Remove this contact?')){const contacts=alertsConfig.contacts||[];if(contacts[index]){sendWS({type:'remove_alert_contact',phone:contacts[index].phone});}}}function openAddTelegramModal(){document.getElementById('new-telegram-name').value='';document.getElementById('new-telegram-token').value='';document.getElementById('new-telegram-chatid').value='';document.getElementById('new-telegram-priority').value='0';document.getElementById('add-telegram-modal').classList.add('open');}function addTelegramBot(){const name=document.getElementById('new-telegram-name').value.trim();const botToken=document.getElementById('new-telegram-token').value.trim();const chatId=document.getElementById('new-telegram-chatid').value.trim();const minPriority=parseInt(document.getElementById('new-telegram-priority').value);if(!botToken||!chatId){alert('Bot Token and Chat ID are required');return;}sendWS({type:'add_telegram_bot',botToken:botToken,chatId:chatId,name:name||'Telegram Bot',minPriority:minPriority});closeModal('add-telegram-modal');}function removeTelegramBot(index){if(confirm('Remove this Telegram bot?')){const bots=alertsConfig.telegram||[];if(bots[index]){sendWS({type:'remove_telegram_bot',chatId:bots[index].chatId});}}}function openEditAlertModal(type){const allTypes=[...alertTypes.env,...alertTypes.frost,...alertTypes.system,...alertTypes.device];const alertType=allTypes.find(a=>a.type===type);const config=alertsConfig.alerts?.[type]||{enabled:true,cooldown:30,maxPerHour:5,threshold:0,triggerRoutine:''};document.getElementById('edit-alert-type').value=type;document.getElementById('edit-alert-title').textContent=alertType ? alertType.name:'Edit Alert';document.getElementById('edit-alert-cooldown').value=config.cooldown||30;document.getElementById('edit-alert-maxhour').value=config.maxPerHour||5;document.getElementById('edit-alert-threshold').value=config.threshold||0;document.getElementById('edit-alert-routine').value=config.triggerRoutine||'';const thresholdGroup=document.getElementById('threshold-group');thresholdGroup.style.display=alertType&&alertType.hasThreshold ? 'block':'none';document.getElementById('edit-alert-modal').classList.add('open');}function saveAlertConfig(){const type=parseInt(document.getElementById('edit-alert-type').value);const config={enabled:alertsConfig.alerts?.[type]?.enabled!==false,cooldown:parseInt(document.getElementById('edit-alert-cooldown').value)||30,maxPerHour:parseInt(document.getElementById('edit-alert-maxhour').value)||5,threshold:parseFloat(document.getElementById('edit-alert-threshold').value)||0,triggerRoutine:document.getElementById('edit-alert-routine').value||''};sendWS({type:'update_alert_setting',alertType:type,config:config});closeModal('edit-alert-modal');}function testAlert(){if(!alertsConfig.enabled){alert('Please enable alerts first');return;}const hasContacts=alertsConfig.contacts&&alertsConfig.contacts.length>0;const hasTelegram=alertsConfig.telegram&&alertsConfig.telegram.length>0;if(!hasContacts&&!hasTelegram){alert('Please add at least one WhatsApp contact or Telegram bot first');return;}sendWS({type:'test_alert'});let channels=[];if(hasTelegram)channels.push('Telegram');if(hasContacts)channels.push('WhatsApp');alert('Test alert sent!Check your '+channels.join(' and ')+' in a few seconds.');}function closeModal(id){document.getElementById(id).classList.remove('open');}document.querySelectorAll('.modal-overlay').forEach(modal=>{modal.addEventListener('click',(e)=>{if(e.target===modal)modal.classList.remove('open');});});connectWebSocket();</script></main></body></html>