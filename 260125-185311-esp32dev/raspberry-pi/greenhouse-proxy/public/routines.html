<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><meta name="theme-color" content="#0a0e1a"><title>Routines-Greenhouse OS</title><style>:root{--bg:#0a0e1a;--surface:#151b2e;--surface-elevated:#1f2739;--primary:#4f7cff;--success:#00d9a5;--danger:#ff4757;--warning:#ffa726;--text:#f8fafc;--text-secondary:#cbd5e1;--text-muted:#94a3b8;--border:rgba(148,163,184,0.12);--shadow-md:0 4px 16px rgba(0,0,0,0.25);--accent-green:#00d9a5;--accent-blue:#4f7cff;--accent-red:#ff4757;--accent-yellow:#ffa726;--shadow:0 8px 32px rgba(0,0,0,0.3);}/* Navigation Bar */.navbar{background:linear-gradient(90deg,var(--accent-green) 0%,var(--accent-blue) 100%);color:white;padding:0;box-shadow:var(--shadow);position:sticky;top:0;z-index:1000;}.navbar-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;}.navbar-brand{display:flex;align-items:center;gap:0.75rem;cursor:pointer;text-decoration:none;color:white;font-weight:700;font-size:1.3rem;}.navbar-brand:hover{opacity:0.9;}.navbar-icon{font-size:1.8rem;animation:sway 3s ease-in-out infinite;}@keyframes sway{0%,100%{transform:rotate(-5deg);}50%{transform:rotate(5deg);}}.navbar-menu{display:flex;gap:0.5rem;align-items:center;}.navbar-link{color:white;text-decoration:none;padding:0.6rem 1.2rem;border-radius:8px;transition:all 0.3s;font-weight:500;font-size:0.95rem;cursor:pointer;border:2px solid transparent;}.navbar-link:hover{background:rgba(255,255,255,0.2);transform:translateY(-2px);}.navbar-link.active{background:rgba(255,255,255,0.3);border-color:rgba(255,255,255,0.5);}.weather-mini{display:flex;align-items:center;gap:0.5rem;background:rgba(255,255,255,0.15);padding:0.5rem 1rem;border-radius:20px;margin-left:auto;}.weather-mini .temp{font-size:1.2rem;font-weight:600;}*{box-sizing:border-box;margin:0;padding:0;}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(135deg,#0a0e1a 0%,#1a1f35 100%);color:var(--text);padding:16px;min-height:100vh;}@media(min-width:768px){body{padding:20px;}}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.05);position:relative;z-index:200;flex-wrap:wrap;gap:12px;}@media(min-width:768px){.header{margin-bottom:24px;padding-bottom:20px;}}.header h1{font-size:1.5rem;background:linear-gradient(135deg,#00d9a5,#00b386);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}@media(min-width:768px){.header h1{font-size:2rem;}}.btn{padding:10px 18px;border-radius:12px;border:none;font-weight:600;cursor:pointer!important;transition:all 0.2s;position:relative;z-index:100;pointer-events:auto!important;font-size:0.9rem;}@media(min-width:768px){.btn{padding:12px 24px;font-size:1rem;}}.btn-primary{background:linear-gradient(135deg,#4f7cff,#7c3aed);color:white;}.btn-success{background:linear-gradient(135deg,#00d9a5,#00b386);color:white;}.btn-danger{background:linear-gradient(135deg,#ff4757,#d63447);color:white;}.btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);}.routines-list{display:grid;gap:16px;}.routine-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:10px;transition:all 0.3s;max-height:none;}.routine-title-row{display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer;}.routine-title-row h3{font-size:1rem;margin:0;flex:1;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}.routine-button-row{display:flex;align-items:center;justify-content:space-between;gap:8px;}.routine-button-row .routine-play-btn{width:48px;height:48px;min-width:48px;font-size:1.4rem;}.routine-button-row .right-buttons{display:flex;align-items:center;gap:8px;}.routine-card.collapsed .routine-content{display:none;}@media(min-width:768px){.routine-card{display:grid;grid-template-columns:auto 1fr auto auto;grid-template-rows:1fr;align-items:center;padding:20px;gap:16px;}.routine-card.collapsed{grid-template-rows:1fr;}.routine-title-row{display:none;}.routine-button-row{display:none;}}.routine-card.disabled{border-color:rgba(100,116,139,0.15);background:rgba(15,23,42,0.8);}.routine-card.disabled>*:not(.routine-actions):not(.routine-button-row){opacity:0.4;filter:grayscale(0.9);pointer-events:none;}.routine-card.disabled .routine-button-row>*:not(.right-buttons){opacity:0.4;filter:grayscale(0.9);pointer-events:none;}.routine-card.disabled .right-buttons>*:not(.toggle-switch),.routine-card.disabled .routine-actions>*:not(.toggle-switch){opacity:0.4;filter:grayscale(0.9);pointer-events:none;}.routine-card.disabled .toggle-switch,.routine-card.disabled .toggle-switch*{opacity:1!important;filter:none!important;pointer-events:auto!important;}.routine-play-section{display:none;}@media(min-width:768px){.routine-play-section{display:flex;flex-direction:column;align-items:center;gap:6px;grid-column:1;grid-row:1;min-width:70px;}}.routine-play-btn{background:linear-gradient(135deg,#4f7cff,#7c3aed);color:white;border:none;border-radius:50%;width:48px;height:48px;font-size:1.4rem;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(79,124,255,0.3);flex-shrink:0;-webkit-tap-highlight-color:transparent;touch-action:manipulation;}@media(min-width:768px){.routine-play-btn{width:56px;height:56px;font-size:1.8rem;}}.routine-play-btn:hover{transform:scale(1.05);box-shadow:0 6px 20px rgba(79,124,255,0.5);}.routine-play-btn:active{transform:scale(0.95);}.routine-play-btn.stop{background:linear-gradient(135deg,#ff4757,#d63447);}.routine-play-btn:disabled{opacity:0.5;cursor:not-allowed;}.routine-state-label{font-size:0.7rem;font-weight:600;padding:3px 8px;border-radius:8px;text-transform:uppercase;letter-spacing:0.5px;}.routine-state-idle{background:rgba(148,163,184,0.2);color:#94a3b8;}.routine-state-running{background:rgba(255,167,38,0.2);color:#ffa726;animation:pulse 2s infinite;}.routine-state-scheduled{background:rgba(79,124,255,0.2);color:#4f7cff;}.routine-state-completed{background:rgba(0,217,165,0.2);color:#00d9a5;}@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.6;}}.routine-content{transition:all 0.3s;}@media(min-width:768px){.routine-content{grid-column:2;grid-row:1;}.routine-card.collapsed .routine-content{display:block;}}.routine-collapse-btn{background:rgba(255,255,255,0.1);border:none;color:var(--text-secondary);font-size:1rem;cursor:pointer;padding:8px;border-radius:8px;transition:all 0.3s;display:flex;align-items:center;justify-content:center;width:36px;height:36px;flex-shrink:0;}.routine-collapse-btn.desktop-collapse{display:none;}@media(min-width:768px){.routine-collapse-btn{font-size:1.2rem;padding:8px;width:40px;height:40px;grid-column:3;grid-row:1;background:transparent;}.routine-collapse-btn.desktop-collapse{display:flex;}}.routine-collapse-btn:hover{background:rgba(255,255,255,0.1);color:var(--text);}.routine-collapse-btn span{transition:transform 0.3s;display:inline-block;}.routine-collapse-btn.collapsed span{transform:rotate(-90deg);}.routine-card.collapsed .routine-meta,.routine-card.collapsed .routine-info>div:last-child{display:none;}.execution-flow{display:none;margin-top:10px;}.routine-card:not(.collapsed).execution-flow{display:block;}.flow-summary{display:flex;flex-wrap:wrap;gap:6px;align-items:center;}.flow-chip{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-size:0.75rem;font-weight:500;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);}.flow-chip.chip-on{background:rgba(0,217,165,0.15);border-color:rgba(0,217,165,0.3);color:#00d9a5;}.flow-chip.chip-off{background:rgba(255,71,87,0.15);border-color:rgba(255,71,87,0.3);color:#ff6b7a;}.flow-chip.chip-wait{background:rgba(255,167,38,0.15);border-color:rgba(255,167,38,0.3);color:#ffa726;}.flow-chip-icon{font-size:0.85rem;}.flow-divider{color:var(--text-muted);font-size:0.7rem;opacity:0.5;}.flow-empty{color:var(--text-muted);font-size:0.8rem;font-style:italic;}.flow-chip.expandable{cursor:pointer;position:relative;}.flow-chip.expandable:hover{filter:brightness(1.2);}.flow-chip-devices{display:none;position:absolute;top:100%;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px;margin-top:4px;min-width:120px;max-width:200px;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.3);}.flow-chip.expandable.expanded .flow-chip-devices{display:block;}.flow-chip-device{font-size:0.7rem;padding:3px 6px;background:rgba(255,255,255,0.1);border-radius:4px;margin:2px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}.routine-card.collapsed .routine-actions .toggle-switch,.routine-card.collapsed .routine-actions .btn-icon[title="Delete"]{display:none;}.routine-card .btn-delete-mobile{display:flex;flex-shrink:0;}.routine-card.collapsed .routine-button-row{flex-wrap:nowrap;overflow:hidden;}.routine-card.collapsed .right-buttons{flex-shrink:1;min-width:0;overflow:hidden;}.routine-card.collapsed .btn-delete-mobile{flex-shrink:999;min-width:0;overflow:hidden;}@media(min-width:768px){.routine-card.collapsed .routine-actions .toggle-switch,.routine-card.collapsed .routine-actions .btn-icon[title="Delete"]{display:inline-flex;}.routine-card .btn-delete-mobile{display:none;}}.btn-schedule{background:rgba(255,167,38,0.2);color:#ffa726;border:2px solid rgba(255,167,38,0.3);padding:8px 12px;border-radius:8px;font-size:0.8rem;cursor:pointer;transition:all 0.2s;min-height:40px;display:flex;align-items:center;justify-content:center;white-space:nowrap;}@media(min-width:768px){.btn-schedule{padding:6px 12px;font-size:0.85rem;min-height:auto;}}.btn-schedule:hover{background:rgba(255,167,38,0.3);transform:scale(1.05);}.routine-info{}.routine-info h3{font-size:1rem;margin:0 0 6px 0;display:none;}.routine-info .mobile-status-label{display:none;}@media(min-width:768px){.routine-info h3{display:block;font-size:1.2rem;margin-bottom:8px;}}.routine-meta{display:flex;gap:12px;font-size:0.85rem;color:var(--text-muted);flex-wrap:wrap;}.last-run-label{color:var(--text-muted);opacity:0.8;font-size:0.8rem;}.badge{padding:4px 10px;border-radius:6px;font-size:0.75rem;font-weight:600;}.badge-manual{background:rgba(79,124,255,0.2);color:#4f7cff;}.badge-timer{background:rgba(255,167,38,0.2);color:#ffa726;}.badge-temp{background:rgba(255,71,87,0.2);color:#ff4757;}.badge-weather{background:rgba(0,217,165,0.2);color:#00d9a5;}.routine-actions{display:none;}@media(min-width:768px){.routine-actions{display:flex;gap:8px;flex-wrap:nowrap;justify-content:flex-start;align-items:center;grid-column:4;grid-row:1;}}.toggle-switch{position:relative;width:48px;height:28px;flex-shrink:0;}@media(min-width:768px){.toggle-switch{width:52px;height:28px;}}.toggle-switch input{opacity:0;width:0;height:0;}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--surface-elevated);border:2px solid var(--border);transition:all 0.4s;border-radius:28px;}.slider:before{content:"";position:absolute;height:20px;width:20px;left:3px;bottom:2px;background:var(--text-muted);transition:all 0.4s;border-radius:50%;}@media(min-width:768px){.slider:before{height:20px;width:20px;left:3px;}}input:checked+.slider{background:linear-gradient(135deg,#00d9a5,#00b386);border-color:var(--success);}input:checked+.slider:before{transform:translateX(20px);background:white;}@media(min-width:768px){input:checked+.slider:before{transform:translateX(24px);}}.btn-icon{background:rgba(255,255,255,0.1);border:none;font-size:1.1rem;cursor:pointer;padding:10px;color:var(--text);border-radius:10px;transition:all 0.2s;min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;}@media(min-width:768px){.btn-icon{font-size:1.25rem;padding:8px;min-width:40px;min-height:40px;}}.btn-icon:hover{background:rgba(255,255,255,0.2);transform:scale(1.05);}.empty-state{text-align:center;padding:60px 20px;color:var(--text-muted);}.empty-state svg{width:80px;height:80px;margin-bottom:20px;opacity:0.5;}.dialog-modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);animation:fadeIn 0.3s ease-out;align-items:center;justify-content:center;}.dialog-modal.active{display:flex;}@keyframes slideUpDialog{from{opacity:0;transform:translateY(30px)scale(0.95);}to{opacity:1;transform:translateY(0)scale(1);}}.dialog-content{background:linear-gradient(135deg,rgba(30,30,46,0.98),rgba(38,38,59,0.98));border:1px solid rgba(255,255,255,0.1);border-radius:20px;max-width:480px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5),0 0 0 1px rgba(255,255,255,0.05);animation:slideUpDialog 0.4s cubic-bezier(0.34,1.56,0.64,1);overflow:hidden;}.dialog-header{padding:24px 24px 20px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:1.3rem;font-weight:600;color:var(--text);background:linear-gradient(135deg,rgba(79,124,255,0.1),rgba(124,58,237,0.1));}.dialog-body{padding:28px 24px;color:var(--text-secondary);line-height:1.7;font-size:0.95rem;}.dialog-input{width:100%;padding:14px 16px;background:rgba(0,0,0,0.3);border:2px solid rgba(255,255,255,0.1);border-radius:12px;color:var(--text);font-size:1rem;margin-top:16px;transition:all 0.3s;}.dialog-input:focus{outline:none;border-color:var(--primary);background:rgba(0,0,0,0.4);box-shadow:0 0 0 4px rgba(79,124,255,0.15);}.dialog-footer{padding:20px 24px;border-top:1px solid rgba(255,255,255,0.08);display:flex;justify-content:flex-end;gap:12px;background:rgba(0,0,0,0.15);}.dialog-footer .btn{padding:10px 24px;font-weight:500;border-radius:10px;transition:all 0.3s;}.dialog-footer .btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.3);}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.8);animation:fadeIn 0.2s;}.modal.active{display:flex;align-items:center;justify-content:center;}.modal-content{background:var(--surface);border-radius:16px;max-width:900px;width:95%;max-height:95vh;overflow-y:auto;box-shadow:var(--shadow-lg);animation:slideUp 0.3s;}@media(min-width:768px){.modal-content{border-radius:20px;width:90%;max-height:90vh;}}.modal-header{padding:20px;background:linear-gradient(135deg,rgba(79,124,255,0.15),rgba(124,58,237,0.1));border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}@media(min-width:768px){.modal-header{padding:24px 28px;}}.modal-header h2{font-size:1.3rem;font-weight:700;background:linear-gradient(135deg,#4f7cff,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}@media(min-width:768px){.modal-header h2{font-size:1.6rem;}}.modal-body{padding:16px;}@media(min-width:768px){.modal-body{padding:24px;}}.modal-footer{padding:16px 20px;background:var(--surface-elevated);border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:12px;flex-wrap:wrap;}@media(min-width:768px){.modal-footer{padding:20px 28px;gap:16px;}}.modal-footer .btn{min-width:120px;}.modal-footer .btn-primary{box-shadow:0 4px 12px rgba(79,124,255,0.3);}.form-group{margin-bottom:20px;}@media(min-width:768px){.form-group{margin-bottom:24px;}}.form-group label{display:flex;align-items:center;gap:8px;margin-bottom:10px;font-weight:600;color:var(--text);font-size:0.95rem;}.form-group label .label-icon{font-size:1.1rem;}@media(min-width:768px){.form-group label{margin-bottom:12px;font-size:1.05rem;}}.form-control{width:100%;padding:14px 16px;background:var(--bg);border:2px solid var(--border);border-radius:12px;color:var(--text);font-size:1rem;transition:all 0.2s;}@media(min-width:768px){.form-control{padding:14px 18px;border-radius:14px;font-size:1.05rem;}}.form-control:focus{outline:none;border-color:var(--primary);background:var(--surface-elevated);box-shadow:0 0 0 4px rgba(79,124,255,0.15);}.form-control::placeholder{color:var(--text-muted);}.form-row{display:grid;grid-template-columns:1fr;gap:12px;}@media(min-width:768px){.form-row{grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;}}.section-card{background:var(--surface-elevated);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:20px;}@media(min-width:768px){.section-card{padding:20px;margin-bottom:24px;border-radius:20px;}}.section-card-header{display:flex;align-items:center;gap:10px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);}.section-card-header h3{font-size:1rem;font-weight:600;color:var(--text);}.section-card-header .section-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;}.section-icon.blue{background:linear-gradient(135deg,rgba(79,124,255,0.2),rgba(79,124,255,0.1));}.section-icon.green{background:linear-gradient(135deg,rgba(0,217,165,0.2),rgba(0,217,165,0.1));}.section-icon.orange{background:linear-gradient(135deg,rgba(255,167,38,0.2),rgba(255,167,38,0.1));}.section-icon.purple{background:linear-gradient(135deg,rgba(124,58,237,0.2),rgba(124,58,237,0.1));}.flow-builder{background:transparent;border:none;padding:0;min-height:auto;}.flow-toolbar{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;}@media(min-width:768px){.flow-toolbar{display:flex;gap:12px;}}.flow-toolbar .btn{justify-content:center;display:flex;align-items:center;gap:6px;padding:12px 16px;font-size:0.85rem;}.flow-toolbar .btn:last-child{grid-column:span 2;}@media(min-width:768px){.flow-toolbar .btn{padding:10px 16px;}.flow-toolbar .btn:last-child{grid-column:auto;}}.flow-canvas{background:var(--bg);border:2px dashed var(--border);border-radius:14px;padding:12px;min-height:150px;}@media(min-width:768px){.flow-canvas{padding:16px;min-height:200px;}}.device-sequence{background:var(--surface);border:2px solid var(--border);border-radius:14px;padding:12px;margin-bottom:12px;transition:all 0.2s;}.device-sequence.draggable-step{cursor:grab;}.device-sequence.draggable-step:active{cursor:grabbing;}.device-sequence.dragging-step{opacity:0.5;border-color:var(--primary)!important;transform:scale(1.02);}.device-sequence.drag-over-step{border-color:var(--primary)!important;background:rgba(79,124,255,0.15)!important;}.device-sequence.action-on-step{border-color:rgba(0,217,165,0.4);background:linear-gradient(135deg,rgba(0,217,165,0.08),transparent);}.device-sequence.action-off-step{border-color:rgba(255,71,87,0.4);background:linear-gradient(135deg,rgba(255,71,87,0.08),transparent);}.device-sequence.wait-type-step{border-color:rgba(255,167,38,0.4);background:linear-gradient(135deg,rgba(255,167,38,0.08),transparent);}@media(min-width:768px){.device-sequence{padding:16px;}}.drag-handle{font-size:1.2rem;color:var(--text-muted);cursor:grab;padding:4px 8px;margin-right:4px;border-radius:4px;user-select:none;-webkit-user-select:none;}.drag-handle:hover{background:rgba(255,255,255,0.1);color:var(--text);}.drag-handle:active{cursor:grabbing;}.device-sequence-header{display:flex;justify-content:space-between;align-items:center;gap:8px;user-select:none;-webkit-user-select:none;}.device-sequence-header:hover{opacity:0.9;}.step-header-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0;}.step-number{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.85rem;flex-shrink:0;}.device-sequence.action-on-step .step-number{background:var(--success);color:white;}.device-sequence.action-off-step .step-number{background:var(--danger);color:white;}.device-sequence.wait-type-step .step-number{background:var(--warning);color:#1a1a1a;}.step-info{flex:1;min-width:0;}.step-title{font-weight:600;font-size:0.95rem;color:var(--text);display:flex;align-items:center;gap:6px;}.step-subtitle{font-size:0.8rem;color:var(--text-muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}.step-actions{display:flex;gap:6px;flex-shrink:0;}.collapse-arrow{display:inline-block;transition:transform 0.3s ease;font-size:1rem;color:var(--primary);user-select:none;}@media(min-width:768px){.collapse-arrow{font-size:1.2rem;}}.collapse-arrow.collapsed{transform:rotate(-90deg);}.step-devices-list{margin-top:12px;padding-top:12px;border-top:1px solid var(--border);}.device-item{background:var(--surface-elevated);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:8px;display:flex;align-items:center;gap:10px;transition:all 0.2s;cursor:grab;user-select:none;-webkit-user-select:none;}.device-item:active{cursor:grabbing;}.device-item:last-child{margin-bottom:0;}@media(min-width:768px){.device-item{padding:12px 14px;}}.device-item:hover{background:var(--surface);}.device-item.dragging{opacity:0.5;background:var(--primary);transform:scale(1.02);}.device-item.drag-over{border-color:var(--primary);background:rgba(79,124,255,0.1);}.device-item-info{display:flex;align-items:center;gap:10px;flex:1;min-width:0;}.device-item-info span:first-child{font-size:1.2rem;}.device-item-info span:last-child{font-size:0.9rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}.device-name-link{cursor:pointer;color:var(--primary);text-decoration:underline;text-decoration-style:dotted;text-underline-offset:2px;}.device-name-link:hover{color:#7c9eff;text-decoration-style:solid;}.device-item.dragging .device-name-link{pointer-events:none;}.device-replacer-list{max-height:350px;overflow-y:auto;}.device-replace-option{display:flex;align-items:center;gap:12px;padding:14px 20px;cursor:pointer;border-bottom:1px solid var(--border);transition:background 0.2s;}.device-replace-option:last-child{border-bottom:none;}.device-replace-option:hover{background:var(--surface-elevated);}.device-replace-option.current{background:rgba(79,124,255,0.1);}.device-replace-option span:first-child{font-size:1.3rem;}.device-replace-option span:nth-child(2){flex:1;font-weight:500;}.device-controls{display:flex;align-items:center;gap:8px;flex-shrink:0;}.device-order-num{background:rgba(79,124,255,0.2);color:var(--primary);width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75rem;flex-shrink:0;}.device-timer-input{width:70px;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;text-align:center;}.device-timer-input:focus{outline:none;border-color:var(--primary);background:var(--surface);}.timer-suffix{font-size:0.8rem;color:var(--text-muted);margin-left:-4px;}.execution-mode{background:var(--bg);border-radius:10px;padding:10px 12px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;gap:8px;}.execution-mode-label{font-size:0.8rem;color:var(--text-muted);display:flex;align-items:center;gap:6px;}.mode-toggle{display:flex;gap:4px;}.mode-toggle label{padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:6px;font-size:0.75rem;color:var(--text-muted);cursor:pointer;transition:all 0.2s;font-size:0.75rem;}@media(min-width:768px){.mode-toggle label{padding:8px 16px;font-size:0.85rem;}}.mode-toggle input[type="radio"]{display:none;}.mode-toggle label:has(input[type="radio"]:checked){background:var(--primary);border-color:var(--primary);color:white;}.flow-step{background:var(--surface);border:2px solid var(--border);border-radius:12px;padding:12px;margin-bottom:12px;display:flex;flex-direction:column;gap:12px;transition:all 0.2s;position:relative;}@media(min-width:768px){.flow-step{padding:16px;flex-direction:row;align-items:center;justify-content:space-between;}}.flow-step:hover{border-color:var(--primary);box-shadow:0 4px 12px rgba(79,124,255,0.2);}.flow-step-content{flex:1;}.flow-step-actions{display:flex;gap:8px;}.step-type{font-size:0.75rem;color:var(--text-muted);margin-bottom:4px;}.step-details{font-weight:600;color:var(--text);}.step-devices{font-size:0.85rem;color:var(--text-muted);margin-top:4px;}.btn-sm{padding:6px 12px;font-size:0.85rem;border-radius:8px;}.btn-secondary{background:var(--surface-elevated);color:var(--text);border:1px solid var(--border);}.action-badge{padding:4px 8px;border-radius:6px;font-size:0.75rem;font-weight:600;margin-left:8px;}.action-on{background:rgba(0,217,165,0.2);color:#00d9a5;}.action-off{background:rgba(255,71,87,0.2);color:#ff4757;}.flow-arrow{text-align:center;color:var(--text-muted);font-size:1.5rem;margin:4px 0;}@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}@keyframes slideUp{from{transform:translateY(50px);opacity:0;}to{transform:translateY(0);opacity:1;}}.hidden{display:none;}select.form-control{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:40px;}.device-picker{max-height:240px;overflow-y:auto;background:var(--bg);border:2px solid var(--border);border-radius:14px;padding:8px;}.device-picker::-webkit-scrollbar{width:6px;}.device-picker::-webkit-scrollbar-track{background:transparent;}.device-picker::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}.device-checkbox{display:flex;align-items:center;padding:12px 14px;margin:4px 0;border-radius:10px;transition:all 0.2s;cursor:pointer;border:2px solid transparent;background:var(--surface);}.device-checkbox:hover{background:var(--surface-elevated);border-color:var(--primary);}.device-checkbox.selected{background:rgba(79,124,255,0.15);border-color:var(--primary);}.device-checkbox input{width:18px;height:18px;margin-right:12px;cursor:pointer;accent-color:var(--primary);}.device-checkbox label{cursor:pointer;font-weight:500;flex:1;}</style></head><body><nav class="navbar"><div class="navbar-content"><a href="/" class="navbar-brand"><span class="navbar-icon">üåæ</span><span>Farm Hub</span></a><div class="navbar-menu"><a href="/" class="navbar-link" title="Main Dashboard">üìä Dashboard</a><a href="/greenhouse/" class="navbar-link" title="Greenhouse Controls">üå± Greenhouse</a><a href="/routines.html" class="navbar-link active" title="Automation">‚ö° Routines</a><a href="/alerts.html" class="navbar-link" title="Alerts">üîî Alerts</a><a href="/setup.html" class="navbar-link" title="Settings">‚öôÔ∏è Setup</a></div><div class="weather-mini" id="weather-mini" style="margin-left:auto;"><span id="mini-weather-icon">üå§Ô∏è</span><span class="temp" id="mini-temp">--¬∞C</span></div></div></nav><main><div class="header"><h1 style="font-size:1.5rem;font-weight:500;letter-spacing:0.5px;">Automation Routines</h1><button class="btn btn-success" onclick="createNewRoutine()">‚ûï Create</button></div><div id="routines-container" class="routines-list"><div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/><circle cx="12" cy="12" r="3"/></svg><h2>No Routines Yet</h2><p>Create your first automation routine to get started!</p></div></div><div id="editorModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="editorTitle">‚ú® Edit Routine</h2><button class="btn-icon" onclick="closeEditor()">‚úñÔ∏è</button></div><div class="modal-body"><div class="section-card"><div class="section-card-header"><div class="section-icon blue">üìù</div><h3>Basic Settings</h3></div><div class="form-group" style="margin-bottom:0;"><label><span class="label-icon">‚úèÔ∏è</span>Routine Name</label><input type="text" id="routineName" class="form-control" placeholder="e.g. Morning Irrigation" onchange="markAsChanged()"></div></div><div class="section-card"><div class="section-card-header"><div class="section-icon orange">‚ö°</div><h3>Trigger Configuration</h3></div><div class="form-group"><label><span class="label-icon">üéØ</span>How should this routine start?</label><select id="triggerType" class="form-control" onchange="updateTriggerFields();markAsChanged();"><option value="0">üëÜ Manual-Run with a button press</option><option value="1">‚è∞ Timer-Run on a schedule</option><option value="2">üå°Ô∏è Temperature-Based on sensor readings</option><option value="3">üå§Ô∏è Weather-Based on weather conditions</option></select></div><div id="timerFields" class="hidden"><div class="form-group"><label><span class="label-icon">üîÑ</span>Repeat Interval</label><input type="number" id="timerInterval" class="form-control" value="3600" min="1" placeholder="Seconds between runs"><div style="font-size:0.8rem;color:var(--text-muted);margin-top:8px;">üí° 3600=1 hour,86400=1 day</div></div><div class="form-group" style="margin-bottom:0;"><label><span class="label-icon">üìÖ</span>Schedule(Optional)</label><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;"><div><input type="date" id="scheduleDate" class="form-control" style="margin-bottom:0;"></div><div><input type="time" id="scheduleTime" class="form-control" style="margin-bottom:0;"></div></div><div style="font-size:0.8rem;color:var(--text-muted);margin-top:8px;">üìå Set a specific start time,or leave blank for interval-only</div></div></div><div id="tempFields" class="hidden"><div class="form-row" style="margin-bottom:12px;"><div class="form-group" style="margin-bottom:0;"><label><span class="label-icon">‚ùÑÔ∏è</span>Low Threshold(¬∞C)</label><input type="number" id="tempMin" class="form-control" value="15" step="0.1"><div style="font-size:0.75rem;color:var(--primary);margin-top:4px;">üî• Turn ON heaters when below this</div></div><div class="form-group" style="margin-bottom:0;"><label><span class="label-icon">üî•</span>High Threshold(¬∞C)</label><input type="number" id="tempMax" class="form-control" value="30" step="0.1"><div style="font-size:0.75rem;color:var(--danger);margin-top:4px;">‚ùÑÔ∏è Turn ON cooling when above this</div></div></div><div class="form-row" style="margin-bottom:12px;"><div class="form-group" style="margin-bottom:0;"><label><span class="label-icon">üîÑ</span>Auto-Reverse</label><div class="toggle-container" style="margin-top:8px;"><label class="toggle-switch"><input type="checkbox" id="autoReverse" checked><span class="toggle-slider"></span></label><span style="margin-left:8px;font-size:0.85rem;">Turn OFF when temp normalizes</span></div></div><div class="form-group" style="margin-bottom:0;"><label><span class="label-icon">üìä</span>Hysteresis(¬∞C)</label><input type="number" id="hysteresis" class="form-control" value="2" step="0.5" min="0.5" max="10"><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Buffer to prevent rapid cycling</div></div></div><div class="form-group" style="margin-bottom:0;"><label><span class="label-icon">‚è±Ô∏è</span>Max Runtime(seconds)</label><input type="number" id="maxRunSeconds" class="form-control" value="0" min="0" step="60" placeholder="0=unlimited"><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">‚ö° Auto-stop after X seconds(0=run until temp normalizes)</div></div><div style="font-size:0.8rem;color:var(--success);margin-top:12px;padding:10px;background:rgba(0,217,165,0.1);border-radius:8px;"><strong>How it works:</strong><br>‚Ä¢ Below low threshold ‚Üí Turns ON devices ‚Üí Auto-OFF when temp rises above(low+hysteresis)<br>‚Ä¢ Above high threshold ‚Üí Turns ON devices ‚Üí Auto-OFF when temp drops below(high-hysteresis)</div></div><div id="weatherFields" class="hidden"><div class="form-row" style="margin-bottom:0;"><div class="form-group" style="margin-bottom:0;"><label><span class="label-icon">‚ùÑÔ∏è</span>Min Weather Temp(¬∞C)</label><input type="number" id="weatherMin" class="form-control" value="0" step="0.1"></div><div class="form-group" style="margin-bottom:0;"><label><span class="label-icon">üî•</span>Max Weather Temp(¬∞C)</label><input type="number" id="weatherMax" class="form-control" value="30" step="0.1"></div></div><div style="font-size:0.8rem;color:var(--text-muted);margin-top:12px;">üå§Ô∏è Uses outdoor weather data from your location</div></div></div><div class="section-card" style="margin-bottom:0;"><div class="section-card-header"><div class="section-icon green">üîß</div><h3>Automation Steps</h3></div><div class="flow-builder"><div class="flow-toolbar"><button class="btn btn-sm btn-success" onclick="addDeviceStep()">‚ûï Add Devices</button><button class="btn btn-sm btn-secondary" onclick="addWaitStep()">‚è±Ô∏è Add Wait</button><button class="btn btn-sm btn-danger" onclick="clearSteps()">üóëÔ∏è Clear</button></div><div id="flowCanvas" class="flow-canvas"><div class="empty-state" style="padding:30px;background:transparent;"><p style="color:var(--text-muted);font-size:0.9rem;">üéØ No steps yet.<br>Click<strong>"Add Devices"</strong>to start building your automation.</p></div></div></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeEditor()">Cancel</button><button class="btn btn-primary" onclick="saveRoutine()">üíæ Save Routine</button></div></div></div><div id="deviceStepModal" class="modal"><div class="modal-content" style="max-width:550px;"><div class="modal-header"><h2>üîå Select Devices</h2><button class="btn-icon" onclick="closeDeviceStep()">‚úñÔ∏è</button></div><div class="modal-body"><div class="section-card" style="margin-bottom:16px;"><div class="form-group" style="margin-bottom:0;"><label><span class="label-icon">‚ö°</span>Action to perform</label><div style="display:flex;align-items:center;justify-content:center;gap:20px;background:var(--bg);padding:16px;border-radius:12px;"><span style="font-weight:600;color:var(--danger);font-size:0.95rem;">OFF</span><label class="toggle-switch" style="margin:0;transform:scale(1.1);"><input type="checkbox" id="deviceActionToggle" checked><span class="slider"></span></label><span style="font-weight:600;color:var(--success);font-size:0.95rem;">ON</span></div></div></div><div class="form-group" style="margin-bottom:0;"><label style="display:flex;justify-content:space-between;align-items:center;"><span><span class="label-icon">üìã</span>Choose devices</span><button class="btn-icon" onclick="toggleDeviceSort()" title="Toggle sort order" style="font-size:0.9rem;opacity:0.7;">üî§</button></label><div id="devicePicker" class="device-picker"><p style="color:var(--text-muted);">Loading devices...</p></div><div style="font-size:0.8rem;color:var(--text-muted);margin-top:8px;">üí° Select multiple devices to control them together</div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeDeviceStep()">Cancel</button><button class="btn btn-success" onclick="confirmDeviceStep()">‚úì Add Step</button></div></div></div><div id="deviceReplacerModal" class="modal"><div class="modal-content" style="max-width:400px;"><div class="modal-header"><h2 id="deviceReplacerTitle">üîÑ Replace Device</h2><button class="btn-icon" onclick="closeDeviceReplacer()">‚úñÔ∏è</button></div><div class="modal-body" style="padding:0;"><div id="deviceReplacerList" class="device-replacer-list"><p style="color:var(--text-muted);padding:20px;">Loading...</p></div></div></div></div><div id="customDialog" class="dialog-modal" onclick="handleDialogBackdropClick(event)"><div class="dialog-content" onclick="event.stopPropagation()"><div class="dialog-header" id="dialogTitle"></div><div class="dialog-body"><div id="dialogMessage"></div><input type="text" id="dialogInput" class="dialog-input" style="display:none;"></div><div class="dialog-footer" id="dialogFooter"></div></div></div><div id="schedulerModal" class="modal"><div class="modal-content" style="max-width:500px;"><div class="modal-header"><h2>‚è∞ Schedule Routine</h2><button class="btn-icon" onclick="closeScheduler()">‚úñÔ∏è</button></div><div class="modal-body"><h3 style="font-size:1rem;color:var(--text);margin-bottom:12px;">‚ñ∂Ô∏è Start Time</h3><div class="form-group"><label>Start Date</label><input type="date" id="schedulerStartDate" class="form-control"></div><div class="form-group"><label>Start Time</label><input type="time" id="schedulerStartTime" class="form-control"></div><h3 style="font-size:1rem;color:var(--text);margin:20px 0 12px 0;">‚èπÔ∏è End Time(Optional)</h3><div class="form-group"><label>End Date</label><input type="date" id="schedulerEndDate" class="form-control"></div><div class="form-group"><label>End Time</label><input type="time" id="schedulerEndTime" class="form-control"></div><div style="font-size:0.85rem;color:var(--text-muted);margin-top:12px;padding:12px;background:rgba(79,124,255,0.1);border-radius:8px;">üí°<strong>Tip:</strong>Set a specific date and time for this routine to run. The routine will execute once at the scheduled time.</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeScheduler()">Cancel</button><button class="btn btn-danger" onclick="clearSchedule()">Clear Schedule</button><button class="btn btn-success" onclick="saveSchedule()">Save Schedule</button></div></div></div><script>let hasUnsavedChanges=false;let originalRoutineData=null;let currentDialogResolver=null;let isManualRoutineDialog=false;function handleDialogBackdropClick(event){const dialog=document.getElementById('customDialog');dialog.classList.remove('active');if(currentDialogResolver){const resolver=currentDialogResolver;currentDialogResolver=null;if(isManualRoutineDialog){resolver(null);}else{resolver({button:'Cancel',value:null});}isManualRoutineDialog=false;}}function showDialog(title,message,buttons=['OK']){return new Promise((resolve)=>{currentDialogResolver=resolve;isManualRoutineDialog=false;const dialog=document.getElementById('customDialog');const dialogTitle=document.getElementById('dialogTitle');const dialogMessage=document.getElementById('dialogMessage');const dialogFooter=document.getElementById('dialogFooter');const dialogInput=document.getElementById('dialogInput');dialogTitle.textContent=title;if(typeof message==='object'&&message.isPrompt){dialogMessage.innerHTML=message.text;dialogInput.style.display='block';dialogInput.value=message.defaultValue||'';setTimeout(()=>dialogInput.focus(),100);}else{dialogMessage.innerHTML=message;dialogInput.style.display='none';}dialogFooter.innerHTML=buttons.map((btn,idx)=>{const isCancel=btn.toLowerCase().includes('cancel')||btn.toLowerCase().includes('no');const isPrimary=btn.toLowerCase().includes('ok')||btn.toLowerCase().includes('yes')||btn.toLowerCase().includes('delete');const isDanger=btn.toLowerCase().includes('delete')||btn.toLowerCase().includes('discard');let btnClass='btn btn-secondary';if(isDanger)btnClass='btn btn-danger';else if(isPrimary&&!isCancel)btnClass='btn btn-primary';return `<button class="${btnClass}" data-btn-idx="${idx}">${btn}</button>`;}).join('');dialogFooter.querySelectorAll('button').forEach(btn=>{btn.onclick=()=>{const btnIdx=parseInt(btn.dataset.btnIdx);const btnText=buttons[btnIdx];dialog.classList.remove('active');currentDialogResolver=null;if(dialogInput.style.display==='block'){resolve({button:btnText,value:dialogInput.value});}else{resolve({button:btnText});}};});dialog.classList.add('active');});}async function customAlert(message,title='‚ö†Ô∏è Notice'){await showDialog(title,message,['OK']);}async function customConfirm(message,title='‚ùì Confirm'){const result=await showDialog(title,message,['Cancel','OK']);return result.button==='OK';}async function customPrompt(message,defaultValue='',title='‚úèÔ∏è Input'){const result=await showDialog(title,{isPrompt:true,text:message,defaultValue},['Cancel','OK']);return result.button==='OK' ? result.value:null;}function markAsChanged(){hasUnsavedChanges=true;}function markAsSaved(){hasUnsavedChanges=false;originalRoutineData=null;}</script><script>let socket;let routines=[];let devices=[];let currentRoutine=null;let editingSteps=[];let deviceSortAscending=true;function connectWebSocket(){socket=new WebSocket(`ws://${window.location.host}/ws`);socket.onopen=()=>{console.log('WebSocket connected');sendWS({type:'sync_routines'});sendWS({type:'get_sync'});};socket.onmessage=(event)=>{const data=JSON.parse(event.data);if(data.type==='routines_sync'){routines=(data.routines||[]).map(r=>({...r,steps:(r.steps||[]).map(s=>({...s,waitSeconds:s.waitSeconds||s.wait_seconds||s.wait||0}))}));renderRoutines();}else if(data.type==='sync'){devices=data.devices||[];console.log('Loaded devices:',devices.length);}else if(data.type==='routine_progress'){updateRoutineProgress(data.id,data.step,data.total,data.status);}else if(data.type==='routine_started'){console.log('Routine started:',data.id,'success:',data.success);setTimeout(()=>sendWS({type:'sync_routines'}),500);}};socket.onclose=()=>{console.log('WebSocket disconnected,reconnecting...');setTimeout(connectWebSocket,3000);};}function sendWS(data){if(socket&&socket.readyState===WebSocket.OPEN){socket.send(JSON.stringify(data));return true;}return false;}function getDeviceName(deviceId){const dev=devices.find(d=>d.id===deviceId);return dev ? dev.name:deviceId;}function getDeviceIcon(type){const icons={'heater':'üî•','fan':'üåÄ','light':'üí°','pump':'üíß','valve':'üöø','vent':'üå¨Ô∏è','sensor':'üì°','sprinkler':'üåßÔ∏è','motor':'‚öôÔ∏è','relay':'üîå','switch':'üîò'};const lowerType=(type||'').toLowerCase();for(const [key,icon] of Object.entries(icons)){if(lowerType.includes(key))return icon;}return 'üì¶';}function formatSchedule(cronStr){if(!cronStr)return '';const parts=cronStr.trim().split(/\s+/);if(parts.length<4)return cronStr;const [minute,hour,dayOfMonth,month]=parts;const monthNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];const timeStr=`${hour.padStart(2,'0')}:${minute.padStart(2,'0')}`;const monthName=monthNames[parseInt(month)-1]||month;const dateStr=`${monthName}${dayOfMonth}`;return `${dateStr}at ${timeStr}`;}function formatRelativeTime(lastRunSeconds){if(!lastRunSeconds||lastRunSeconds===0)return '';const nowSeconds=Math.floor(Date.now()/1000);let elapsedSeconds;if(lastRunSeconds<1000000000){return 'recently';}else{elapsedSeconds=nowSeconds-lastRunSeconds;}if(elapsedSeconds<0)return 'just now';if(elapsedSeconds<60)return 'just now';if(elapsedSeconds<3600){const mins=Math.floor(elapsedSeconds/60);return `${mins}m ago`;}if(elapsedSeconds<86400){const hours=Math.floor(elapsedSeconds/3600);return `${hours}h ago`;}if(elapsedSeconds<604800){const days=Math.floor(elapsedSeconds/86400);return `${days}d ago`;}if(elapsedSeconds<2592000){const weeks=Math.floor(elapsedSeconds/604800);return `${weeks}w ago`;}const months=Math.floor(elapsedSeconds/2592000);return `${months}mo ago`;}function renderRoutines(){const container=document.getElementById('routines-container');if(routines.length===0){container.innerHTML=`<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/><circle cx="12" cy="12" r="3"/></svg><h2>No Routines Yet</h2><p>Create your first automation routine to get started!</p></div>`;return;}container.innerHTML=routines.map(r=>{const triggerTypes=['Manual','Timer','Temperature','Weather'];const badgeClasses=['badge-manual','badge-timer','badge-temp','badge-weather'];const triggerType=triggerTypes[r.type]||'Manual';const badgeClass=badgeClasses[r.type]||'badge-manual';let triggerInfo='';if(r.type===1){if(r.schedule){triggerInfo=`üìÖ ${formatSchedule(r.schedule)}`;}else{triggerInfo=`Every ${r.timer||0}s`;}}else if(r.type===2){let dirIcon='';if(r.triggerDirection===1)dirIcon='ü•∂ COLD';else if(r.triggerDirection===2)dirIcon='üî• HOT';const autoRev=r.autoReverse!==false ? 'üîÑ':'';triggerInfo=`‚ùÑÔ∏è${r.tempMin}¬∞-üî•${r.tempMax}¬∞ ${autoRev}${dirIcon ? ' ['+dirIcon+']':''}`;}else if(r.type===3)triggerInfo=`Weather:${r.tempMin}¬∞C-${r.tempMax}¬∞C`;const statusLabels=['Idle','Running','Paused','Completed','Stopped','Error'];const statusColors=['#94a3b8','#ffa726','#4f7cff','#00d9a5','#ff4757','#ff4757'];const statusText=r.running ? statusLabels[r.status]||'Running':'Idle';const statusColor=r.running ? statusColors[r.status]||'#ffa726':'#94a3b8';let stateLabel='Idle';let stateClass='routine-state-idle';if(r.running){stateLabel=statusLabels[r.status]||'Running';stateClass='routine-state-running';}else if(r.schedule&&r.enabled){stateLabel='Scheduled';stateClass='routine-state-scheduled';}else if(r.status===3){stateLabel='Completed';stateClass='routine-state-completed';}const successRate=r.totalRuns>0 ? Math.round((r.successfulRuns/r.totalRuns)*100):0;let progressBar='';if(r.running&&r.currentStep>=0){const progress=Math.round((r.currentStep/r.steps.length)*100);progressBar=`<div style="margin-top:8px;"><div style="background:rgba(255,255,255,0.1);border-radius:8px;height:6px;overflow:hidden;"><div style="background:${statusColor};width:${progress}%;height:100%;transition:width 0.3s;"></div></div><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Step ${r.currentStep+1}/${r.steps.length}</div></div>`;}return `<div class="routine-card collapsed ${!r.enabled ? 'disabled':''}" id="routine-${r.id}"><div class="routine-title-row" onclick="toggleRoutineCollapse('${r.id}',event)"><h3>${r.name}<span class="routine-state-label ${stateClass}">${stateLabel}</span></h3><button class="routine-collapse-btn collapsed" onclick="event.stopPropagation();toggleRoutineCollapse('${r.id}')" title="Collapse/Expand"><span>‚ñº</span></button></div><div class="routine-button-row">${r.running ? `<button class="routine-play-btn stop" onclick="event.stopPropagation();stopRoutine('${r.id}')" title="Stop">‚èπ</button>`:r.type===0 ? `<button class="routine-play-btn" onclick="event.stopPropagation();executeRoutine('${r.id}')" title="Run Now">‚ñ∂</button>`:`<button class="routine-play-btn" onclick="event.stopPropagation();executeRoutine('${r.id}')" title="Run Now" ${!r.enabled ? 'disabled':''}>‚ñ∂</button>`}<div class="right-buttons"><button class="btn-schedule" onclick="event.stopPropagation();openScheduler('${r.id}')" title="Schedule">üïê Schedule</button><button class="btn-icon" onclick="event.stopPropagation();editRoutine('${r.id}')" title="Edit">‚úèÔ∏è</button><label class="toggle-switch" onclick="event.stopPropagation()"><input type="checkbox" ${r.enabled ? 'checked':''}onchange="toggleRoutine('${r.id}',this.checked)" ${r.running ? 'disabled':''}><span class="slider"></span></label><button class="btn-icon btn-delete-mobile" onclick="event.stopPropagation();deleteRoutine('${r.id}')" title="Delete" ${r.running ? 'disabled':''}>üóëÔ∏è</button></div></div><div class="routine-play-section">${r.running ? `<button class="routine-play-btn stop" onclick="event.stopPropagation();stopRoutine('${r.id}')" title="Stop">‚èπ</button>`:r.type===0 ? `<button class="routine-play-btn" onclick="event.stopPropagation();executeRoutine('${r.id}')" title="Run Now">‚ñ∂</button>`:`<button class="routine-play-btn" onclick="event.stopPropagation();executeRoutine('${r.id}')" title="Run Now" ${!r.enabled ? 'disabled':''}>‚ñ∂</button>`}<span class="routine-state-label ${stateClass}">${stateLabel}</span></div><div class="routine-content"><div class="routine-info"><h3>${r.name}</h3><div class="routine-meta"><span class="badge ${badgeClass}">${triggerType}</span>${triggerInfo ? `<span>${triggerInfo}</span>`:''}<span>${r.steps.length}steps</span>${r.totalRuns>0 ? `<span>‚úì ${successRate}%(${r.totalRuns}runs)</span>`:''}${r.lastRun>0 ? `<span class="last-run-label">üïí ${formatRelativeTime(r.lastRun)}</span>`:''}</div>${progressBar}<div class="execution-flow">${r.steps.length>0 ? `<div class="flow-summary">${r.steps.map((s,idx)=>{if(s.type==='wait'){return `<span class="flow-chip chip-wait"><span class="flow-chip-icon">‚è±</span>${s.waitSeconds}s</span>${idx<r.steps.length-1 ? '<span class="flow-divider">‚Ä∫</span>':''}`;}else{const chipClass=s.action==='ON' ? 'chip-on':'chip-off';const icon=s.action==='ON' ? '‚ñ≤':'‚ñº';const orderedDevices=s.deviceSequence&&s.deviceSequence.length>0 ? s.deviceSequence:s.devices;const deviceCount=orderedDevices.length;const deviceNames=orderedDevices.map(id=>getDeviceName(id));const label=deviceCount===1 ? deviceNames[0]:`${deviceCount}devices`;const isExpandable=deviceCount>1;const deviceList=deviceNames.map(n=>`<div class="flow-chip-device">${n}</div>`).join('');return `<span class="flow-chip ${chipClass}${isExpandable ? 'expandable':''}" ${isExpandable ? 'onclick="event.stopPropagation();this.classList.toggle(\'expanded\')"':''}title="${s.action}:${deviceNames.join(',')}"><span class="flow-chip-icon">${icon}</span>${label}${isExpandable ? `<div class="flow-chip-devices">${deviceList}</div>`:''}</span>${idx<r.steps.length-1 ? '<span class="flow-divider">‚Ä∫</span>':''}`;}}).join('')}</div>`:'<span class="flow-empty">No steps defined</span>'}</div></div></div><button class="routine-collapse-btn desktop-collapse collapsed" onclick="event.stopPropagation();toggleRoutineCollapse('${r.id}')" title="Collapse/Expand"><span>‚ñº</span></button><div class="routine-actions"><button class="btn-schedule" onclick="openScheduler('${r.id}')" title="Schedule">üïê Schedule</button><button class="btn-icon" onclick="editRoutine('${r.id}')" title="Edit">‚úèÔ∏è</button><label class="toggle-switch"><input type="checkbox" ${r.enabled ? 'checked':''}onchange="toggleRoutine('${r.id}',this.checked)" ${r.running ? 'disabled':''}><span class="slider"></span></label><button class="btn-icon" onclick="deleteRoutine('${r.id}')" title="Delete" ${r.running ? 'disabled':''}>üóëÔ∏è</button></div></div>`;}).join('');}function toggleRoutineCollapse(routineId,event){if(event){const target=event.target;if(target.closest('button:not(.routine-collapse-btn)')||target.closest('input')||target.closest('label.toggle-switch')||target.closest('.routine-actions')){return;}}const card=document.getElementById(`routine-${routineId}`);const btn=card.querySelector('.routine-collapse-btn');card.classList.toggle('collapsed');btn.classList.toggle('collapsed');}function createNewRoutine(){currentRoutine=null;editingSteps=[];document.getElementById('routineName').value='My Routine';document.getElementById('triggerType').value='0';updateTriggerFields();renderFlow();document.getElementById('editorModal').classList.add('active');document.getElementById('editorTitle').textContent='‚ú® Create New Routine';}function editRoutine(id){currentRoutine=routines.find(r=>r.id===id);if(!currentRoutine)return;document.getElementById('routineName').value=currentRoutine.name;document.getElementById('triggerType').value=currentRoutine.type.toString();if(currentRoutine.type===1){document.getElementById('timerInterval').value=currentRoutine.timer||3600;if(currentRoutine.schedule){const parts=currentRoutine.schedule.trim().split(/\s+/);if(parts.length>=4){const [minute,hour,dayOfMonth,month]=parts;const year=new Date().getFullYear();const date=new Date(year,parseInt(month)-1,parseInt(dayOfMonth),parseInt(hour),parseInt(minute));const dateStr=date.toISOString().split('T')[0];const timeStr=`${hour.padStart(2,'0')}:${minute.padStart(2,'0')}`;document.getElementById('scheduleDate').value=dateStr;document.getElementById('scheduleTime').value=timeStr;}}else{document.getElementById('scheduleDate').value='';document.getElementById('scheduleTime').value='';}}else if(currentRoutine.type===2){document.getElementById('tempMin').value=currentRoutine.tempMin||15;document.getElementById('tempMax').value=currentRoutine.tempMax||30;document.getElementById('autoReverse').checked=currentRoutine.autoReverse!==false;document.getElementById('hysteresis').value=currentRoutine.hysteresis||2.0;document.getElementById('maxRunSeconds').value=currentRoutine.maxRunSeconds||0;}else if(currentRoutine.type===3){document.getElementById('weatherMin').value=currentRoutine.tempMin||0;document.getElementById('weatherMax').value=currentRoutine.tempMax||30;}editingSteps=(currentRoutine.steps||[]).map(step=>{if(step.type==='wait'){return{type:'wait',waitSeconds:step.waitSeconds||step.wait_seconds||step.wait||0};}return{...step,deviceSequence:step.deviceSequence||step.devices||[],deviceTimers:step.deviceTimers||{},executionMode:step.executionMode||'sequential'};});updateTriggerFields();renderFlow();document.getElementById('editorModal').classList.add('active');document.getElementById('editorTitle').textContent='‚úèÔ∏è Edit Routine';}function closeEditor(){if(hasUnsavedChanges){customConfirm('You have unsaved changes. Are you sure you want to close?','‚ö†Ô∏è Unsaved Changes').then(confirmed=>{if(confirmed){document.getElementById('editorModal').classList.remove('active');currentRoutine=null;editingSteps=[];markAsSaved();}});}else{document.getElementById('editorModal').classList.remove('active');currentRoutine=null;editingSteps=[];}}let schedulingRoutineId=null;function openScheduler(routineId){const routine=routines.find(r=>r.id===routineId);if(!routine)return;schedulingRoutineId=routineId;if(routine.schedule&&routine.schedule.length>0){const parts=routine.schedule.split(' ');if(parts.length===5){const minute=parts[0];const hour=parts[1];const dayOfMonth=parts[2];const month=parts[3];const now=new Date();const scheduleDate=new Date();if(dayOfMonth!=='*')scheduleDate.setDate(parseInt(dayOfMonth));if(month!=='*')scheduleDate.setMonth(parseInt(month)-1);if(hour!=='*')scheduleDate.setHours(parseInt(hour));if(minute!=='*')scheduleDate.setMinutes(parseInt(minute));document.getElementById('schedulerStartDate').value=scheduleDate.toISOString().split('T')[0];document.getElementById('schedulerStartTime').value=`${hour.padStart(2,'0')}:${minute.padStart(2,'0')}`;}else{document.getElementById('schedulerStartDate').value='';document.getElementById('schedulerStartTime').value='';}}else{document.getElementById('schedulerStartDate').value='';document.getElementById('schedulerStartTime').value='';}document.getElementById('schedulerEndDate').value='';document.getElementById('schedulerEndTime').value='';document.getElementById('schedulerModal').classList.add('active');}function closeScheduler(){document.getElementById('schedulerModal').classList.remove('active');schedulingRoutineId=null;}function clearSchedule(){if(!schedulingRoutineId)return;const routine=routines.find(r=>r.id===schedulingRoutineId);if(!routine)return;routine.schedule='';sendWS({type:'update_routine',id:routine.id,name:routine.name,trigger_type:routine.type,temp_min:routine.tempMin||0,temp_max:routine.tempMax||0,timer_seconds:routine.timer||0,schedule:''});closeScheduler();setTimeout(()=>sendWS({type:'sync_routines'}),300);}function saveSchedule(){if(!schedulingRoutineId)return;const startDate=document.getElementById('schedulerStartDate').value;const startTime=document.getElementById('schedulerStartTime').value;const endDate=document.getElementById('schedulerEndDate').value;const endTime=document.getElementById('schedulerEndTime').value;if(!startDate||!startTime){customAlert('Please specify at least a start date and time','‚ö†Ô∏è Missing Information');return;}const routine=routines.find(r=>r.id===schedulingRoutineId);if(!routine)return;const [startYear,startMonth,startDay]=startDate.split('-').map(Number);const [startHour,startMinute]=startTime.split(':').map(Number);let cronSchedule=`${startMinute}${startHour}${startDay}${startMonth}*`;if(endDate&&endTime){const [endYear,endMonth,endDay]=endDate.split('-').map(Number);const [endHour,endMinute]=endTime.split(':').map(Number);cronSchedule+=`,${endMinute}${endHour}${endDay}${endMonth}*`;}routine.schedule=cronSchedule;sendWS({type:'update_routine',id:routine.id,name:routine.name,trigger_type:routine.type,temp_min:routine.tempMin||0,temp_max:routine.tempMax||0,timer_seconds:routine.timer||0,schedule:cronSchedule});closeScheduler();setTimeout(()=>sendWS({type:'sync_routines'}),300);}function moveDevice(stepIdx,seqIdx,direction){const step=editingSteps[stepIdx];const newIdx=seqIdx+direction;if(newIdx<0||newIdx>=step.deviceSequence.length)return;const temp=step.deviceSequence[seqIdx];step.deviceSequence[seqIdx]=step.deviceSequence[newIdx];step.deviceSequence[newIdx]=temp;markAsChanged();renderFlow();log(`Device moved ${direction>0 ? 'down':'up'}`);}function toggleSequenceExpand(header){const items=header.nextElementSibling;const arrow=header.querySelector('.collapse-arrow');if(items.style.display==='none'){items.style.display='block';arrow.classList.remove('collapsed');}else{items.style.display='none';arrow.classList.add('collapsed');}}function toggleDeviceCollapse(event,deviceItem){if(event.target.tagName==='BUTTON'||event.target.tagName==='INPUT'||event.target.tagName==='LABEL'){return;}deviceItem.classList.toggle('collapsed');}function updateDeviceTimer(stepIdx,deviceId,value){const step=editingSteps[stepIdx];if(!step||!step.deviceTimers)return;step.deviceTimers[deviceId]=parseFloat(value)||0;markAsChanged();log(`Updated timer for device in step ${stepIdx+1}`);}function setExecutionMode(stepIdx,mode){const step=editingSteps[stepIdx];if(!step)return;step.executionMode=mode;markAsChanged();renderFlow();log(`Execution mode set to ${mode}for step ${stepIdx+1}`);}let draggedElement=null;let draggedStepIdx=null;let draggedSeqIdx=null;let isDraggingStep=false;document.addEventListener('DOMContentLoaded',()=>{document.body.addEventListener('dragstart',(e)=>{const stepEl=e.target.closest('.device-sequence.draggable-step');if(stepEl){isDraggingStep=true;draggedElement=stepEl;draggedStepIdx=parseInt(stepEl.dataset.stepIdx);stepEl.classList.add('dragging-step');e.dataTransfer.setData('text/plain','step-'+draggedStepIdx);e.dataTransfer.effectAllowed='move';return;}const item=e.target.closest('.device-item');if(item&&item.getAttribute('draggable')==='true'){isDraggingStep=false;draggedElement=item;draggedStepIdx=parseInt(item.dataset.stepIdx);draggedSeqIdx=parseInt(item.dataset.seqIdx);item.classList.add('dragging');e.dataTransfer.setData('text/plain',item.dataset.deviceId);e.dataTransfer.effectAllowed='move';}else if(!item&&!stepEl){e.preventDefault();}});document.body.addEventListener('dragend',(e)=>{document.querySelectorAll('.dragging-step').forEach(el=>el.classList.remove('dragging-step'));document.querySelectorAll('.drag-over-step').forEach(el=>el.classList.remove('drag-over-step'));document.querySelectorAll('.dragging').forEach(el=>el.classList.remove('dragging'));draggedElement=null;draggedStepIdx=null;draggedSeqIdx=null;isDraggingStep=false;});document.body.addEventListener('dragover',(e)=>{e.preventDefault();e.dataTransfer.dropEffect='move';if(isDraggingStep&&draggedElement){const targetStep=e.target.closest('.device-sequence');document.querySelectorAll('.drag-over-step').forEach(el=>el.classList.remove('drag-over-step'));if(targetStep&&targetStep!==draggedElement){targetStep.classList.add('drag-over-step');const rect=targetStep.getBoundingClientRect();const midpoint=rect.top+rect.height/2;if(e.clientY<midpoint){targetStep.parentNode.insertBefore(draggedElement,targetStep);}else{targetStep.parentNode.insertBefore(draggedElement,targetStep.nextSibling);}}return;}const target=e.target.closest('.device-item');if(target&&target!==draggedElement&&draggedElement&&!isDraggingStep){const targetStepIdx=parseInt(target.dataset.stepIdx);if(targetStepIdx===draggedStepIdx){const rect=target.getBoundingClientRect();const midpoint=rect.top+rect.height/2;if(e.clientY<midpoint){target.parentNode.insertBefore(draggedElement,target);}else{target.parentNode.insertBefore(draggedElement,target.nextSibling);}}}});document.body.addEventListener('drop',(e)=>{e.preventDefault();if(isDraggingStep&&draggedElement){const canvas=document.getElementById('flowCanvas');const allSteps=canvas.querySelectorAll('.device-sequence');const newOrder=Array.from(allSteps).map(el=>parseInt(el.dataset.stepIdx));const reorderedSteps=newOrder.map(idx=>editingSteps[idx]);editingSteps.length=0;editingSteps.push(...reorderedSteps);markAsChanged();renderFlow();log('Steps reordered');return;}if(draggedElement&&draggedStepIdx!==null&&!isDraggingStep){const step=editingSteps[draggedStepIdx];if(step&&step.deviceSequence){const items=draggedElement.parentNode.querySelectorAll('.device-item');const newSequence=Array.from(items).map(item=>item.dataset.deviceId);step.deviceSequence=newSequence;markAsChanged();renderFlow();log('Device sequence updated');}}});});function updateTriggerFields(){const type=parseInt(document.getElementById('triggerType').value);document.getElementById('timerFields').classList.toggle('hidden',type!==1);document.getElementById('tempFields').classList.toggle('hidden',type!==2);document.getElementById('weatherFields').classList.toggle('hidden',type!==3);}function renderFlow(){const canvas=document.getElementById('flowCanvas');if(editingSteps.length===0){canvas.innerHTML=`<div class="empty-state" style="padding:30px;text-align:center;"><div style="font-size:2.5rem;margin-bottom:12px;opacity:0.5;">üìã</div><p style="color:var(--text-muted);font-size:0.9rem;margin:0;">No steps yet.<br>Click<strong>"Add Devices"</strong>to start.</p></div>`;return;}canvas.innerHTML=editingSteps.map((step,idx)=>{if(step.type==='wait'){return `<div class="device-sequence wait-type-step draggable-step" draggable="true" data-step-idx="${idx}"><div class="device-sequence-header"><div class="step-header-left"><span class="drag-handle" title="Drag to reorder">‚ò∞</span><div class="step-number">${idx+1}</div><div class="step-info"><div class="step-title">‚è±Ô∏è Wait</div><div class="step-subtitle">${step.waitSeconds}seconds delay</div></div></div><div class="step-actions"><button class="btn-icon" onclick="editWaitStep(${idx})" title="Edit">‚úèÔ∏è</button><button class="btn-icon" onclick="removeStep(${idx})" title="Delete" style="color:var(--danger);">üóëÔ∏è</button></div></div></div>`;}else{const deviceNames=step.devices.map(id=>{const dev=devices.find(d=>d.id===id);return dev ? dev.name:id;});const actionClass=step.action==='ON' ? 'action-on-step':'action-off-step';const actionIcon=step.action==='ON' ? 'üü¢':'üî¥';const actionText=step.action==='ON' ? 'Turn ON':'Turn OFF';if(!step.deviceSequence){step.deviceSequence=[...step.devices];}if(!step.deviceTimers){step.deviceTimers={};step.devices.forEach(id=>{step.deviceTimers[id]=0;});}if(step.executionMode===undefined){step.executionMode='sequential';}const modeSequential=step.executionMode==='sequential';const sequenceHTML=step.deviceSequence.map((devId,seqIdx)=>{const dev=devices.find(d=>d.id===devId);const devName=dev ? dev.name:devId;const devIcon=dev ? getDeviceIcon(dev.type):'üì¶';const timer=step.deviceTimers[devId]||0;const isFirst=seqIdx===0;const isLast=seqIdx===step.deviceSequence.length-1;return `<div class="device-item" draggable="true" data-step-idx="${idx}" data-device-id="${devId}" data-seq-idx="${seqIdx}"><div class="device-item-info"><span class="device-order-num">${seqIdx+1}</span><span>${devIcon}</span><span class="device-name-link" draggable="false" onclick="event.stopPropagation();openDeviceReplacer(${idx},'${devId}')" title="Click to change device">${devName}</span></div><div class="device-controls"><button class="btn-icon" onclick="moveDevice(${idx},${seqIdx},-1)" ${isFirst ? 'disabled style="opacity:0.3"':''}title="Up">‚ñ≤</button><button class="btn-icon" onclick="moveDevice(${idx},${seqIdx},1)" ${isLast ? 'disabled style="opacity:0.3"':''}title="Down">‚ñº</button><input type="number" class="device-timer-input" value="${timer}" min="0" step="0.5" onchange="updateDeviceTimer(${idx},'${devId}',this.value)" placeholder="0"><span class="timer-suffix">s</span></div></div>`;}).join('');return `<div class="device-sequence ${actionClass}draggable-step" draggable="true" data-step-idx="${idx}"><div class="device-sequence-header"><div class="step-header-left"><span class="drag-handle" title="Drag to reorder">‚ò∞</span><div class="step-number">${idx+1}</div><div class="step-info"><div class="step-title">${actionIcon}${actionText}</div><div class="step-subtitle">${deviceNames.length}device${deviceNames.length!==1 ? 's':''}:${deviceNames.slice(0,2).join(',')}${deviceNames.length>2 ? '...':''}</div></div></div><div class="step-actions"><button class="btn-icon" onclick="editDeviceStep(${idx})" title="Edit">‚úèÔ∏è</button><button class="btn-icon" onclick="removeStep(${idx})" title="Delete" style="color:var(--danger);">üóëÔ∏è</button></div></div><div class="execution-mode"><span class="execution-mode-label">‚öôÔ∏è Mode:</span><div class="mode-toggle"><label><input type="radio" name="mode-${idx}" ${modeSequential ? 'checked':''}onchange="setExecutionMode(${idx},'sequential')">Sequential</label><label><input type="radio" name="mode-${idx}" ${!modeSequential ? 'checked':''}onchange="setExecutionMode(${idx},'simultaneous')">All at once</label></div></div><div class="step-devices-list" style="display:${modeSequential ? 'block':'none'};">${sequenceHTML}</div></div>`;}}).join('');}let editingStepIndex=-1;function addDeviceStep(){editingStepIndex=-1;renderDevicePicker([]);document.getElementById('deviceActionToggle').checked=true;document.getElementById('deviceStepModal').classList.add('active');}function editDeviceStep(idx){editingStepIndex=idx;const step=editingSteps[idx];renderDevicePicker(step.devices);document.getElementById('deviceActionToggle').checked=(step.action==='ON');document.getElementById('deviceStepModal').classList.add('active');}let replacingStepIdx=-1;let replacingDeviceId='';function openDeviceReplacer(stepIdx,deviceId){replacingStepIdx=stepIdx;replacingDeviceId=deviceId;const step=editingSteps[stepIdx];const currentDev=devices.find(d=>d.id===deviceId);const currentName=currentDev ? currentDev.name:deviceId;const otherDevicesInStep=step.devices.filter(id=>id!==deviceId);const availableDevices=devices.filter(d=>!otherDevicesInStep.includes(d.id));const sortedDevices=availableDevices.slice().sort((a,b)=>a.name.localeCompare(b.name));const pickerHTML=sortedDevices.map(d=>`<div class="device-replace-option ${d.id===deviceId ? 'current':''}" onclick="confirmDeviceReplacement('${d.id}')"><span>${getDeviceIcon(d.type)}</span><span>${d.name}</span>${d.id===deviceId ? '<span style="color:var(--success);font-size:0.7rem;margin-left:auto;">(current)</span>':''}</div>`).join('');document.getElementById('deviceReplacerTitle').textContent=`Replace:${currentName}`;document.getElementById('deviceReplacerList').innerHTML=pickerHTML;document.getElementById('deviceReplacerModal').classList.add('active');}function closeDeviceReplacer(){document.getElementById('deviceReplacerModal').classList.remove('active');replacingStepIdx=-1;replacingDeviceId='';}function confirmDeviceReplacement(newDeviceId){if(replacingStepIdx<0||!replacingDeviceId)return;if(newDeviceId===replacingDeviceId){closeDeviceReplacer();return;}const step=editingSteps[replacingStepIdx];const deviceIdx=step.devices.indexOf(replacingDeviceId);if(deviceIdx>=0)step.devices[deviceIdx]=newDeviceId;const seqIdx=step.deviceSequence.indexOf(replacingDeviceId);if(seqIdx>=0)step.deviceSequence[seqIdx]=newDeviceId;const oldTimer=step.deviceTimers[replacingDeviceId]||0;delete step.deviceTimers[replacingDeviceId];step.deviceTimers[newDeviceId]=oldTimer;markAsChanged();renderFlow();closeDeviceReplacer();}function renderDevicePicker(preselectedDevices=[]){const picker=document.getElementById('devicePicker');const checkedDevices=new Set(preselectedDevices);const sortedDevices=devices.slice().sort((a,b)=>{return deviceSortAscending ? a.name.localeCompare(b.name):b.name.localeCompare(a.name);});picker.innerHTML=sortedDevices.map(d=>`<label class="device-checkbox"><input type="checkbox" value="${d.id}" ${checkedDevices.has(d.id)? 'checked':''}><span>${d.name}</span></label>`).join('');}function toggleDeviceSort(){deviceSortAscending=!deviceSortAscending;renderDevicePicker();}function closeDeviceStep(){document.getElementById('deviceStepModal').classList.remove('active');}function confirmDeviceStep(){const actionToggle=document.getElementById('deviceActionToggle');const action=actionToggle.checked ? 'ON':'OFF';const checkboxes=document.querySelectorAll('#devicePicker input:checked');const selectedDevices=Array.from(checkboxes).map(cb=>cb.value);if(selectedDevices.length===0){customAlert('Please select at least one device','‚ö†Ô∏è No Devices Selected');return;}if(editingStepIndex>=0){const step=editingSteps[editingStepIndex];step.action=action;step.devices=selectedDevices;step.deviceSequence=[...selectedDevices];const newTimers={};selectedDevices.forEach(id=>{newTimers[id]=step.deviceTimers[id]||0;});step.deviceTimers=newTimers;}else{editingSteps.push({type:'device',action:action,devices:selectedDevices,executionMode:'sequential'});}markAsChanged();renderFlow();closeDeviceStep();}async function addWaitStep(){const seconds=await customPrompt('Wait duration(seconds):','5','‚è±Ô∏è Add Wait Step');if(!seconds||isNaN(seconds)||seconds<=0)return;editingSteps.push({type:'wait',waitSeconds:parseInt(seconds)});markAsChanged();renderFlow();}async function editWaitStep(idx){const step=editingSteps[idx];const seconds=await customPrompt('Wait duration(seconds):',step.waitSeconds.toString(),'‚è±Ô∏è Edit Wait Step');if(!seconds||isNaN(seconds)||seconds<=0)return;editingSteps[idx].waitSeconds=parseInt(seconds);markAsChanged();renderFlow();}async function removeStep(idx){const confirmed=await customConfirm('Delete this step?','üóëÔ∏è Delete Step');if(!confirmed)return;editingSteps.splice(idx,1);markAsChanged();renderFlow();}async function clearSteps(){const confirmed=await customConfirm('Clear all steps?','üóëÔ∏è Clear All Steps');if(!confirmed)return;editingSteps=[];markAsChanged();renderFlow();}function addWaitStep(){const seconds=prompt('Wait duration(seconds):','5');if(!seconds||isNaN(seconds)||seconds<=0)return;editingSteps.push({type:'wait',waitSeconds:parseInt(seconds)});renderFlow();}function editWaitStep(idx){const step=editingSteps[idx];const seconds=prompt('Wait duration(seconds):',step.waitSeconds);if(!seconds||isNaN(seconds)||seconds<=0)return;editingSteps[idx].waitSeconds=parseInt(seconds);renderFlow();}function removeStep(idx){if(!confirm('Delete this step?'))return;editingSteps.splice(idx,1);renderFlow();}function clearSteps(){if(!confirm('Clear all steps?'))return;editingSteps=[];renderFlow();}async function saveRoutine(){const name=document.getElementById('routineName').value.trim();const type=parseInt(document.getElementById('triggerType').value);if(!name){await customAlert('Please enter a routine name','‚ö†Ô∏è Name Required');return;}const updateData={type:'update_routine',id:currentRoutine ? currentRoutine.id:'',name:name,trigger_type:type,schedule:'',temp_min:0.0,temp_max:0.0,timer_seconds:0};if(type===1){updateData.timer_seconds=parseInt(document.getElementById('timerInterval').value);const dateInput=document.getElementById('scheduleDate').value;const timeInput=document.getElementById('scheduleTime').value;if(dateInput&&timeInput){const date=new Date(dateInput+'T'+timeInput);const minute=date.getMinutes();const hour=date.getHours();const dayOfMonth=date.getDate();const month=date.getMonth()+1;updateData.schedule=`${minute}${hour}${dayOfMonth}${month}*`;}else{updateData.schedule='';}}else if(type===2){updateData.temp_min=parseFloat(document.getElementById('tempMin').value);updateData.temp_max=parseFloat(document.getElementById('tempMax').value);updateData.auto_reverse=document.getElementById('autoReverse').checked;updateData.hysteresis=parseFloat(document.getElementById('hysteresis').value)||2.0;updateData.max_run_seconds=parseInt(document.getElementById('maxRunSeconds').value)||0;}else if(type===3){updateData.temp_min=parseFloat(document.getElementById('weatherMin').value);updateData.temp_max=parseFloat(document.getElementById('weatherMax').value);}if(!currentRoutine){sendWS({type:'create_routine',name:name,trigger_type:type});await new Promise(resolve=>setTimeout(resolve,300));sendWS({type:'sync_routines'});await new Promise(resolve=>setTimeout(resolve,300));const newRoutine=routines.find(r=>r.name===name&&r.steps.length===0);if(newRoutine){updateData.id=newRoutine.id;}}sendWS(updateData);await new Promise(resolve=>setTimeout(resolve,200));sendWS({type:'clear_routine_steps',id:updateData.id});await new Promise(resolve=>setTimeout(resolve,200));for(const step of editingSteps){if(step.type==='wait'){sendWS({type:'add_routine_step',id:updateData.id,step_type:'wait',action:2,wait_seconds:step.waitSeconds,device_ids:[]});}else{const stepMsg={type:'add_routine_step',id:updateData.id,step_type:'device',action:step.action==='ON' ? 0:1,wait_seconds:0,device_ids:step.devices};if(step.deviceSequence&&step.deviceSequence.length>0){stepMsg.device_sequence=step.deviceSequence;}if(step.deviceTimers&&Object.keys(step.deviceTimers).length>0){stepMsg.device_timers=step.deviceTimers;}if(step.executionMode){stepMsg.execution_mode=step.executionMode;}sendWS(stepMsg);}await new Promise(resolve=>setTimeout(resolve,100));}setTimeout(()=>{sendWS({type:'sync_routines'});markAsSaved();document.getElementById('editorModal').classList.remove('active');currentRoutine=null;editingSteps=[];},500);}async function executeRoutine(id){const routine=routines.find(r=>r.id===id);if(!routine)return;if(!routine.enabled&&routine.type!==0){await customAlert('This routine is disabled. Enable it first to execute.','‚ö†Ô∏è Routine Disabled');return;}if(routine.type===0){const result=await showManualRoutineDialog(routine.name);if(result){sendWS({type:'execute_routine',id:id,manual_action:result.action});}}else{const confirmed=await customConfirm('Execute this routine now?','‚ñ∂Ô∏è Execute Routine');if(!confirmed)return;sendWS({type:'execute_routine',id:id});}}function showManualRoutineDialog(routineName){return new Promise((resolve)=>{currentDialogResolver=resolve;isManualRoutineDialog=true;const dialog=document.getElementById('customDialog');const dialogTitle=document.getElementById('dialogTitle');const dialogMessage=document.getElementById('dialogMessage');const dialogFooter=document.getElementById('dialogFooter');const dialogInput=document.getElementById('dialogInput');dialogTitle.textContent='‚ñ∂Ô∏è Execute Routine';dialogInput.style.display='none';dialogMessage.innerHTML=`<p style="margin-bottom:20px;">Execute "${routineName}" with the following action:</p><div style="display:flex;align-items:center;gap:16px;background:var(--surface-elevated);padding:16px;border-radius:10px;justify-content:center;"><span style="font-weight:500;color:var(--danger);">Turn OFF</span><label class="toggle-switch" style="margin:0;"><input type="checkbox" id="manualActionToggle" checked><span class="slider"></span></label><span style="font-weight:500;color:var(--success);">Turn ON</span></div>`;dialogFooter.innerHTML=`<button class="btn btn-secondary" data-action="cancel">Cancel</button><button class="btn btn-primary" data-action="execute">‚ñ∂Ô∏è Execute</button>`;dialogFooter.querySelectorAll('button').forEach(btn=>{btn.onclick=()=>{const action=btn.dataset.action;dialog.classList.remove('active');const resolver=currentDialogResolver;currentDialogResolver=null;isManualRoutineDialog=false;if(action==='execute'){const toggleInput=document.getElementById('manualActionToggle');resolver({action:toggleInput.checked ? 'ON':'OFF'});}else{resolver(null);}};});dialog.classList.add('active');});}async function stopRoutine(id){const confirmed=await customConfirm('Stop this routine?','‚èπÔ∏è Stop Routine');if(!confirmed)return;sendWS({type:'stop_routine',id:id});setTimeout(()=>sendWS({type:'sync_routines'}),500);}function updateRoutineProgress(id,step,total,status){const routine=routines.find(r=>r.id===id);if(routine){routine.currentStep=step;routine.status=status;const card=document.getElementById(`routine-${id}`);if(card){const r=routine;const statusLabels=['Idle','Running','Paused','Completed','Stopped','Error'];const statusColors=['#94a3b8','#ffa726','#4f7cff','#00d9a5','#ff4757','#ff4757'];const statusText=statusLabels[status]||'Running';const statusColor=statusColors[status]||'#ffa726';const progress=total>0 ? Math.round((step/total)*100):0;const infoDiv=card.querySelector('.routine-info');let progressDiv=infoDiv.querySelector('.progress-container');if(!progressDiv&&status===1){progressDiv=document.createElement('div');progressDiv.className='progress-container';infoDiv.appendChild(progressDiv);}if(progressDiv){if(status===1){progressDiv.innerHTML=`<div style="margin-top:8px;"><div style="background:rgba(255,255,255,0.1);border-radius:8px;height:6px;overflow:hidden;"><div style="background:${statusColor};width:${progress}%;height:100%;transition:width 0.3s;"></div></div><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Step ${step+1}/${total}</div></div>`;}else{progressDiv.remove();}}const h3=card.querySelector('h3');const statusSpan=h3.querySelector('span');if(status===1||status===2){if(statusSpan){statusSpan.textContent=`‚óè ${statusText}`;statusSpan.style.color=statusColor;}else{h3.innerHTML+=`<span style="color:${statusColor};font-size:0.75rem;font-weight:400;">‚óè ${statusText}</span>`;}}else if(statusSpan){statusSpan.remove();}}}if(status===3||status===4){setTimeout(()=>sendWS({type:'sync_routines'}),1000);}}function toggleRoutine(id,enabled){const routine=routines.find(r=>r.id===id);if(routine){routine.enabled=enabled;renderRoutines();}sendWS({type:'set_routine_enabled',id:id,enabled:enabled});}async function deleteRoutine(id){const confirmed=await customConfirm('Delete this routine? This action cannot be undone.','üóëÔ∏è Delete Routine');if(!confirmed)return;sendWS({type:'delete_routine',id:id});setTimeout(()=>sendWS({type:'sync_routines'}),300);}connectWebSocket();</script></main></body></html>